<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Recetario Español con 160 recetas. Búsqueda rápida, voz manos libres, cocina guiada, alto contraste, letra grande y lista de la compra." />
  <title>Recetario Español – 160 recetas</title>

  <!-- theme-color -->
  <meta name="theme-color" content="#78350f" />
  <meta name="theme-color" content="#78350f" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b0f19" media="(prefers-color-scheme: dark)">

  <!-- Manifest se inyecta vía Blob en runtime (no necesitas manifest.json) -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Estilos internos (no necesitas styles.css) -->
  <style>
    :root{ --base-font:16px; }
    html{ font-size: var(--base-font); }
    body{ -webkit-tap-highlight-color: transparent; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Color Emoji", "Apple Color Emoji", sans-serif; }
    .container{max-width:80rem;margin:0 auto;padding:1rem 1rem 2rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:1rem;padding:.6rem 1rem;font-weight:600;cursor:pointer}
    .btn-primary{background:#92400e;color:#fff}.btn-primary:active{transform:scale(.98)}
    .btn-ghost{background:transparent}.btn-ghost:active{transform:scale(.98)}
    .tab{padding:.5rem .75rem;border-radius:.75rem;font-size:.9rem;font-weight:700;border:none;cursor:pointer}
    .tab[aria-selected="true"]{background:#92400e;color:#fff}
    .card{border-radius:1rem;border:1px solid rgba(120,113,108,.25);overflow:hidden;background:#fff}
    .dark .card{background:#1f2937;border-color:#374151}
    .hc *{ color:#000 !important; background:#fff !important; }
    .hc .tab[aria-selected="true"]{ background:#000 !important; color:#fff !important; }
    .drawer{position:fixed;top:env(safe-area-inset-top,0);right:0;bottom:0;width:380px;max-width:100%;background:#fff;color:#111;box-shadow:-4px 0 20px rgba(0,0,0,.2);transform:translateX(100%);transition:.25s;z-index:60}
    .dark .drawer{background:#111827;color:#e5e7eb}
    .drawer.open{transform:translateX(0)}
    .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip-link:focus{left:1rem;top:1rem;width:auto;height:auto;padding:.5rem .75rem;background:#fff;color:#111;border-radius:.5rem;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    #ttsCaption{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom,0);margin:0 auto;max-width:700px;background:rgba(17,24,39,.92);color:#fff;border-radius:12px 12px 0 0;padding:.6rem .8rem;font-size:.95rem;line-height:1.35;z-index:70;display:none}
    #ttsCaption.show{display:block}
    @media print{header,.no-print,#shoppingDrawer,#ttsCaption{display:none!important}}
    *:focus { outline: 3px solid #4f46e5; outline-offset: 2px; }
    /* Scrollbars */
    *::-webkit-scrollbar{ width:12px; height:12px }
    *::-webkit-scrollbar-thumb{ background-color: rgba(120,113,108,.5); border-radius: 8px }
    *::-webkit-scrollbar-track{ background: transparent }
    /* Grid utilitario (sin Tailwind) */
    .grid{display:grid;gap:1rem}
    .grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .md-grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 768px){ .md-grid-cols-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
    /* HUD del asistente de voz */
    #voiceHUD{display:flex;align-items:center;gap:.5rem;margin-top:.25rem;font-size:.85rem;color:#6b7280}
    #voiceDot{width:10px;height:10px;border-radius:9999px;background:#9ca3af;box-shadow:0 0 0 0 rgba(16,185,129,.0);transition:.12s}
    #voiceWave{position:relative;display:block;width:140px;height:10px;border-radius:9999px;background:rgba(120,113,108,.25);overflow:hidden}
    #voiceWave > i{position:absolute;left:0;top:0;bottom:0;width:0;background:#10b981;transition:width .08s ease}
    .talking #voiceDot{background:#10b981;box-shadow:0 0 12px 3px rgba(16,185,129,.45)}
    .listening #voiceDot{background:#f59e0b}
    .disabled #voiceDot{background:#9ca3af}
    .dark{background:#0b0f19;color:#e5e7eb}
    .text-muted{color:#6b7280}
    .badge{display:inline-block;font-size:.75rem;padding:.15rem .5rem;border-radius:.5rem;background:#f3f4f6;color:#111}
    .dark .badge{background:#1f2937;color:#e5e7eb}
  </style>
</head>
<body class="dark">
  <a href="#main" class="skip-link">Saltar al contenido principal</a>

  <noscript>
    <div style="padding:1rem;margin:1rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff;color:#111">
      Esta aplicación necesita JavaScript para funcionar (búsqueda, voz, cocina guiada y lista de la compra).
    </div>
  </noscript>

  <div class="container" id="app">
    <header class="flex items-center justify-between gap-3 mb-4" style="display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:1rem">
      <div>
        <h1 style="font-size:clamp(1.5rem,2.5vw,2rem);font-weight:800;margin:.25rem 0">Recetario Español – 160 recetas</h1>
        <p class="text-muted" style="font-size:.9rem">Voz manos libres · Contraste · Letra grande · Lista de la compra.</p>
      </div>
      <div style="display:flex;gap:.35rem;flex-wrap:wrap">
        <button id="toggleTheme" class="btn btn-ghost" title="Cambiar tema" aria-label="Cambiar tema">🌙/☀️</button>
        <button id="toggleContrast" class="btn btn-ghost" title="Alto contraste" aria-label="Alto contraste">🌓</button>
        <button id="fontMinus" class="btn btn-ghost" title="Reducir letra" aria-label="Reducir letra">A−</button>
        <button id="fontPlus" class="btn btn-ghost" title="Aumentar letra" aria-label="Aumentar letra">A+</button>
        <button id="openShopping" class="btn btn-ghost" title="Abrir lista de la compra" aria-label="Lista de la compra">🧺</button>
      </div>
    </header>

    <section class="card" style="padding:1rem;margin-bottom:1rem" aria-label="Búsqueda y filtros">
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="display:flex;gap:.75rem;align-items:flex-end;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label for="search" style="display:block;font-size:.9rem;font-weight:600;margin-bottom:.25rem">Buscar</label>
            <input id="search" type="search" inputmode="search" placeholder="Nombre, ingrediente… (Ctrl+/)"
                  style="width:100%;border-radius:12px;border:1px solid #d6d3d1;background:#fff;color:#111;padding:.55rem .75rem" />
          </div>
          <!-- Tabs accesibles -->
          <div style="display:flex;gap:.35rem;flex-wrap:wrap" role="tablist" aria-label="Categorías">
            <button class="tab" role="tab" id="tab-todas" aria-selected="true" data-cat="Todas" title="Mostrar todas">Todas</button>
            <button class="tab" role="tab" id="tab-aperitivo" aria-selected="false" data-cat="Aperitivo" title="Mostrar aperitivos">Aperitivos</button>
            <button class="tab" role="tab" id="tab-primero" aria-selected="false" data-cat="Primero" title="Mostrar primeros">Primeros</button>
            <button class="tab" role="tab" id="tab-segundo" aria-selected="false" data-cat="Segundo" title="Mostrar segundos">Segundos</button>
            <button class="tab" role="tab" id="tab-postre" aria-selected="false" data-cat="Postre" title="Mostrar postres">Postres</button>
            <!-- Favoritas se añade por JS -->
          </div>
          <div style="display:flex;gap:.5rem;align-items:end;flex-wrap:wrap">
            <label for="voiceRate" style="font-size:.9rem">Voz:</label>
            <select id="voiceRate" class="badge" aria-label="Velocidad de lectura en voz alta">
              <option value="0.8">Lenta</option>
              <option value="0.9" selected>Clara</option>
              <option value="1.0">Normal</option>
            </select>
            <label for="autoListen" class="text-sm" style="font-size:.9rem;user-select:none" title="Escuchar sin pulsar">
              <input id="autoListen" type="checkbox" class="align-middle" checked> Auto
            </label>
            <button id="toggleMic" class="btn btn-primary" title="Reconectar reconocimiento de voz" aria-label="Reconectar reconocimiento de voz">🎤 Reconectar voz</button>
          </div>
        </div>
        <div id="readerStatus" class="text-muted" style="font-size:.8rem" aria-live="polite"></div>
        <div id="heard" class="text-muted" style="font-size:.8rem">🎧 Oído: <span id="heardText">—</span></div>
        <!-- HUD voz se inyecta aquí por JS -->
      </div>
    </section>

    <section class="text-muted" style="margin:.5rem 0;font-size:.9rem">
      <span id="countLabel">Mostrando 0 recetas.</span>
    </section>

    <main id="main" aria-labelledby="countLabel">
      <div id="recipesGrid" class="grid grid-cols-2 md-grid-cols-3" role="region" aria-label="Listado de recetas"></div>
      <div id="emptyState" class="text-muted" style="text-align:center;margin-top:2rem;display:none">No hay resultados.</div>
    </main>

    <!-- Modal Detalle -->
    <div id="detailModal" class="no-print" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:1rem" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="card" style="max-width:56rem;width:100%">
        <div style="padding:.75rem;border-bottom:1px solid rgba(120,113,108,.25);display:flex;align-items:center;justify-content:space-between">
          <h3 id="detailTitle" style="font-size:1.25rem;font-weight:700;margin:0">Detalle</h3>
          <button id="closeDetail" class="btn btn-ghost" aria-label="Cerrar detalle" title="Cerrar">✕</button>
        </div>
        <div style="padding:1rem;display:grid;gap:1rem;grid-template-columns:repeat(2,minmax(0,1fr))">
          <div>
            <img id="detailImg" src="" alt="" class="w-full h-48 object-cover" loading="lazy" width="800" height="500" style="width:100%;height:12rem;object-fit:cover;border-radius:10px">
            <p id="detailMeta" class="text-muted" style="margin-top:.5rem;font-size:.9rem"></p>
            <div class="mt-3" style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem">
              <button id="btnReadAll" class="btn btn-ghost" aria-label="Leer receta en voz alta" title="Leer receta">🔈 Leer</button>
              <button id="btnGuided" class="btn btn-primary" aria-label="Iniciar cocina guiada" title="Cocina guiada">▶️ Guiada</button>
              <button id="btnAddAll" class="btn btn-ghost" aria-label="Añadir todos los ingredientes a la lista" title="Añadir ingredientes">🧺 Añadir todo</button>
              <!-- Compartir por JS -->
            </div>
          </div>
          <div>
            <h4 style="font-size:1.1rem;font-weight:700;margin:.25rem 0">Ingredientes</h4>
            <ul id="detailIngredients" style="margin:.5rem 0 .25rem 1.25rem"></ul>
            <h4 style="font-size:1.1rem;font-weight:700;margin:.75rem 0 .25rem">Pasos</h4>
            <ol id="detailSteps" style="margin:.5rem 0 .25rem 1.25rem"></ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Guiada -->
    <div id="guidedModal" class="no-print" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:1rem" role="dialog" aria-modal="true" aria-labelledby="guidedTitle">
      <div class="card" style="max-width:48rem;width:100%">
        <div style="padding:.75rem;border-bottom:1px solid rgba(120,113,108,.25);display:flex;align-items:center;justify-content:space-between">
          <h3 id="guidedTitle" style="font-size:1.25rem;font-weight:700;margin:0">Cocina guiada</h3>
          <button id="closeGuided" class="btn btn-ghost" aria-label="Cerrar cocina guiada" title="Cerrar">✕</button>
        </div>
        <div style="padding:1rem;display:flex;flex-direction:column;gap:1rem">
          <p class="text-muted" style="font-size:.9rem">
            <strong>Voz manos libres activa.</strong> Di: “siguiente”, “anterior”, “repetir”, “leer ingredientes”, “paso 2”, “salir”.
          </p>
          <div style="background:#f6f6f6;border-radius:12px;padding:1rem" class="dark" id="guidedBox">
            <h4 id="guidedRecipeTitle" style="font-size:1.1rem;font-weight:700;margin:.25rem 0"></h4>
            <ol id="guidedSteps" style="margin:.5rem 0 .25rem 1.25rem;display:grid;gap:.35rem"></ol>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
            <div class="text-muted" id="guidedProgress" style="font-size:.8rem" aria-live="polite"></div>
            <div style="display:flex;gap:.35rem;flex-wrap:wrap">
              <button id="prevStep" class="btn btn-ghost" aria-label="Paso anterior" title="Anterior">← Anterior</button>
              <button id="repeatStep" class="btn btn-ghost" aria-label="Repetir paso" title="Repetir">⟲ Repetir</button>
              <button id="nextStep" class="btn btn-primary" aria-label="Paso siguiente" title="Siguiente">Siguiente →</button>
              <button id="stopReading" class="btn btn-ghost" aria-label="Parar lectura" title="Parar">■ Parar</button>
              <button id="printRecipe" class="btn btn-ghost" aria-label="Imprimir receta" title="Imprimir">🖨️ Imprimir</button>
            </div>
          </div>
          <!-- Temporizador se inyecta aquí -->
        </div>
      </div>
    </div>

    <!-- Drawer Lista compra -->
    <aside id="shoppingDrawer" class="drawer" aria-label="Lista de la compra" aria-hidden="true">
      <div style="padding:.75rem;border-bottom:1px solid rgba(120,113,108,.25);display:flex;align-items:center;justify-content:space-between">
        <h3 style="font-size:1.1rem;font-weight:700;margin:0">Lista de la compra</h3>
        <div style="display:flex;gap:.35rem">
          <button id="exportList" class="btn btn-ghost" aria-label="Exportar lista" title="Exportar lista">⬇️ Exportar</button>
          <button id="printList" class="btn btn-ghost" aria-label="Imprimir lista" title="Imprimir lista">🖨️</button>
          <button id="clearChecked" class="btn btn-ghost" aria-label="Borrar elementos marcados" title="Borrar marcados">🗑️ Marcados</button>
          <button id="closeShopping" class="btn btn-ghost" aria-label="Cerrar lista" title="Cerrar">✕</button>
        </div>
      </div>
      <div style="padding:1rem">
        <div style="display:flex;gap:.5rem;margin-bottom:.75rem">
          <label for="newItem" class="sr-only">Nuevo artículo</label>
          <input id="newItem" style="flex:1;border-radius:12px;border:1px solid #d6d3d1;background:#fff;color:#111;padding:.55rem .75rem" placeholder="Añadir artículo (ej. 1 kg tomates)" />
          <button id="addItem" class="btn btn-primary" aria-label="Añadir artículo" title="Añadir artículo">Añadir</button>
        </div>
        <ul id="shoppingList" style="display:grid;gap:.5rem;padding:0;list-style:none;margin:0"></ul>
        <p id="shoppingEmpty" class="text-muted" style="margin-top:.75rem;display:none">Tu lista está vacía.</p>
      </div>
    </aside>
  </div>

  <!-- Subtítulos de voz -->
  <div id="ttsCaption" role="status" aria-live="polite"></div>

  <script>
  const APP_VERSION = "recetario-1.8.0";

  /* ========= Manifest por Blob (sin manifest.json) ========= */
  (function injectManifest(){
    const manifest = {
      name: "Recetario Español",
      short_name: "Recetario",
      start_url: ".",
      display: "standalone",
      background_color: "#0b0f19",
      theme_color: "#78350f",
      icons: [
        { src: "data:image/svg+xml;utf8," + encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%2378350f'/><text x='50' y='58' font-size='54' fill='white' text-anchor='middle' font-family='system-ui'>🍳</text></svg>"), sizes: "192x192", type: "image/svg+xml", purpose: "any" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = url;
    document.head.appendChild(link);
  })();

  /* ===== Fotos (Wikimedia) + placeholders sin CORS ===== */
  const PLACE = {
    Aperitivo: "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'><rect width='800' height='500' fill='#fef3c7'/><text x='50%' y='52%' text-anchor='middle' fill='#92400e' font-size='28' font-family='system-ui'>Aperitivo</text></svg>`),
    Primero:   "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'><rect width='800' height='500' fill='#e0f2fe'/><text x='50%' y='52%' text-anchor='middle' fill='#0ea5e9' font-size='28' font-family='system-ui'>Primero</text></svg>`),
    Segundo:   "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'><rect width='800' height='500' fill='#e2e8f0'/><text x='50%' y='52%' text-anchor='middle' fill='#334155' font-size='28' font-family='system-ui'>Segundo</text></svg>`),
    Postre:    "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'><rect width='800' height='500' fill='#fae8ff'/><text x='50%' y='52%' text-anchor='middle' fill='#a21caf' font-size='28' font-family='system-ui'>Postre</text></svg>`)
  };
  const IMG_MAP = new Map([
    // Aperitivos
    ["tostas de tomate y jamón","https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Pa_amb_tomaquet.jpg/800px-Pa_amb_tomaquet.jpg"],
    ["croquetas de jamón","https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/Croquetas_de_jam%C3%B3n.jpg/800px-Croquetas_de_jam%C3%B3n.jpg"],
    ["patatas bravas","https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Patatas_bravas_%28Madrid%29.jpg/800px-Patatas_bravas_%28Madrid%29.jpg"],
    ["calamares a la romana","https://upload.wikimedia.org/wikipedia/commons/thumb/6/62/Calamares_a_la_romana.jpg/800px-Calamares_a_la_romana.jpg"],
    ["boquerones en vinagre","https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Boquerones_en_vinagre.jpg/800px-Boquerones_en_vinagre.jpg"],
    ["gildas donostiarras","https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/Gilda.jpg/800px-Gilda.jpg"],
    // Primeros
    ["gazpacho andaluz","https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Gazpacho_con_guarnici%C3%B3n.jpg/800px-Gazpacho_con_guarnici%C3%B3n.jpg"],
    ["salmorejo cordobés","https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/Salmorejo_cordob%C3%A9s.jpg/800px-Salmorejo_cordob%C3%A9s.jpg"],
    ["fideuá de pescado","https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Fideu%C3%A0_de_gandia.jpg/800px-Fideu%C3%A0_de_gandia.jpg"],
    ["paella de verduras","https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Paella_de_verduras.jpg/800px-Paella_de_verduras.jpg"],
    ["caldo gallego","https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Caldo_galego.jpg/800px-Caldo_galego.jpg"],
    // Segundos
    ["merluza en salsa verde","https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Merluza_en_salsa_verde.jpg/800px-Merluza_en_salsa_verde.jpg"],
    ["rabo de toro","https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Rabo_de_toro.jpg/800px-Rabo_de_toro.jpg"],
    ["fabada asturiana","https://upload.wikimedia.org/wikipedia/commons/thumb/6/62/Fabada_asturiana_2.jpg/800px-Fabada_asturiana_2.jpg"],
    ["marmitako de bonito","https://upload.wikimedia.org/wikipedia/commons/thumb/8/8b/Marmitako_001.jpg/800px-Marmitako_001.jpg"],
    ["pulpo a la gallega","https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Pulpo_a_la_gallega.jpg/800px-Pulpo_a_la_gallega.jpg"],
    ["tortilla de patatas","https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Tortilla_de_patatas_%28Spanish_omelette%29.jpg/800px-Tortilla_de_patatas_%28Spanish_omelette%29.jpg"],
    ["paella mixta","https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/01_Paella_mixta.jpg/800px-01_Paella_mixta.jpg"],
    // Postres
    ["tarta de queso al horno","https://upload.wikimedia.org/wikipedia/commons/thumb/d/d8/2020_Basque_Burnt_Cheesecake.jpg/800px-2020_Basque_Burnt_Cheesecake.jpg"],
    ["flan casero","https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Flan_caramelo.jpg/800px-Flan_caramelo.jpg"],
    ["arroz con leche","https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Arroz_con_leche.jpg/800px-Arroz_con_leche.jpg"],
    ["tarta de santiago","https://upload.wikimedia.org/wikipedia/commons/thumb/0/0a/Tarta_de_Santiago.jpg/800px-Tarta_de_Santiago.jpg"],
    ["crema catalana","https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Crema_catalana.jpg/800px-Crema_catalana.jpg"],
  ]);
  function IMG_URL(titulo, categoria){
    const key = (titulo||"").toLowerCase();
    return IMG_MAP.get(key) || PLACE[categoria] || PLACE.Primero;
  }

  /* ===== Datos (las 160 recetas) ===== */
  const APERITIVOS = [
    "Tostas de tomate y jamón","Tostas de anchoa y pimiento","Tostas de escalivada","Tostas de salmón y queso fresco",
    "Croquetas de jamón","Croquetas de pollo","Croquetas de bacalao","Croquetas de setas",
    "Empanadillas de atún","Empanadillas de carne","Patatas bravas","Patatas alioli",
    "Boquerones en vinagre","Champiñones al ajillo","Gildas donostiarras","Pinchos de tortilla",
    "Pinchos morunos","Queso marinado en aceite","Hummus clásico con crudités","Hummus de remolacha",
    "Hummus de aguacate","Gazpacho en vasitos","Salmorejo en chupitos","Ensaladilla rusa",
    "Tortilla francesa mini","Banderillas variadas","Mejillones en escabeche","Sardinas marinadas",
    "Pulpo a la gallega (tapa)","Calamares a la romana","Torreznos crujientes","Jamón con picos",
    "Queso manchego con membrillo","Pimientos del padrón","Montadito de lomo","Montadito de pringá",
    "Bonito con tomate (tapa)","Pisto con huevo (tapa)","Chistorra a la sidra","Berenjena frita con miel"
  ];
  const PRIMEROS = [
    "Sopa de ajo","Sopa castellana","Gazpacho andaluz","Salmorejo cordobés","Ajoblanco","Crema de calabaza",
    "Crema de puerros","Crema de champiñón","Pisto manchego","Menestra de verduras","Lentejas estofadas",
    "Garbanzos con espinacas","Judías blancas con verduras","Arroz caldoso de verduras","Arroz a la cubana",
    "Arroz negro","Arroz al horno","Paella de verduras","Fideuá de pescado","Macarrones con tomate",
    "Tallarines al ajillo","Espaguetis carbonara ligera","Ensalada mixta","Ensalada campera","Ensalada de garbanzos",
    "Ensalada de pasta fría","Tomates aliñados","Papas arrugadas con mojo","Pimientos asados","Alcachofas salteadas",
    "Acelgas rehogadas","Sopa de pescado","Caldo gallego","Cocido andaluz (sopa)","Sopa minestrone","Vichyssoise",
    "Crema de zanahoria","Porrusalda","Sopa de marisco","Caldo de pollo casero"
  ];
  const SEGUNDOS = [
    "Pollo al ajillo","Pollo al horno con patatas","Pollo en pepitoria","Pechuga de pollo a la plancha",
    "Escalope de ternera","Filete de ternera a la plancha","Carrilleras al vino tinto","Rabo de toro",
    "Albóndigas en salsa","Lomo adobado","Costillas al horno","Chuletillas de cordero","Cordero asado",
    "Secreto ibérico a la plancha","Solomillo al roquefort","Bacalao a la vizcaína","Bacalao al pil-pil",
    "Merluza en salsa verde","Dorada al horno","Lubina a la sal","Salmón al papillote","Atún encebollado",
    "Calamares en su tinta","Pulpo a la gallega","Paella mixta","Arroz con pollo","Arroz con bogavante",
    "Empanada gallega de atún","Pisto con huevos","Tortilla de patatas","Revuelto de setas","Conejo al ajillo",
    "Codornices escabechadas","Callos a la madrileña","Fabada asturiana","Marmitako de bonito",
    "Chuletón a la plancha","Escabeche de caballa","Bonito con tomate","Trucha a la navarra"
  ];
  const POSTRES = [
    "Flan casero","Natillas caseras","Arroz con leche","Leche frita","Torrijas","Crema catalana",
    "Tarta de queso al horno","Tarta de Santiago","Bizcocho de yogur","Bizcocho de naranja","Magdalenas caseras",
    "Galletas de mantequilla","Rosquillas fritas","Pestiños","Buñuelos de viento","Filloas","Peras al vino",
    "Compota de manzana","Macedonia de frutas","Helado rápido de plátano","Mousse de chocolate","Natillas de vainilla",
    "Tarta de manzana","Tarta tres leches (versión)","Brazo de gitano","Quesada pasiega","Tocino de cielo",
    "Pan de Calatrava","Cuajada con miel","Crepes dulces","Flan de café","Crema pastelera con frutas",
    "Tarta de almendra","Tarta de galletas con chocolate","Bizcocho marmolado","Helado de yogur","Brownie sencillo",
    "Crema de limón","Naranja con canela","Fresas con nata"
  ];

  /* Overrides realistas para platos clave */
  const OV = (()=> {
    function R(ing, pasos, tiempo){ return {ing, pasos, tiempo}; }
    const CROQ_BASE = ["Leche entera","Harina de trigo","Mantequilla","Aceite de oliva","Cebolla","Nuez moscada","Sal","Pimienta","Huevos","Pan rallado"];
    const CROQ_PASOS = [
      "Pica fino cebolla y el relleno.","Pocha cebolla con aceite y mantequilla 6–8 min sin dorar.",
      "Añade el relleno y rehoga 1–2 min.","Incorpora harina (90–100 g/L leche) y cocina 2–3 min.",
      "Agrega la leche caliente poco a poco, removiendo hasta bechamel espesa y lisa.",
      "Sazona; cocina 8–10 min a fuego bajo.","Enfría 4 h.","Forma, empana y fríe 175–180 ºC."
    ];
    const M = new Map([
      ["croquetas de jamón", R(["Jamón serrano picado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de pollo", R(["Pollo cocido desmigado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de bacalao", R(["Bacalao desalado desmigado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de setas", R(["Setas picadas",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["patatas bravas", R(["Patatas","Aceite para freír","Sal","Ajo","Pimentón dulce","Pimentón picante","Tomate triturado","Vinagre"],
        ["Fríe patatas en dados.","Sofríe ajo; añade pimentón y tomate.","Cocina 10–12 min y vinagre.","Sirve sobre las patatas."],"30–40 min")],
      ["patatas alioli", R(["Patatas cocidas","Ajo","Huevo o leche","Aceite suave","Limón o vinagre","Sal","Perejil"],
        ["Cuece y enfría patatas.","Emulsiona ajo con huevo/leche y aceite.","Mezcla con perejil."],"25–35 min")],
      ["calamares a la romana", R(["Calamares","Harina","Huevo","Aceite para freír","Sal","Limón"],
        ["Seca y sala aros.","Harina + huevo.","Fríe 1–2 min 175–180 ºC.","Sirve con limón."],"20–30 min")],
      ["gazpacho andaluz", R(["Tomate","Pepino","Pimiento verde","Ajo","Pan","AOVE","Vinagre","Sal"],
        ["Tritura con pan hidratado.","Emulsiona con AOVE.","Ajusta sal/vinagre y enfría."],"15–20 min + frío")],
      ["salmorejo cordobés", R(["Tomate","Pan","Ajo","AOVE","Vinagre","Sal","Jamón","Huevo cocido"],
        ["Tritura base.","Emulsiona con AOVE/vinagre.","Sirve con jamón y huevo."],"15–20 min + frío")],
      ["fideuá de pescado", R(["Fideo grueso","Caldo de pescado","Sepia/calamar","Gamba","Ajo","Pimentón","Tomate","AOVE","Sal","Allioli (op)"],
        ["Sofríe sepia.","Ajo+pimentón+tomate.","Tuesta fideo, moja con caldo.","Añade sepia/gambas al final."],"30–40 min")],
      ["paella de verduras", R(["Arroz","Caldo vegetal","Judía verde","Garrafo/garbanzo","Pimiento","Tomate","Ajo","AOVE","Sal","Azafrán"],
        ["Sofríe verduras.","Nacarado de arroz.","Caldo+azafrán 18–20 min.","Reposo 5."],"35–45 min")],
      ["paella mixta", R(["Arroz","Caldo","Pollo","Conejo","Gamba/Calamar","Pimiento","Tomate","Ajo","AOVE","Sal","Azafrán"],
        ["Dora carnes y sofrito.","Nacarado+caldo/azafrán.","Mariscos al final + reposo."],"40–55 min")],
      ["arroz con bogavante", R(["Arroz","Bogavante","Caldo marisco","Ajo","Pimentón","Tomate","AOVE","Sal"],
        ["Marca bogavante.","Sofrito.","Arroz+caldo 18 min."],"35–45 min")],
      ["tortilla de patatas", R(["Patatas","Cebolla (op)","Huevos","Aceite","Sal"],
        ["Fríe patata suave.","Mezcla con huevo.","Cuaja al gusto."],"25–35 min")],
      ["fabada asturiana", R(["Fabes","Compango","Cebolla","Ajo","Pimentón","Sal"],
        ["Desala si procede.","Cuece a fuego bajo asustando.","Espuma y rectifica."],"120–180 min")],
      ["marmitako de bonito", R(["Bonito","Patata","Pimiento","Cebolla","Ajo","Tomate","Caldo","AOVE","Sal"],
        ["Sofrito + patata.","Cubre con caldo.","Bonito 2–3 min al final."],"35–45 min")],
      ["rabo de toro", R(["Rabo de toro","Verduras","Vino tinto","Caldo","AOVE","Sal","Harina (ligar)"],
        ["Dora rabo enharinado.","Sofríe y moja con vino.","Cuece 2–3 h."],"150–210 min")],
      ["merluza en salsa verde", R(["Merluza","Ajo","Perejil","Vino blanco","Caldo","AOVE","Sal","Almejas (op)"],
        ["Ajo + harina ligera.","Vino+caldo+perejil.","Merluza 5–7 min; almejas."],"20–30 min")],
      ["pulpo a la gallega", R(["Pulpo cocido","Patata cocida","AOVE","Pimentón","Sal en escamas"],
        ["Corta pulpo y patata.","Aliña y sirve."],"10–15 min")],
      ["tarta de queso al horno", R(["Queso crema","Huevos","Azúcar","Nata","Harina (op)"],
        ["Mezcla sin batir de más.","Horno 180 ºC 40–50 min.","Enfría."],"60–90 min con frío")],
      ["flan casero", R(["Leche","Huevos","Azúcar","Vainilla","Azúcar caramelo"],
        ["Caramelo al molde.","Mezcla base.","Baño maría 160–170 ºC 40–55 min.","Enfría y desmolda."],"70–120 min con frío")],
      ["arroz con leche", R(["Arroz","Leche entera","Azúcar","Canela","Limón"],
        ["Cuece removiendo.","Azúcar al final; enfría."],"45–60 min")],
      ["brownie sencillo", R(["Chocolate","Mantequilla","Azúcar","Huevos","Harina","Nueces (op)"],
        ["Funde choco/mantequilla.","Añade huevos+azúcar, luego harina.","Horno 170–180 ºC 20–25 min."],"35–45 min")]
    ]);
    return { get: (title) => M.get(title.toLowerCase()) || null };
  })();

  const PASOS_BASE = {
    Aperitivo:["Prepara y ten a mano todo.","Corta o dispón los ingredientes.","Sofríe o mezcla hasta aromatizar.","Monta y ajusta sal/aliño.","Reposa 1–2 min o sirve caliente.","Emplata y sirve."],
    Primero:["Lava y prepara verduras.","Sofríe ajo/cebolla suave.","Añade ingrediente principal y rehoga.","Cubre con caldo/agua y cocina.","Ajusta textura (tritura/reposa).","Sirve caliente o frío."],
    Segundo:["Seca la pieza y sala.","Añade adobo/especias.","Dora/hornea/sella bien.","Agrega guarnición/salsa y cocina al punto.","Reposa unos minutos.","Sirve con su jugo."],
    Postre:["Pesa y mide todo.","Mezcla secos y húmedos aparte.","Aromatiza (cítricos/vainilla/canela).","Hornea/refrigera hasta cuajar.","Enfría o reposa.","Decora y sirve."]
  };

  // Utils
  function stripDiacritics(s){ try{ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch{ return s||""; } }
  const slug = s => stripDiacritics((s||"").toLowerCase()).replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function ingredientesPara(cat,t){
    t=t.toLowerCase(); let ing=[];
    const ov = OV.get(t); if (ov) return ov.ing;
    if(cat==="Aperitivo"){
      if(/empanadill/.test(t)) ing=["Obladas","Atún/carne","Cebolla","Tomate frito","Huevo","Aceite","Sal"];
      else if(/alioli/.test(t)) ing=["Patatas","Ajo","Huevo o leche","Aceite suave","Limón/vinagre","Sal","Perejil"];
      else if(/boquerones/.test(t)) ing=["Boquerones","Vinagre","Ajo","Perejil","Aceite","Sal"];
      else if(/romana|calamar/.test(t)) ing=["Calamares","Harina","Huevo","Aceite","Sal","Limón"];
      else if(/hummus/.test(t)) ing=["Garbanzos","Tahini","Ajo","Limón","Aceite","Sal","Comino"];
      else ing=["Pan/base","Aceite de oliva","Ajo (opcional)","Sal"];
    } else if(cat==="Primero"){
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/sopa|caldo/.test(t)) ing=["Caldo","Ajo/Cebolla","Aceite","Sal"];
      else if(/crema|vichyssoise|porrusalda|zanahoria/.test(t)) ing=["Verdura principal","Cebolla/Puerro","Caldo","Aceite","Sal"];
      else if(/arroz|paella/.test(t)) ing=["Arroz","Caldo","Verduras","Aceite","Sal","Azafrán (opcional)"];
      else if(/fideu/.test(t)) ing=["Fideos","Caldo de pescado","Ajo","Pimentón","Tomate","Aceite","Sal"];
      else if(/ensalada/.test(t)) ing=["Lechuga/legumbre","Tomate","Cebolla","Aceite","Vinagre","Sal"];
    } else if(cat==="Segundo"){
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/pollo/.test(t)) ing=["Pollo","Ajo","Aceite","Sal","Pimienta"];
      else if(/ternera|solomillo|chulet/.test(t)) ing=["Vacuno","Aceite","Sal","Pimienta"];
      else if(/cordero/.test(t)) ing=["Cordero","Ajo","Romero","Aceite","Sal"];
      else if(/secreto|lomo|costillas/.test(t)) ing=["Cerdo","Ajo","Pimentón","Aceite","Sal"];
      else if(/bacalao|merluza|dorada|lubina|trucha|bonito|atun/.test(t)) ing=["Pescado","Aceite","Ajo/Perejil","Sal"];
      else if(/paella|arroz/.test(t)) ing=["Arroz","Caldo","Pollo/Marisco","Pimiento","Tomate","Azafrán","Sal"];
      else if(/tortilla|revuelto/.test(t)) ing=["Huevos","Patata/Setas","Aceite","Sal"];
    } else {
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/flan/.test(t)) ing=["Leche","Huevos","Azúcar","Vainilla","Azúcar para caramelo"];
      else if(/natilla/.test(t)) ing=["Leche","Yemas","Azúcar","Maicena","Vainilla"];
      else if(/arroz con leche/.test(t)) ing=["Arroz","Leche","Azúcar","Canela","Limón"];
      else if(/tarta de queso/.test(t)) ing=["Queso crema","Huevos","Azúcar","Nata","Harina (opcional)"];
      else if(/bizcocho|galleta|magdalena|tarta/.test(t)) ing=["Harina","Azúcar","Huevos","Mantequilla/Aceite","Levadura"];
      else if(/helado|mousse/.test(t)) ing=["Fruta/Yogur/Chocolate","Azúcar","Nata/Leche"];
      else ing=["Azúcar","Leche/Huevos/Harina (según postre)"];
    }
    return Array.from(new Set(ing));
  }

  function tiempo(cat,t){
    const ov=OV.get(t.toLowerCase()); if(ov) return ov.tiempo;
    t=t.toLowerCase();
    if(cat==="Aperitivo") return /croqueta|empanad/.test(t)?"25–35 min":"5–15 min";
    if(cat==="Primero")   return /arroz|fideu|estof|fabada|cocido|marisc/.test(t)?"30–50 min":"15–30 min";
    if(cat==="Segundo")   return /asado|horno|costillas|carrilleras|rabo/.test(t)?"45–90 min":"15–35 min";
    if(cat==="Postre")    return /tarta|horno|tocino|calatrava/.test(t)?"40–70 min":/helado|mousse|frutas/.test(t)?"10–20 min":"20–40 min";
    return "20–30 min";
  }

  function pasosPara(cat,t){
    const ov=OV.get(t.toLowerCase()); if(ov) return ov.pasos;
    return PASOS_BASE[cat];
  }

  function build(cat,list){
    return list.map(n=>({categoria:cat,titulo:n,imagen:IMG_URL(n, cat),
      ingredientes:ingredientesPara(cat,n), pasos:pasosPara(cat,n), tiempo:tiempo(cat,n)}));
  }

  const RECETAS = [
    ...build("Aperitivo", APERITIVOS),
    ...build("Primero", PRIMEROS),
    ...build("Segundo", SEGUNDOS),
    ...build("Postre", POSTRES)
  ];

  /* ===== Estado + UI ===== */
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const state = {
    q:"", cat:"Todas", list:RECETAS, current:null, step:0,
    dark: matchMedia('(prefers-color-scheme: dark)').matches,
    contrast:false, font:16, listening:false, rate:0.9,
    autoListen:true
  };
  function $(id){ return document.getElementById(id); }
  const els = {
    grid: $('recipesGrid'), empty: $('emptyState'), count: $('countLabel'), search: $('search'),
    tabs: () => document.querySelectorAll('[role="tab"]'),
    status: $('readerStatus'),
    toggleTheme: $('toggleTheme'), toggleContrast: $('toggleContrast'),
    fontPlus: $('fontPlus'), fontMinus: $('fontMinus'),
    toggleMic: $('toggleMic'), heard: $('heardText'), voiceRate: $('voiceRate'),
    autoListen: $('autoListen'),
    detailModal: $('detailModal'), detailTitle: $('detailTitle'), detailImg: $('detailImg'),
    detailMeta: $('detailMeta'), detailIngredients: $('detailIngredients'), detailSteps: $('detailSteps'),
    btnReadAll: $('btnReadAll'), btnGuided: $('btnGuided'), btnAddAll: $('btnAddAll'),
    guidedModal: $('guidedModal'), gTitle: $('guidedTitle'), gSteps: $('guidedSteps'),
    gProg: $('guidedProgress'), next: $('nextStep'), prev: $('prevStep'),
    rep: $('repeatStep'), stop: $('stopReading'), close: $('closeGuided'), printBtn: $('printRecipe'),
    shoppingDrawer: $('shoppingDrawer'), openShopping: $('openShopping'), closeShopping: $('closeShopping'),
    shoppingList: $('shoppingList'), shoppingEmpty: $('shoppingEmpty'), newItem: $('newItem'),
    addItem: $('addItem'), exportList: $('exportList'), printList: $('printList'), clearChecked: $('clearChecked'),
    caption: $('ttsCaption'), closeDetail: $('closeDetail')
  };

  function applyTheme(){ document.body.classList.toggle('dark', state.dark); }
  function applyContrast(){ document.documentElement.classList.toggle('hc', state.contrast); }
  function setFont(px){ state.font = Math.max(14, Math.min(22, px)); document.documentElement.style.setProperty('--base-font', state.font+'px'); }
  applyTheme(); applyContrast(); setFont(state.font);
  els.toggleTheme.onclick = () => { state.dark = !state.dark; applyTheme(); };
  els.toggleContrast.onclick = () => { state.contrast = !state.contrast; applyContrast(); };
  els.fontPlus.onclick = () => setFont(state.font+1);
  els.fontMinus.onclick = () => setFont(state.font-1);

  // Tabs
  function setActiveTab(btn){
    els.tabs().forEach(t => t.setAttribute('aria-selected', t === btn ? 'true' : 'false'));
    state.cat = btn.dataset.cat;
    filter();
  }
  els.tabs().forEach(b => b.addEventListener('click', () => setActiveTab(b)));

  // Favoritos
  const FKEY='fav.v1';
  let fav = new Set(JSON.parse(localStorage.getItem(FKEY)||'[]'));
  function saveFav(){ try{ localStorage.setItem(FKEY, JSON.stringify([...fav])); }catch{} }
  function isFav(r){ return fav.has(r.titulo); }
  function toggleFav(r){ isFav(r) ? fav.delete(r.titulo) : fav.add(r.titulo); saveFav(); filter(); }

  // Tarjetas
  function card(r,i){
    const star = isFav(r) ? '⭐' : '☆';
    return `<article class="card" role="article" aria-label="${r.titulo}">
      <img src="${r.imagen}" alt="Foto de ${r.titulo}" class="w-full h-44 sm:h-48 object-cover"
           loading="lazy" decoding="async" width="800" height="500" referrerpolicy="no-referrer"
           onerror="this.onerror=null; this.src='${PLACE[r.categoria] || PLACE.Primero}'"
           style="width:100%;height:12rem;object-fit:cover">
      <div style="padding:.75rem;display:grid;gap:.5rem">
        <h3 style="font-size:1.1rem;font-weight:700;margin:0">${r.titulo}</h3>
        <p class="text-muted" style="margin:0;font-size:.9rem">${r.categoria} · ${r.tiempo}</p>
        <div style="display:flex;flex-wrap:wrap;gap:.5rem;padding-top:.25rem">
          <button class="btn btn-ghost" data-a="leer" data-i="${i}" aria-label="Leer ${r.titulo} en voz alta" title="Leer">🔈 Leer</button>
          <button class="btn btn-primary" data-a="guiada" data-i="${i}" aria-label="Cocina guiada para ${r.titulo}" title="Guiada">▶️ Guiada</button>
          <button class="btn btn-ghost" data-a="abrir" data-i="${i}" aria-label="Abrir detalles de ${r.titulo}" title="Abrir">📖 Abrir</button>
          <button class="btn btn-ghost" data-a="lista" data-i="${i}" aria-label="Añadir ingredientes de ${r.titulo} a la lista" title="Añadir a lista">🧺 Añadir</button>
          <button class="btn btn-ghost" data-a="fav" data-i="${i}" aria-label="Marcar favorito" title="Favorito">${star} Favorito</button>
        </div>
      </div>
    </article>`;
  }

  function render(list){
    state.list = list;
    if(!list.length){
      els.grid.innerHTML = "";
      els.empty.style.display = "block";
      els.count.textContent = "Mostrando 0 recetas.";
      return;
    }
    els.empty.style.display = "none";
    els.grid.innerHTML = list.map((r,i)=>card(r,i)).join("");
    els.count.textContent = `Mostrando ${list.length} recetas.`;
    try{ injectListLD(list); }catch{}
  }

  function filter(){
    const q = state.q.toLowerCase().trim();
    const lAll = RECETAS.filter(r =>
      (state.cat==="Todas" || r.categoria===state.cat) &&
      (!q || [r.titulo, ...r.ingredientes, ...r.pasos].join(" ").toLowerCase().includes(q))
    );
    const l = state.cat==="Favoritas" ? lAll.filter(r=>fav.has(r.titulo)) : lAll;
    render(l);
  }

  render(RECETAS);

  els.search.oninput = e => { state.q = e.target.value; filter(); };
  document.addEventListener('keydown', e => {
    if(e.ctrlKey && e.key === '/'){ e.preventDefault(); els.search.focus(); }
  });

  function openDetail(r){
    state.current = r;
    els.detailTitle.textContent = r.titulo;
    els.detailImg.src = r.imagen;
    els.detailImg.alt = `Foto de ${r.titulo}`;
    els.detailImg.referrerPolicy = "no-referrer";
    els.detailImg.onerror = () => { els.detailImg.onerror=null; els.detailImg.src = PLACE[state.current?.categoria || 'Primero']; };
    els.detailMeta.textContent = `${r.categoria} · ${r.tiempo}`;
    els.detailIngredients.innerHTML = r.ingredientes.map(i=>`<li>${i}</li>`).join("");
    els.detailSteps.innerHTML = r.pasos.map(p=>`<li>${p}</li>`).join("");
    const m = $('detailModal'); m.style.display="flex";
    injectRecipeLD(r);
    if(untrapDetail) untrapDetail(); untrapDetail = trapFocus(m);
    ensureShareButton();
  }
  function closeDetail(){ const m=$('detailModal'); m.style.display="none"; if(untrapDetail) untrapDetail(); }
  els.closeDetail.onclick = closeDetail;
  document.getElementById('detailModal').addEventListener('click', e => { if(e.target.id==='detailModal') closeDetail(); });

  /* ===== Voz (TTS) ===== */
  let ttsVoice = null, voicesReady = false;
  function pickVoice(){
    const vs = speechSynthesis.getVoices();
    voicesReady = vs && vs.length>0;
    ttsVoice = vs.find(v=>/Spanish.*(Spain)|es[-_]ES/i.test(v.name+v.lang))
             || vs.find(v=>/Spanish|es[-_]/i.test(v.name+v.lang))
             || vs[0] || null;
  }
  if('speechSynthesis' in window){
    try{ pickVoice(); speechSynthesis.onvoiceschanged = pickVoice; }catch{}
  }
  els.voiceRate.onchange = e => { state.rate = Number(e.target.value) || 0.9; };

  function unlockTTSOnce(){
    if (!('speechSynthesis' in window) || unlockTTSOnce.done) return;
    try{ speechSynthesis.cancel(); speechSynthesis.resume(); }catch{}
    const u = new SpeechSynthesisUtterance(' ');
    try{ speechSynthesis.speak(u);}catch{} try{ speechSynthesis.cancel(); }catch{}
    unlockTTSOnce.done = true;
    document.removeEventListener('touchend', unlockTTSOnce);
    document.removeEventListener('click', unlockTTSOnce);
  }
  document.addEventListener('touchend', unlockTTSOnce, {passive:true});
  document.addEventListener('click', unlockTTSOnce, {once:true});

  let speakLock=false;
  function stopSpeak(){ try{ speechSynthesis.cancel(); }catch{} }
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  async function speakSafe(text){
    if(!('speechSynthesis' in window)) return;
    while(speakLock) await sleep(20);
    speakLock = true;
    if(!voicesReady){ try{ pickVoice(); }catch{} }
    stopSpeak(); await sleep(80);
    const u = new SpeechSynthesisUtterance(text);
    if(ttsVoice) u.voice = ttsVoice;
    u.lang = (ttsVoice && ttsVoice.lang) || 'es-ES';
    u.rate = state.rate; u.pitch = 1.0;
    const cap = document.getElementById('ttsCaption');
    if(cap){
      u.onstart = ()=>{ cap.textContent = text; cap.classList.add('show'); };
      u.onend   = ()=>{ cap.classList.remove('show'); cap.textContent=''; };
    }
    const done = new Promise(res=>{ u.onend=()=>{ speakLock=false; res(); }; u.onerror=()=>{ speakLock=false; res(); }; });
    try{ speechSynthesis.speak(u); }catch{ speakLock=false; }
    await done;
  }

  function readRecipe(r){
    const intro = `${r.titulo}. ${r.categoria}. Tiempo ${r.tiempo}.`;
    const ing = r.ingredientes?.length ? `Ingredientes: ${r.ingredientes.join(", ")}.` : "";
    const pasos = r.pasos?.length ? `Pasos: ${r.pasos.map((p,i)=>`Paso ${i+1}: ${p}.`).join(" ")}` : "";
    speakSafe([intro,ing,pasos].filter(Boolean).join(" "));
    els.status.textContent = `Leyendo ${r.titulo}.`;
  }

  /* ===== Guiado + Temporizador ===== */
  function ensureCurrent(){
    if(!state.current){
      const primera = (state.list && state.list[0]) || null;
      if(!primera){ els.status.textContent="Abre una receta y pulsa ‘Guiada’."; return false; }
      state.current = primera; state.step = 0;
    }
    return true;
  }
  function openGuided(r){
    state.current = r; state.step = 0;
    $('guidedRecipeTitle').textContent = r.titulo;
    $('guidedSteps').innerHTML = r.pasos.map((p,i)=>`<li data-step="${i}">${p}</li>`).join("");
    const m=$('guidedModal'); m.style.display="flex";
    if(untrapGuided) untrapGuided(); untrapGuided = trapFocus(m);
    els.status.textContent = "Voz manos libres activa.";
    speakSafe(`Iniciamos ${r.titulo}. Di: siguiente, anterior, repetir, leer ingredientes o salir.`);
    readCurrent();
    saveSession();
    if(state.autoListen) startAutoRecognizer();
  }
  function closeGuided(){
    stopSpeak();
    const m=$('guidedModal'); m.style.display="none";
    els.status.textContent="Cocina guiada cerrada.";
    if(untrapGuided) untrapGuided();
    stopAutoRecognizer();
    saveSession();
  }
  function readCurrent(){
    if(!ensureCurrent()) return;
    const pasos = state.current.pasos || []; if(!pasos.length) return;
    if(state.step<0) state.step=0; if(state.step>=pasos.length) state.step=pasos.length-1;
    speakSafe(`Paso ${state.step+1}. ${pasos[state.step]}`);
    const t = pasos.length; $('guidedProgress').textContent = `Paso ${state.step+1} de ${t}`;
    [...$('guidedSteps').children].forEach((li,i)=>li.style.fontWeight = (i===state.step?'700':'400'));

    clearTimerUI();
    try{
      const p = state.current?.pasos?.[state.step] || "";
      const m = /(\d{1,2})\s*(?:min|mins|minutos)\b/i.exec(p);
      if(m){ const mins = Number(m[1]); if(mins>0){ speakSafe(`Inicio temporizador de ${mins} minutos.`); startStepTimer(mins); } }
    }catch{}
  }
  async function nextStep(){
    if(!ensureCurrent()) return;
    const t = (state.current.pasos||[]).length;
    if(state.step < t-1){ state.step++; stopSpeak(); await sleep(60); readCurrent(); saveSession(); }
    else { stopSpeak(); await sleep(60); speakSafe("Receta terminada. ¡Buen provecho!"); saveSession(); }
  }
  async function prevStep(){
    if(!ensureCurrent()) return;
    if(state.step>0){ state.step--; stopSpeak(); await sleep(60); readCurrent(); saveSession(); }
    else { stopSpeak(); await sleep(60); speakSafe("Ya estás en el primer paso."); }
  }
  function repeatStep(){ stopSpeak(); setTimeout(readCurrent,80); }
  function readIngredients(){
    if(!ensureCurrent()) return;
    const ing = state.current?.ingredientes || [];
    stopSpeak();
    setTimeout(()=>speakSafe(ing.length?("Ingredientes: "+ing.join(", ")):"No hay ingredientes listados."),80);
  }
  function goToStep(n){
    const total = state?.current?.pasos?.length || 0;
    if(n>=0 && n<total){ state.step=n; stopSpeak(); setTimeout(readCurrent,80); saveSession(); }
    else { stopSpeak(); setTimeout(()=>speakSafe("Ese número de paso no existe."),80); }
  }
  $('nextStep')?.addEventListener('click', nextStep);
  $('prevStep')?.addEventListener('click', prevStep);
  $('repeatStep')?.addEventListener('click', repeatStep);
  $('stopReading')?.addEventListener('click', ()=>{ stopSpeak(); });
  $('closeGuided')?.addEventListener('click', closeGuided);
  $('printRecipe')?.addEventListener('click', ()=>{ window.print(); });

  els.btnReadAll.onclick = ()=>{ if(state.current) readRecipe(state.current); };
  els.btnGuided.onclick = ()=>{ if(state.current) openGuided(state.current); };
  els.btnAddAll.onclick = ()=>{ if(state.current) addMany(state.current.ingredientes||[]); };
  els.grid.addEventListener('click',e=>{
    const b = e.target.closest('button[data-a]'); if(!b) return;
    const r = state.list[Number(b.dataset.i)]; if(!r) return;
    if(b.dataset.a==='leer')  { openDetailWithHash(r); readRecipe(r); }
    if(b.dataset.a==='guiada'){ openDetailWithHash(r); openGuided(r); }
    if(b.dataset.a==='abrir') { openDetailWithHash(r); }
    if(b.dataset.a==='lista') addMany(r.ingredientes||[]);
    if(b.dataset.a==='fav')  toggleFav(r);
  });

  document.addEventListener('keydown',e=>{
    if($('guidedModal').style.display!=="flex") return;
    if(e.key===' '||e.key==='ArrowRight'){ e.preventDefault(); nextStep(); }
    if(e.key==='ArrowLeft'){ e.preventDefault(); prevStep(); }
    if(e.key==='r'||e.key==='R'){ e.preventDefault(); repeatStep(); }
    if(e.key==='Escape'){ e.preventDefault(); closeGuided(); closeDetail(); }
  });

  /* ===== Lista de la compra ===== */
  const SKEY='shopping.v1'; let shopping=JSON.parse(localStorage.getItem(SKEY)||'[]');
  function save(){ localStorage.setItem(SKEY, JSON.stringify(shopping)); }
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function renderList(){
    $('shoppingList').innerHTML = shopping.map(i=>`
      <li style="display:flex;align-items:center;gap:.5rem">
        <input type="checkbox" ${i.done?'checked':''} data-a="t" data-id="${i.id}" aria-label="Marcar ${i.text}" title="Marcar ${i.text}">
        <input type="text" value="${i.text.replace(/"/g,'&quot;')}" style="flex:1;background:transparent;border:none;border-bottom:1px solid #d6d3d1;padding:.25rem .35rem" data-a="e" data-id="${i.id}" aria-label="Editar ${i.text}" title="Editar ${i.text}">
        <button class="btn btn-ghost" data-a="d" data-id="${i.id}" aria-label="Eliminar ${i.text}" title="Eliminar ${i.text}">🗑️</button>
      </li>`).join("");
    $('shoppingEmpty').style.display = shopping.length>0 ? "none" : "block";
  }
  function addItem(text){ text=(text||"").trim(); if(!text) return; shopping.push({id:uid(),text,done:false}); save(); renderList(); }
  function addMany(arr){ (arr||[]).forEach(addItem); openDrawer(); }
  function openDrawer(){ const d=$('shoppingDrawer'); d.classList.add('open'); d.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ const d=$('shoppingDrawer'); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }
  els.openShopping.onclick = openDrawer; els.closeShopping.onclick = closeDrawer;
  els.addItem.onclick = ()=>{ addItem(els.newItem.value); els.newItem.value=""; els.newItem.focus(); };
  els.newItem.onkeydown = e=>{ if(e.key==='Enter'){ e.preventDefault(); els.addItem.click(); } };
  $('shoppingList').addEventListener('click',e=>{
    const b=e.target.closest('button[data-a="d"]'); if(!b) return;
    shopping = shopping.filter(x=>x.id!==b.dataset.id); save(); renderList();
  });
  $('shoppingList').addEventListener('change',e=>{
    const c=e.target.closest('input[type="checkbox"][data-a="t"]'); if(!c) return;
    const it=shopping.find(x=>x.id===c.dataset.id); if(it){ it.done=c.checked; save(); }
  });
  $('shoppingList').addEventListener('input',e=>{
    const t=e.target.closest('input[type="text"][data-a="e"]'); if(!t) return;
    const it=shopping.find(x=>x.id===t.dataset.id); if(it){ it.text=t.value; save(); }
  });
  els.clearChecked.onclick = ()=>{ shopping = shopping.filter(i=>!i.done); save(); renderList(); };
  els.exportList.onclick = ()=>{
    const data = shopping.map(i=>`${i.done?'[x]':'[ ]'} ${i.text}`).join('\n');
    const a=document.createElement('a');
    a.href = URL.createObjectURL(new Blob([data],{type:'text/plain'}));
    a.download='lista_compra.txt'; a.click();
  };
  els.printList.onclick = ()=>{
    const w = window.open('','_blank');
    w.document.write(`<pre>${shopping.map(i=>`${i.done?'[x]':'[ ]'} ${i.text}`).join('\n')}</pre>`);
    w.document.close(); w.print(); setTimeout(()=>w.close(),300);
  };

  /* ===== Temporizadores por paso ===== */
  let currentTimer = null, countdownInt = null;
  function clearTimerUI(){
    if(countdownInt) { clearInterval(countdownInt); countdownInt = null; }
    const old = document.getElementById('guidedTimer'); if(old) old.remove();
  }
  function beep(ms=200, freq=880){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ctx.createOscillator(); const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq; osc.start();
      setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
    }catch{}
  }
  function startStepTimer(minutes){
    clearTimerUI();
    if(currentTimer) { clearTimeout(currentTimer); currentTimer = null; }
    const box = document.createElement('div');
    box.id='guidedTimer';
    box.className='mt-3 text-sm';
    box.innerHTML = `<span>⏱️ Temporizador: <strong id="tleft"></strong></span>
      <button class="btn btn-ghost ml-2" id="cancelTimer" aria-label="Cancelar temporizador" title="Cancelar temporizador">Cancelar</button>`;
    document.querySelector('#guidedModal .card > div:last-child')?.appendChild(box);

    let left = Math.round(minutes*60);
    const $left = document.getElementById('tleft');
    const fmt = s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
    $left.textContent = fmt(left);

    countdownInt = setInterval(()=>{ left--; $left.textContent = fmt(Math.max(0,left)); }, 1000);
    currentTimer = setTimeout(()=>{ clearTimerUI(); beep(300); speakSafe("¡Tiempo!"); }, minutes*60*1000);
    document.getElementById('cancelTimer').onclick = ()=>{ clearTimerUI(); if(currentTimer){ clearTimeout(currentTimer); currentTimer=null; } };
  }

  /* ===== JSON-LD (SEO) ===== */
  function injectRecipeLD(r){
    const ld = {"@context":"https://schema.org","@type":"Recipe","name": r.titulo,"recipeCategory": r.categoria,"image": r.imagen,"recipeIngredient": r.ingredientes,"recipeInstructions": (r.pasos||[]).map(p=>({"@type":"HowToStep","text":p})),"totalTime": "PT30M"};
    let n = document.getElementById("ld-recipe");
    if(!n){ n=document.createElement("script"); n.type="application/ld+json"; n.id="ld-recipe"; document.head.appendChild(n); }
    n.textContent = JSON.stringify(ld);
  }
  function injectListLD(list){
    const items = (list||[]).slice(0,50).map((r,i)=>({"@type":"ListItem","position":i+1,"name":r.titulo,"url": location.origin + location.pathname + '#receta=' + slug(r.titulo)}));
    const ld = {"@context":"https://schema.org","@type":"ItemList","itemListElement":items};
    let n = document.getElementById("ld-list");
    if(!n){ n=document.createElement("script"); n.type="application/ld+json"; n.id="ld-list"; document.head.appendChild(n); }
    n.textContent = JSON.stringify(ld);
  }

  /* ===== Focus trap ===== */
  function trapFocus(modal){
    const sel = 'a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])';
    function get(){ return modal.querySelectorAll(sel); }
    function first(){ return get()[0]; }
    function last(){ const f=get(); return f[f.length-1]; }
    function onKey(e){
      if(e.key!=='Tab') return;
      const a = document.activeElement;
      if(e.shiftKey && a===first()){ e.preventDefault(); last().focus(); }
      else if(!e.shiftKey && a===last()){ e.preventDefault(); first().focus(); }
    }
    modal.addEventListener('keydown', onKey);
    setTimeout(()=>first()?.focus(), 0);
    return ()=> modal.removeEventListener('keydown', onKey);
  }
  let untrapDetail = null, untrapGuided = null;

  /* ===== Deep-link & Compartir ===== */
  function openDetailWithHash(r){
    openDetail(r);
    const h = '#receta=' + slug(r.titulo);
    if(location.hash !== h){ history.pushState({}, "", h); }
  }
  function fromHashOpen(){
    const m = location.hash.match(/#receta=([a-z0-9\-]+)/i);
    if(!m) return;
    const r = RECETAS.find(x=>slug(x.titulo)===m[1]);
    if(r) openDetail(r);
  }
  window.addEventListener('popstate', fromHashOpen);
  document.addEventListener('DOMContentLoaded', fromHashOpen);

  function ensureShareButton(){
    const bar = document.querySelector('#detailModal .mt-3') || document.querySelector('#detailModal .card div:nth-child(2) > div:nth-child(1) div:nth-child(3)');
    if(!bar) return;
    let btn = document.getElementById('btnShare');
    if(!btn){
      btn = document.createElement('button');
      btn.id='btnShare';
      btn.className='btn btn-ghost';
      btn.setAttribute('aria-label','Compartir receta');
      btn.setAttribute('title','Compartir receta');
      btn.textContent='📤 Compartir';
      bar.appendChild(btn);
    }
    btn.onclick = async ()=>{
      if(!state.current) return;
      const url = location.origin + location.pathname + '#receta=' + slug(state.current.titulo);
      if(navigator.share){
        try{ await navigator.share({ title: state.current.titulo, text: 'Receta', url }); }catch{}
      }else{
        try{ await navigator.clipboard.writeText(url);}catch{}
        alert('Enlace copiado: ' + url);
      }
    };
  }

  /* ===== Pestaña Favoritas ===== */
  (function addFavTab(){
    const tablist = document.querySelector('[role="tablist"]');
    const btn = document.createElement('button');
    btn.className='tab'; btn.role='tab'; btn.id='tab-fav'; btn.dataset.cat='Favoritas';
    btn.setAttribute('aria-selected','false'); btn.setAttribute('title','Mostrar favoritas'); btn.setAttribute('aria-label','Mostrar favoritas');
    btn.textContent='Favoritas';
    tablist.appendChild(btn);
    btn.addEventListener('click', ()=>setActiveTab(btn));
  })();

  /* ===== Reanudar sesión ===== */
  const SKEY_SESSION = "session.v1"; // {slug, step}
  function saveSession(){
    try{
      if(!state.current) return;
      localStorage.setItem(SKEY_SESSION, JSON.stringify({ slug: slug(state.current.titulo), step: state.step||0 }));
    }catch{}
  }
  function loadSession(){
    try{
      const raw = localStorage.getItem(SKEY_SESSION);
      if(!raw) return null;
      const d = JSON.parse(raw);
      const r = RECETAS.find(x => slug(x.titulo) === d.slug);
      return r ? {recipe:r, step:Math.max(0, Math.min((r.pasos||[]).length-1, d.step||0))} : null;
    }catch{ return null; }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const last = loadSession();
    if(last && confirm(`¿Reanudar "${last.recipe.titulo}" en el paso ${last.step+1}?`)){
      openDetailWithHash(last.recipe);
      openGuided(last.recipe);
      state.step = last.step;
      readCurrent();
    }
  });

  /* ==========================
     🔊 VOZ MANOS LIBRES (Auto Listen)
     ========================== */
  const SRClass = (!isIOS) && (window.SpeechRecognition||window.webkitSpeechRecognition)
                ? (window.SpeechRecognition||window.webkitSpeechRecognition) : null;

  let recAuto = null;
  let autoRestartTimer = null;

  function setStatus(msg){ els.status.textContent = msg; }
  function norm(s){ try{ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch{return (s||"").toLowerCase().trim();} }

  // HUD
  let hud, bar;
  function ensureHUD(){
    if(hud) return;
    hud = document.createElement('div');
    hud.id='voiceHUD';
    hud.innerHTML = `<span id="voiceDot" aria-hidden="true"></span><span id="voiceWave" aria-hidden="true"><i></i></span><span id="voiceTip">Voz manos libres</span>`;
    bar = hud.querySelector('#voiceWave > i');
    els.toggleMic.insertAdjacentElement('afterend', hud);
  }
  ensureHUD();
  function drawLevel(w){ if(!bar) return; const px=Math.max(4,Math.min(138,Math.round(w*138))); bar.style.width=px+'px'; }

  // Levenshtein light
  function lev(a,b){
    const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
    const dp=new Array(n+1).fill(0); for(let j=0;j<=n;j++) dp[j]=j;
    for(let i=1;i<=m;i++){ let prev=dp[0], tmp; dp[0]=i; for(let j=1;j<=n;j++){
      tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev + (a[i-1]===b[j-1]?0:1)); prev=tmp;
    }}
    return dp[n];
  }

  const CMD_LIST = [
    {type:'next', variants:['siguiente','proximo','avanza','adelante','continuar']},
    {type:'prev', variants:['anterior','atras','retroceder']},
    {type:'repeat', variants:['repetir','otra vez','de nuevo','repite']},
    {type:'ingredients', variants:['leer ingredientes','ingredientes','leer lista']},
    {type:'stop', variants:['salir','parar','detener','cerrar']}
  ];
  const NUM = {uno:1,una:1,dos:2,tres:3,cuatro:4,cinco:5,seis:6,siete:7,ocho:8,nueve:9,diez:10,once:11,doce:12,trece:13,catorce:14,quince:15,dieciseis:16,diecisiete:17,dieciocho:18,diecinueve:19,veinte:20};

  function parseCommand(raw){
    const t = norm(raw).replace(/\bpaso\s+(uno|una|dos|tres|cuatro|cinco|seis|siete|ocho|nueve|diez|once|doce|trece|catorce|quince|dieciseis|diecisiete|dieciocho|diecinueve|veinte)\b/g,(_,w)=>'paso '+NUM[w]);
    const m = t.match(/\bpaso\s+(\d{1,2})\b/); if(m) return {type:'goto', n:+m[1]};
    for(const c of CMD_LIST) for(const v of c.variants) if(t===v) return {type:c.type};
    let best=99, winner={type:'unknown'};
    for(const c of CMD_LIST){ for(const v of c.variants){ const d=lev(t,v); if(d<best){ best=d; winner={type:c.type}; } } }
    return best<=2 ? winner : {type:'unknown', raw:raw};
  }

  function makeRecognizer(){
    if(!SRClass) return null;
    const r=new SRClass();
    r.lang='es-ES';
    r.continuous=true;
    r.interimResults=true;
    r.maxAlternatives=4;
    return r;
  }

  function startAutoRecognizer(){
    if(!SRClass){
      setStatus(isIOS ? "Voz: iPhone/iPad no permite reconocimiento web. Usa botones." : "Voz: reconocimiento no disponible en este navegador.");
      document.getElementById('voiceHUD')?.classList.add('disabled');
      return;
    }
    if(recAuto) { try{recAuto.stop();}catch{} recAuto=null; }
    recAuto = makeRecognizer();
    if(!recAuto) return;

    recAuto.onstart = ()=>{ setStatus("🎙️ Escuchando… (manos libres)"); document.getElementById('voiceHUD')?.classList.add('listening'); };
    recAuto.onerror = e => { setStatus("Voz: " + (e.error||'error')); scheduleRestart(); };
    recAuto.onend   = ()=> { setStatus("Voz detenida. Intentando reanudar…"); scheduleRestart(); };
    recAuto.onresult = ev => {
      let finalText = "";
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        const res=ev.results[i];
        const txt=res[0]?.transcript||'';
        if(res.isFinal) finalText += txt + " ";
        els.heard && (els.heard.textContent=(res.isFinal?"✓ ":"… ")+txt);
        drawTalkingHint(txt);
      }
      if(finalText.trim()){
        const cmd = parseCommand(finalText.trim());
        if(cmd.type==='stop') return closeGuided();
        if(cmd.type==='repeat') return repeatStep();
        if(cmd.type==='next') return nextStep();
        if(cmd.type==='prev') return prevStep();
        if(cmd.type==='ingredients') return readIngredients();
        if(cmd.type==='goto') return goToStep(Math.max(0,(cmd.n||1)-1));
      }
    };

    try{
      recAuto.start();
    }catch(e){
      setStatus("Voz: permiso requerido. Pulsa “Reconectar voz”.");
    }
  }

  function stopAutoRecognizer(){
    if(autoRestartTimer){ clearTimeout(autoRestartTimer); autoRestartTimer=null; }
    if(recAuto){ try{recAuto.onresult=recAuto.onend=recAuto.onerror=null; recAuto.stop(); }catch{} recAuto=null; }
    document.getElementById('voiceHUD')?.classList.remove('listening','talking');
    drawLevel(0);
  }

  function scheduleRestart(){
    if(!state.autoListen) return;
    if(autoRestartTimer){ clearTimeout(autoRestartTimer); }
    autoRestartTimer = setTimeout(()=>{ try{ recAuto && recAuto.start(); }catch{} }, 600);
  }

  // UI para autoListen
  els.autoListen.onchange = (e)=>{ state.autoListen = !!e.target.checked; if(state.autoListen && !recAuto){ startAutoRecognizer(); } if(!state.autoListen){ stopAutoRecognizer(); } };
  els.toggleMic.onclick = ()=>{ stopAutoRecognizer(); startAutoRecognizer(); };

  /* ===== Inicial ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    filter(); renderList();
  });

  /* ========= Service Worker embebido (sin sw.js) ========= */
  (function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    const swCode = `
const APP_VER = "${APP_VERSION}";
const CORE = "core-" + APP_VER;
const PAGES = "pages-" + APP_VER;
const IMGS = "imgs-" + APP_VER;
const MAX_IMAGES = 150;

const CORE_ASSETS = ["./","./index.html"];

async function putSafe(cacheName, request, response) {
  try { const cache = await caches.open(cacheName); await cache.put(request, response.clone()); } catch(e) {}
  return response;
}
async function trim(cacheName, max) {
  const c = await caches.open(cacheName);
  const keys = await c.keys();
  if(keys.length <= max) return;
  await c.delete(keys[0]);
  return trim(cacheName, max);
}
function placeholder(url=""){
  const title = decodeURIComponent((url.split("/").pop() || "Receta").split("?")[0]).replace(/\\.[a-z0-9]+$/i,"").replace(/[-_]/g," ").slice(0,60);
  const svg = \`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="500"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#e5e7eb"/><stop offset="1" stop-color="#d1d5db"/></linearGradient></defs><rect width="800" height="500" fill="url(#g)"/><text x="50%" y="48%" text-anchor="middle" fill="#6b7280" font-size="28" font-family="system-ui">Sin imagen</text><text x="50%" y="60%" text-anchor="middle" fill="#9ca3af" font-size="16" font-family="system-ui">\${title}</text></svg>\`;
  return new Response(svg, { headers: { "Content-Type": "image/svg+xml" }, status:200 });
}

self.addEventListener("install",(e)=>{
  e.waitUntil((async()=>{
    const c = await caches.open(CORE);
    await c.addAll(CORE_ASSETS);
  })().then(()=>self.skipWaiting()));
});

self.addEventListener("activate",(e)=>{
  e.waitUntil((async()=>{
    const keys = await caches.keys();
    await Promise.all(keys.filter(k=>![CORE,PAGES,IMGS].includes(k)).map(k=>caches.delete(k)));
    await self.clients.claim();
  })());
});

self.addEventListener("fetch",(e)=>{
  const req = e.request;
  if(req.method !== "GET") return;
  const url = new URL(req.url);
  const same = url.origin === self.location.origin;

  if(req.mode === "navigate"){
    e.respondWith((async()=>{
      try{
        const net = await fetch(req);
        putSafe(PAGES, req, net.clone());
        return net;
      }catch{
        const idx = await caches.match("./index.html");
        return idx || new Response("",{status:503});
      }
    })());
    return;
  }

  if(req.destination === "image"){
    e.respondWith((async()=>{
      const cache = await caches.open(IMGS);
      const hit = await cache.match(req);
      if(hit){
        e.waitUntil((async()=>{ try{ const fresh = await fetch(req,{mode:"no-cors"}); await cache.put(req, fresh.clone()); await trim(IMGS, MAX_IMAGES);}catch{}})());
        return hit;
      }
      try{
        const resp = await fetch(req,{mode:"no-cors"});
        putSafe(IMGS, req, resp.clone()).then(()=>trim(IMGS, MAX_IMAGES));
        return resp;
      }catch{
        return placeholder(req.url);
      }
    })());
    return;
  }

  if(same && req.headers.get("accept")?.includes("text/html")){
    e.respondWith((async()=>{
      try{ const net=await fetch(req); putSafe(PAGES, req, net.clone()); return net; }
      catch{ const c=await caches.open(PAGES); return (await c.match(req)) || (await caches.match("./index.html")); }
    })());
    return;
  }

  e.respondWith((async()=>{
    const cache = await caches.open(same?PAGES:CORE);
    const cached = await cache.match(req);
    const network = fetch(req).then(res=>{ putSafe(same?PAGES:CORE, req, res.clone()); return res; }).catch(()=>null);
    return cached || network || new Response("",{status:504});
  })());
});

self.addEventListener("message",(e)=>{ if(e.data==="SKIP_WAITING") self.skipWaiting(); });
`;
    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(reg=>{
      // aviso de actualización
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        nw?.addEventListener('statechange', ()=>{
          if(nw.state==='installed' && navigator.serviceWorker.controller){
            if(confirm('Hay una actualización disponible. ¿Actualizar ahora?')){
              reg.waiting?.postMessage?.("SKIP_WAITING");
              setTimeout(()=>location.reload(), 300);
            }
          }
        });
      });
    }).catch(()=>{});
  })();
  </script>
</body>
</html>
