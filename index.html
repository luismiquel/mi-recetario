<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Recetario Español con 160 recetas. Búsqueda rápida, voz manos libres, cocina guiada, alto contraste, letra grande, lista de la compra y favoritos." />
  <title>Recetario Español – 160 recetas</title>

  <!-- theme-color por esquema -->
  <meta name="theme-color" content="#78350f" />
  <meta name="theme-color" content="#78350f" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b0f19" media="(prefers-color-scheme: dark)">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Estilos externos -->
  <link rel="stylesheet" href="./styles.css">
</head>
<body class="dark:bg-stone-900 dark:text-stone-200">
  <a href="#main" class="skip-link">Saltar al contenido principal</a>

  <noscript>
    <div class="noscript-box">
      Esta aplicación necesita JavaScript para búsqueda, voz, cocina guiada y lista de la compra.
    </div>
  </noscript>

  <div class="container" id="app">
    <header class="header">
      <div>
        <h1>Recetario Español – 160 recetas</h1>
        <p class="muted">Voz manos libres · Contraste · Letra grande · Lista de la compra.</p>
      </div>
      <div class="actions">
        <button id="toggleTheme" class="btn btn-ghost" type="button" title="Cambiar tema" aria-label="Cambiar tema">🌙/☀️</button>
        <button id="toggleContrast" class="btn btn-ghost" type="button" title="Alto contraste" aria-label="Alto contraste">🌓</button>
        <button id="fontMinus" class="btn btn-ghost" type="button" title="Reducir letra" aria-label="Reducir letra">A−</button>
        <button id="fontPlus" class="btn btn-ghost" type="button" title="Aumentar letra" aria-label="Aumentar letra">A+</button>
        <button id="openShopping" class="btn btn-ghost" type="button" title="Abrir lista de la compra" aria-label="Lista de la compra">🧺</button>
      </div>
    </header>

    <section class="card" aria-label="Búsqueda y filtros">
      <div class="filters">
        <div class="search-box">
          <label for="search" class="block text-sm font-medium mb-1">Buscar</label>
          <input id="search" type="search" inputmode="search" placeholder="Nombre, ingrediente… (Ctrl+/)"
                 class="input" />
        </div>

        <!-- Tabs accesibles como radiogrupo -->
        <div class="tabs" role="radiogroup" aria-label="Categorías" id="catGroup">
          <button class="tab" role="radio" aria-checked="true"  data-cat="Todas"     title="Mostrar todas"      type="button">Todas</button>
          <button class="tab" role="radio" aria-checked="false" data-cat="Aperitivo" title="Mostrar aperitivos" type="button">Aperitivos</button>
          <button class="tab" role="radio" aria-checked="false" data-cat="Primero"   title="Mostrar primeros"   type="button">Primeros</button>
          <button class="tab" role="radio" aria-checked="false" data-cat="Segundo"   title="Mostrar segundos"   type="button">Segundos</button>
          <button class="tab" role="radio" aria-checked="false" data-cat="Postre"    title="Mostrar postres"    type="button">Postres</button>
          <button class="tab" role="radio" aria-checked="false" data-cat="Favoritas" title="Mostrar favoritas"  id="tab-fav" type="button">Favoritas</button>
        </div>

        <div class="voice-controls">
          <label class="text-sm" for="voiceRate">Voz:</label>
          <select id="voiceRate" class="select" aria-label="Velocidad de lectura en voz alta">
            <option value="0.8">Lenta</option>
            <option value="0.9" selected>Clara</option>
            <option value="1.0">Normal</option>
          </select>
          <label for="autoListen" class="text-sm select-none" title="Escuchar sin pulsar">
            <input id="autoListen" type="checkbox" class="align-middle" checked> Auto
          </label>
          <button id="toggleMic" class="btn btn-primary" type="button" title="Reconectar reconocimiento de voz" aria-label="Reconectar reconocimiento de voz">🎤 Reconectar voz</button>
        </div>
      </div>
      <div id="readerStatus" class="text-xs muted2 mt-1" aria-live="polite"></div>
      <div id="heard" class="text-xs muted2 mt-1">🎧 Oído: <span id="heardText">—</span></div>
      <!-- HUD voz -->
      <div id="voiceHUD"><span id="voiceDot" aria-hidden="true"></span><span id="voiceWave" aria-hidden="true"><i></i></span><span id="voiceTip">Voz manos libres</span></div>
    </section>

    <section class="mb-2 text-sm muted">
      <span id="countLabel">Mostrando 0 recetas.</span>
    </section>

    <main id="main" aria-labelledby="countLabel">
      <div id="recipesGrid" class="grid" role="region" aria-label="Listado de recetas"></div>
      <div id="emptyState" class="hidden muted empty">No hay resultados.</div>
    </main>

    <!-- Modal Detalle -->
    <div id="detailModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="card modal-card">
        <div class="modal-head">
          <h3 id="detailTitle" class="text-xl font-semibold">Detalle</h3>
          <button id="closeDetail" class="btn btn-ghost" type="button" aria-label="Cerrar detalle" title="Cerrar">✕</button>
        </div>
        <div class="modal-body">
          <div>
            <img id="detailImg" src="https://placehold.co/800x500?text=Receta" alt="" class="detail-img" loading="lazy" decoding="async" width="800" height="500">
            <p id="detailMeta" class="muted meta"></p>
            <div class="btn-row">
              <button id="btnReadAll" class="btn btn-ghost" type="button" aria-label="Leer receta en voz alta" title="Leer">🔈 Leer</button>
              <button id="btnGuided" class="btn btn-primary" type="button" aria-label="Iniciar cocina guiada" title="Cocina guiada">▶️ Guiada</button>
              <button id="btnAddAll" class="btn btn-ghost" type="button" aria-label="Añadir todos los ingredientes a la lista" title="Añadir ingredientes">🧺 Añadir todo</button>
              <button id="btnShare" class="btn btn-ghost" type="button" aria-label="Compartir receta" title="Compartir">📤 Compartir</button>
            </div>
          </div>
          <div>
            <h4 class="text-lg font-semibold mt-1">Ingredientes</h4>
            <ul id="detailIngredients" class="list"></ul>
            <h4 class="text-lg font-semibold mt-1">Pasos</h4>
            <ol id="detailSteps" class="list"></ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Guiada -->
    <div id="guidedModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="guidedTitle">
      <div class="card modal-card">
        <div class="modal-head">
          <h3 id="guidedTitle" class="text-xl font-semibold">Cocina guiada</h3>
          <button id="closeGuided" class="btn btn-ghost" type="button" aria-label="Cerrar cocina guiada" title="Cerrar">✕</button>
        </div>
        <div class="modal-body-col">
          <p class="muted"><strong>Voz manos libres activa.</strong> Di: “siguiente”, “anterior”, “repetir”, “leer ingredientes”, “paso 2”, “salir”.</p>
          <div class="guided-box">
            <h4 id="guidedRecipeTitle" class="text-lg font-semibold"></h4>
            <ol id="guidedSteps" class="list"></ol>
          </div>
          <div class="guided-foot">
            <div class="text-xs muted2" id="guidedProgress" aria-live="polite"></div>
            <div class="btn-row">
              <button id="prevStep" class="btn btn-ghost" type="button" aria-label="Paso anterior" title="Anterior">← Anterior</button>
              <button id="repeatStep" class="btn btn-ghost" type="button" aria-label="Repetir paso" title="Repetir">⟲ Repetir</button>
              <button id="nextStep" class="btn btn-primary" type="button" aria-label="Paso siguiente" title="Siguiente">Siguiente →</button>
              <button id="stopReading" class="btn btn-ghost" type="button" aria-label="Parar lectura" title="Parar">■ Parar</button>
              <button id="printRecipe" class="btn btn-ghost" type="button" aria-label="Imprimir receta" title="Imprimir">🖨️ Imprimir</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drawer Lista compra -->
    <aside id="shoppingDrawer" class="drawer" aria-label="Lista de la compra" aria-hidden="true">
      <div class="modal-head">
        <h3 class="text-lg font-semibold">Lista de la compra</h3>
        <div class="actions">
          <button id="exportList" class="btn btn-ghost" type="button" aria-label="Exportar lista" title="Exportar lista">⬇️ Exportar</button>
          <button id="printList" class="btn btn-ghost" type="button" aria-label="Imprimir lista" title="Imprimir lista">🖨️</button>
          <button id="clearChecked" class="btn btn-ghost" type="button" aria-label="Borrar elementos marcados" title="Borrar marcados">🗑️ Marcados</button>
          <button id="closeShopping" class="btn btn-ghost" type="button" aria-label="Cerrar lista" title="Cerrar">✕</button>
        </div>
      </div>
      <div class="drawer-body">
        <div class="drawer-add">
          <label for="newItem" class="sr-only">Nuevo artículo</label>
          <input id="newItem" class="input" placeholder="Añadir artículo (ej. 1 kg tomates)" />
          <button id="addItem" class="btn btn-primary" type="button" aria-label="Añadir artículo" title="Añadir artículo">Añadir</button>
        </div>
        <ul id="shoppingList" class="shopping-list"></ul>
        <p id="shoppingEmpty" class="text-sm muted2 hidden">Tu lista está vacía.</p>
      </div>
    </aside>
  </div>

  <!-- Subtítulos de voz -->
  <div id="ttsCaption" role="status" aria-live="polite"></div>

  <!-- ========= JS embebido ========= -->
  <script>
  const APP_VERSION = "recetario-2.0.0";

  /* ===== Datos (160 recetas) ===== */
  const IMG = c => ({
    Aperitivo:"https://placehold.co/800x500?text=Aperitivo",
    Primero:"https://placehold.co/800x500?text=Primero",
    Segundo:"https://placehold.co/800x500?text=Segundo",
    Postre:"https://placehold.co/800x500?text=Postre"
  }[c]);

  const APERITIVOS = [
    "Tostas de tomate y jamón","Tostas de anchoa y pimiento","Tostas de escalivada","Tostas de salmón y queso fresco",
    "Croquetas de jamón","Croquetas de pollo","Croquetas de bacalao","Croquetas de setas",
    "Empanadillas de atún","Empanadillas de carne","Patatas bravas","Patatas alioli",
    "Boquerones en vinagre","Champiñones al ajillo","Gildas donostiarras","Pinchos de tortilla",
    "Pinchos morunos","Queso marinado en aceite","Hummus clásico con crudités","Hummus de remolacha",
    "Hummus de aguacate","Gazpacho en vasitos","Salmorejo en chupitos","Ensaladilla rusa",
    "Tortilla francesa mini","Banderillas variadas","Mejillones en escabeche","Sardinas marinadas",
    "Pulpo a la gallega (tapa)","Calamares a la romana","Torreznos crujientes","Jamón con picos",
    "Queso manchego con membrillo","Pimientos del padrón","Montadito de lomo","Montadito de pringá",
    "Bonito con tomate (tapa)","Pisto con huevo (tapa)","Chistorra a la sidra","Berenjena frita con miel"
  ];
  const PRIMEROS = [
    "Sopa de ajo","Sopa castellana","Gazpacho andaluz","Salmorejo cordobés","Ajoblanco","Crema de calabaza",
    "Crema de puerros","Crema de champiñón","Pisto manchego","Menestra de verduras","Lentejas estofadas",
    "Garbanzos con espinacas","Judías blancas con verduras","Arroz caldoso de verduras","Arroz a la cubana",
    "Arroz negro","Arroz al horno","Paella de verduras","Fideuá de pescado","Macarrones con tomate",
    "Tallarines al ajillo","Espaguetis carbonara ligera","Ensalada mixta","Ensalada campera","Ensalada de garbanzos",
    "Ensalada de pasta fría","Tomates aliñados","Papas arrugadas con mojo","Pimientos asados","Alcachofas salteadas",
    "Acelgas rehogadas","Sopa de pescado","Caldo gallego","Cocido andaluz (sopa)","Sopa minestrone","Vichyssoise",
    "Crema de zanahoria","Porrusalda","Sopa de marisco","Caldo de pollo casero"
  ];
  const SEGUNDOS = [
    "Pollo al ajillo","Pollo al horno con patatas","Pollo en pepitoria","Pechuga de pollo a la plancha",
    "Escalope de ternera","Filete de ternera a la plancha","Carrilleras al vino tinto","Rabo de toro",
    "Albóndigas en salsa","Lomo adobado","Costillas al horno","Chuletillas de cordero","Cordero asado",
    "Secreto ibérico a la plancha","Solomillo al roquefort","Bacalao a la vizcaína","Bacalao al pil-pil",
    "Merluza en salsa verde","Dorada al horno","Lubina a la sal","Salmón al papillote","Atún encebollado",
    "Calamares en su tinta","Pulpo a la gallega","Paella mixta","Arroz con pollo","Arroz con bogavante",
    "Empanada gallega de atún","Pisto con huevos","Tortilla de patatas","Revuelto de setas","Conejo al ajillo",
    "Codornices escabechadas","Callos a la madrileña","Fabada asturiana","Marmitako de bonito",
    "Chuletón a la plancha","Escabeche de caballa","Bonito con tomate","Trucha a la navarra"
  ];
  const POSTRES = [
    "Flan casero","Natillas caseras","Arroz con leche","Leche frita","Torrijas","Crema catalana",
    "Tarta de queso al horno","Tarta de Santiago","Bizcocho de yogur","Bizcocho de naranja","Magdalenas caseras",
    "Galletas de mantequilla","Rosquillas fritas","Pestiños","Buñuelos de viento","Filloas","Peras al vino",
    "Compota de manzana","Macedonia de frutas","Helado rápido de plátano","Mousse de chocolate","Natillas de vainilla",
    "Tarta de manzana","Tarta tres leches (versión)","Brazo de gitano","Quesada pasiega","Tocino de cielo",
    "Pan de Calatrava","Cuajada con miel","Crepes dulces","Flan de café","Crema pastelera con frutas",
    "Tarta de almendra","Tarta de galletas con chocolate","Bizcocho marmolado","Helado de yogur","Brownie sencillo",
    "Crema de limón","Naranja con canela","Fresas con nata"
  ];

  // Overrides (resumen)
  const OV = (()=> {
    function R(ing, pasos, tiempo){ return {ing, pasos, tiempo}; }
    const CROQ_BASE = ["Leche entera","Harina de trigo","Mantequilla","Aceite de oliva","Cebolla","Nuez moscada","Sal","Pimienta","Huevos","Pan rallado"];
    const CROQ_PASOS = [
      "Pica fino cebolla y el relleno.",
      "Pocha cebolla con aceite y mantequilla 6–8 min sin dorar.",
      "Añade el relleno y rehoga 1–2 min.",
      "Incorpora harina y cocina 2–3 min.",
      "Agrega leche caliente hasta bechamel espesa.",
      "Sazona; cocina 8–10 min suave.",
      "Enfría 4 h.",
      "Forma, reboza y fríe a 175–180 ºC."
    ];
    const M = new Map([
      ["croquetas de jamón", R(["Jamón serrano picado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de pollo", R(["Pollo cocido desmigado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de bacalao", R(["Bacalao desalado desmigado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de setas", R(["Setas picadas",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["patatas bravas", R(["Patatas","Aceite","Sal","Ajo","Pimentón","Tomate triturado","Vinagre"],["Fríe patatas.","Salsa con ajo, pimentón y tomate 10–12 min.","Ajusta vinagre y sirve."],"30–40 min")],
      ["gazpacho andaluz", R(["Tomate","Pepino","Pimiento","Ajo","Pan","AOVE","Vinagre","Sal"],["Tritura con pan.","Emulsiona con aceite.","Ajusta y enfría."],"15–20 min + frío")],
      ["tortilla de patatas", R(["Patatas","Cebolla (opcional)","Huevos","Aceite","Sal"],["Fríe patata suave.","Mezcla con huevo.","Cuaja al gusto."],"25–35 min")]
    ]);
    return { get: (title) => M.get(title.toLowerCase()) || null };
  })();

  const PASOS_BASE = {
    Aperitivo:["Prepara y ten a mano todo.","Corta o dispón los ingredientes.","Sofríe o mezcla hasta aromatizar.","Monta y ajusta sal/aliño.","Reposa 1–2 min o sirve caliente.","Emplata y sirve."],
    Primero:["Lava y prepara verduras.","Sofríe ajo/cebolla suave.","Añade ingrediente principal y rehoga.","Cubre con caldo/agua y cocina.","Ajusta textura (tritura/reposa).","Sirve caliente o frío."],
    Segundo:["Seca la pieza y sala.","Añade adobo/especias.","Dora/hornea/sella bien.","Agrega guarnición/salsa y cocina al punto.","Reposa unos minutos.","Sirve con su jugo."],
    Postre:["Pesa y mide todo.","Mezcla secos y húmedos aparte.","Aromatiza (cítricos/vainilla/canela).","Hornea/refrigera hasta cuajar.","Enfría o reposa.","Decora y sirve."]
  };

  // Utils
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  function stripDiacritics(s){ try{ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch{ return s||""; } }
  const slug = s => stripDiacritics((s||"").toLowerCase()).replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function ingredientesPara(cat,t){
    t=t.toLowerCase(); let ing=[];
    const ov = OV.get(t); if (ov) return ov.ing;
    if(cat==="Aperitivo"){
      if(/empanadill/.test(t)) ing=["Obladas","Atún/carne","Cebolla","Tomate frito","Huevo","Aceite","Sal"];
      else if(/alioli/.test(t)) ing=["Patatas","Ajo","Huevo o leche","Aceite suave","Limón/vinagre","Sal","Perejil"];
      else if(/boquerones/.test(t)) ing=["Boquerones","Vinagre","Ajo","Perejil","Aceite","Sal"];
      else if(/romana|calamar/.test(t)) ing=["Calamares","Harina","Huevo","Aceite","Sal","Limón"];
      else if(/hummus/.test(t)) ing=["Garbanzos","Tahini","Ajo","Limón","Aceite","Sal","Comino"];
      else ing=["Pan/base","Aceite de oliva","Ajo (opcional)","Sal"];
    } else if(cat==="Primero"){
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/sopa|caldo/.test(t)) ing=["Caldo","Ajo/Cebolla","Aceite","Sal"];
      else if(/crema|vichyssoise|porrusalda|zanahoria/.test(t)) ing=["Verdura principal","Cebolla/Puerro","Caldo","Aceite","Sal"];
      else if(/arroz|paella/.test(t)) ing=["Arroz","Caldo","Verduras","Aceite","Sal","Azafrán (opcional)"];
      else if(/fideu/.test(t)) ing=["Fideos","Caldo de pescado","Ajo","Pimentón","Tomate","Aceite","Sal"];
      else if(/ensalada/.test(t)) ing=["Lechuga/legumbre","Tomate","Cebolla","Aceite","Vinagre","Sal"];
    } else if(cat==="Segundo"){
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/pollo/.test(t)) ing=["Pollo","Ajo","Aceite","Sal","Pimienta"];
      else if(/ternera|solomillo|chulet/.test(t)) ing=["Vacuno","Aceite","Sal","Pimienta"];
      else if(/cordero/.test(t)) ing=["Cordero","Ajo","Romero","Aceite","Sal"];
      else if(/secreto|lomo|costillas/.test(t)) ing=["Cerdo","Ajo","Pimentón","Aceite","Sal"];
      else if(/bacalao|merluza|dorada|lubina|trucha|bonito|atun/.test(t)) ing=["Pescado","Aceite","Ajo/Perejil","Sal"];
      else if(/paella|arroz/.test(t)) ing=["Arroz","Caldo","Pollo/Marisco","Pimiento","Tomate","Azafrán","Sal"];
      else if(/tortilla|revuelto/.test(t)) ing=["Huevos","Patata/Setas","Aceite","Sal"];
    } else {
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/flan/.test(t)) ing=["Leche","Huevos","Azúcar","Vainilla","Azúcar para caramelo"];
      else if(/natilla/.test(t)) ing=["Leche","Yemas","Azúcar","Maicena","Vainilla"];
      else if(/arroz con leche/.test(t)) ing=["Arroz","Leche","Azúcar","Canela","Limón"];
      else if(/tarta de queso/.test(t)) ing=["Queso crema","Huevos","Azúcar","Nata","Harina (opcional)"];
      else if(/bizcocho|galleta|magdalena|tarta/.test(t)) ing=["Harina","Azúcar","Huevos","Mantequilla/Aceite","Levadura"];
      else if(/helado|mousse/.test(t)) ing=["Fruta/Yogur/Chocolate","Azúcar","Nata/Leche"];
      else ing=["Azúcar","Leche/Huevos/Harina (según postre)"];
    }
    return Array.from(new Set(ing));
  }

  function tiempo(cat,t){
    const ov=OV.get(t.toLowerCase()); if(ov) return ov.tiempo;
    t=t.toLowerCase();
    if(cat==="Aperitivo") return /croqueta|empanad/.test(t)?"25–35 min":"5–15 min";
    if(cat==="Primero")   return /arroz|fideu|estof|fabada|cocido|marisc/.test(t)?"30–50 min":"15–30 min";
    if(cat==="Segundo")   return /asado|horno|costillas|carrilleras|rabo/.test(t)?"45–90 min":"15–35 min";
    if(cat==="Postre")    return /tarta|horno|tocino|calatrava/.test(t)?"40–70 min":/helado|mousse|frutas/.test(t)?"10–20 min":"20–40 min";
    return "20–30 min";
  }

  function pasosPara(cat,t){ const ov=OV.get(t.toLowerCase()); return ov ? ov.pasos : PASOS_BASE[cat]; }

  function build(cat,list){
    return list.map(n=>({categoria:cat,titulo:n,imagen:IMG(cat),
      ingredientes:ingredientesPara(cat,n), pasos:pasosPara(cat,n), tiempo:tiempo(cat,n)}));
  }

  const RECETAS = [
    ...build("Aperitivo", APERITIVOS),
    ...build("Primero", PRIMEROS),
    ...build("Segundo", SEGUNDOS),
    ...build("Postre", POSTRES)
  ];

  /* ===== Estado + UI ===== */
  const state = {
    q:"", cat:"Todas", list:RECETAS, current:null, step:0,
    dark: matchMedia('(prefers-color-scheme: dark)').matches,
    contrast:false, font:16, listening:false, rate:0.9,
    autoListen:true
  };
  const $ = id => document.getElementById(id);
  const els = {
    grid: $('recipesGrid'), empty: $('emptyState'), count: $('countLabel'), search: $('search'),
    group: $('catGroup'),
    status: $('readerStatus'),
    toggleTheme: $('toggleTheme'), toggleContrast: $('toggleContrast'),
    fontPlus: $('fontPlus'), fontMinus: $('fontMinus'),
    toggleMic: $('toggleMic'), heard: $('heardText'), voiceRate: $('voiceRate'),
    autoListen: $('autoListen'),
    detailModal: $('detailModal'), detailTitle: $('detailTitle'), detailImg: $('detailImg'),
    detailMeta: $('detailMeta'), detailIngredients: $('detailIngredients'), detailSteps: $('detailSteps'),
    btnReadAll: $('btnReadAll'), btnGuided: $('btnGuided'), btnAddAll: $('btnAddAll'),
    guidedModal: $('guidedModal'), gTitle: $('guidedTitle'), gSteps: $('guidedSteps'),
    gProg: $('guidedProgress'), next: $('nextStep'), prev: $('prevStep'),
    rep: $('repeatStep'), stop: $('stopReading'), close: $('closeGuided'), printBtn: $('printRecipe'),
    shoppingDrawer: $('shoppingDrawer'), openShopping: $('openShopping'), closeShopping: $('closeShopping'),
    shoppingList: $('shoppingList'), shoppingEmpty: $('shoppingEmpty'), newItem: $('newItem'),
    addItem: $('addItem'), exportList: $('exportList'), printList: $('printList'), clearChecked: $('clearChecked'),
    caption: $('ttsCaption'), closeDetail: $('closeDetail')
  };

  // Fijar type="button" por si en el futuro añades <form>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('button:not([type])').forEach(b => b.type = 'button');
  });

  // Tema, contraste, fuente
  function applyTheme(){ document.documentElement.classList.toggle('dark', state.dark); }
  function applyContrast(){ document.documentElement.classList.toggle('hc', state.contrast); }
  function setFont(px){ state.font = Math.max(14, Math.min(22, px)); document.documentElement.style.setProperty('--base-font', state.font+'px'); }
  applyTheme(); applyContrast(); setFont(state.font);
  els.toggleTheme.onclick = () => { state.dark = !state.dark; applyTheme(); };
  els.toggleContrast.onclick = () => { state.contrast = !state.contrast; applyContrast(); };
  els.fontPlus.onclick = () => setFont(state.font+1);
  els.fontMinus.onclick = () => setFont(state.font-1);

  // Favoritos
  const FKEY='fav.v1'; let fav = new Set(JSON.parse(localStorage.getItem(FKEY)||'[]'));
  function saveFav(){ try{ localStorage.setItem(FKEY, JSON.stringify([...fav])); }catch{} }
  function isFav(r){ return fav.has(r.titulo); }
  function toggleFav(r){ isFav(r) ? fav.delete(r.titulo) : fav.add(r.titulo); saveFav(); filter(); }

  // Tarjeta
  function card(r,i){
    const star = isFav(r) ? '⭐' : '☆';
    const el = document.createElement('article');
    el.className = 'card';
    el.setAttribute('role','article');
    el.setAttribute('aria-label', r.titulo);
    el.innerHTML = `
      <img src="${r.imagen}" alt="Foto ilustrativa de ${r.titulo}" class="card-img" loading="lazy" decoding="async" width="800" height="500">
      <div class="p-3">
        <h3 class="text-lg font-semibold">${r.titulo}</h3>
        <p class="muted">${r.categoria} · ${r.tiempo}</p>
        <div class="btn-row">
          <button class="btn btn-ghost" data-a="leer"  data-i="${i}" aria-label="Leer ${r.titulo} en voz alta" title="Leer"    type="button">🔈 Leer</button>
          <button class="btn btn-primary" data-a="guiada" data-i="${i}" aria-label="Cocina guiada para ${r.titulo}" title="Guiada" type="button">▶️ Guiada</button>
          <button class="btn btn-ghost" data-a="abrir" data-i="${i}" aria-label="Abrir detalles de ${r.titulo}" title="Abrir"      type="button">📖 Abrir</button>
          <button class="btn btn-ghost" data-a="lista" data-i="${i}" aria-label="Añadir ingredientes de ${r.titulo} a la lista" title="Añadir a lista" type="button">🧺 Añadir</button>
          <button class="btn btn-ghost" data-a="fav"   data-i="${i}" aria-pressed="${isFav(r)?'true':'false'}" aria-label="Marcar favorito" title="Favorito" type="button">${star} Favorito</button>
        </div>
      </div>`;
    return el;
  }

  // Render
  function render(list){
    state.list = list;
    if(!list.length){
      els.grid.replaceChildren();
      els.empty.classList.remove('hidden');
      els.count.textContent = "Mostrando 0 recetas.";
      return;
    }
    els.empty.classList.add('hidden');
    const frag = document.createDocumentFragment();
    list.forEach((r,i)=> frag.appendChild(card(r,i)));
    els.grid.replaceChildren(frag);
    els.count.textContent = `Mostrando ${list.length} recetas.`;
    try{ injectListLD(list); }catch{}
  }

  // Filtro
  function filter(){
    const q = state.q.toLowerCase().trim();
    const lAll = RECETAS.filter(r =>
      (state.cat==="Todas" || r.categoria===state.cat || (state.cat==="Favoritas" && isFav(r))) &&
      (!q || [r.titulo, ...r.ingredientes, ...r.pasos].join(" ").toLowerCase().includes(q))
    );
    render(lAll);
  }

  // Tabs (radiogroup accesible)
  function tabButtons(){ return [...els.group.querySelectorAll('[role="radio"]')]; }
  function setActiveTabBtn(btn){
    tabButtons().forEach(b => b.setAttribute('aria-checked', b===btn ? 'true':'false'));
    state.cat = btn.dataset.cat;
    filter();
    btn.focus();
  }
  tabButtons().forEach(b => b.addEventListener('click', () => setActiveTabBtn(b)));
  els.group.addEventListener('keydown', (e) => {
    if(!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
    e.preventDefault();
    const btns = tabButtons(); const i = btns.findIndex(b => b.getAttribute('aria-checked')==='true');
    const next = e.key==='ArrowLeft' ? (i-1+btns.length)%btns.length
                : e.key==='Home' ? 0
                : e.key==='End' ? btns.length-1
                : (i+1)%btns.length;
    setActiveTabBtn(btns[next]);
  });

  // Eventos búsqueda/atajo
  els.search.oninput = e => { state.q = e.target.value; filter(); };
  document.addEventListener('keydown', e => { if(e.ctrlKey && e.key === '/'){ e.preventDefault(); els.search.focus(); } });

  // Render seguro en detalle
  function listTo(ul, items){
    ul.replaceChildren(...(items||[]).map(text => { const li = document.createElement('li'); li.textContent = text; return li; }));
  }
  function openDetail(r){
    state.current = r;
    els.detailTitle.textContent = r.titulo;
    els.detailImg.src = r.imagen;
    els.detailImg.alt = `Foto de ${r.titulo}`;
    els.detailMeta.textContent = `${r.categoria} · ${r.tiempo}`;
    listTo(els.detailIngredients, r.ingredientes);
    listTo(els.detailSteps, r.pasos);
    els.detailModal.classList.remove('hidden');
    injectRecipeLD(r);
    if(untrapDetail) untrapDetail(); untrapDetail = trapFocus(els.detailModal);
  }
  function closeDetail(){ els.detailModal.classList.add('hidden'); if(untrapDetail) untrapDetail(); }
  els.closeDetail.onclick = closeDetail;
  $('detailModal').addEventListener('click', e => { if(e.target.id==='detailModal') closeDetail(); });

  /* ===== TTS ===== */
  let ttsVoice = null, voicesReady = false;
  function pickVoice(){
    const vs = speechSynthesis.getVoices();
    voicesReady = vs && vs.length>0;
    ttsVoice = vs.find(v=>/Spanish.*(Spain)|es[-_]ES/i.test(v.name+v.lang))
             || vs.find(v=>/Spanish|es[-_]/i.test(v.name+v.lang))
             || vs[0] || null;
  }
  if('speechSynthesis' in window){
    try{ pickVoice(); speechSynthesis.onvoiceschanged = pickVoice; }catch{}
  }
  els.voiceRate.onchange = e => { state.rate = Number(e.target.value) || 0.9; };

  function unlockTTSOnce(){
    if (!('speechSynthesis' in window) || unlockTTSOnce.done) return;
    try{ speechSynthesis.cancel(); speechSynthesis.resume(); }catch{}
    const u = new SpeechSynthesisUtterance(' ');
    try{ speechSynthesis.speak(u);}catch{} try{ speechSynthesis.cancel(); }catch{}
    unlockTTSOnce.done = true;
    document.removeEventListener('touchend', unlockTTSOnce);
    document.removeEventListener('click', unlockTTSOnce);
  }
  document.addEventListener('touchend', unlockTTSOnce, {passive:true});
  document.addEventListener('click', unlockTTSOnce, {once:true});

  let speakLock=false;
  function stopSpeak(){ try{ speechSynthesis.cancel(); }catch{} }
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  async function speakSafe(text){
    if(!('speechSynthesis' in window)) return;
    while(speakLock) await sleep(20);
    speakLock = true;
    if(!voicesReady){ try{ pickVoice(); }catch{} }
    stopSpeak(); await sleep(80);
    const u = new SpeechSynthesisUtterance(text);
    if(ttsVoice) u.voice = ttsVoice;
    u.lang = (ttsVoice && ttsVoice.lang) || 'es-ES';
    u.rate = state.rate; u.pitch = 1.0;
    const cap = $('ttsCaption');
    if(cap){
      u.onstart = ()=>{ cap.textContent = text; cap.classList.add('show'); };
      u.onend   = ()=>{ cap.classList.remove('show'); cap.textContent=''; };
    }
    const done = new Promise(res=>{ const end=()=>{ speakLock=false; res(); }; u.onend=end; u.onerror=end; });
    try{ speechSynthesis.speak(u); }catch{ speakLock=false; }
    await done;
  }

  function readRecipe(r){
    const intro = `${r.titulo}. ${r.categoria}. Tiempo ${r.tiempo}.`;
    const ing = r.ingredientes?.length ? `Ingredientes: ${r.ingredientes.join(", ")}.` : "";
    const pasos = r.pasos?.length ? `Pasos: ${r.pasos.map((p,i)=>`Paso ${i+1}: ${p}.`).join(" ")}` : "";
    speakSafe([intro,ing,pasos].filter(Boolean).join(" "));
    els.status.textContent = `Leyendo ${r.titulo}.`;
  }

  /* ===== Guiado + Temporizador ===== */
  function ensureCurrent(){
    if(!state.current){
      const primera = (state.list && state.list[0]) || null;
      if(!primera){ els.status.textContent="Abre una receta y pulsa ‘Guiada’."; return false; }
      state.current = primera; state.step = 0;
    }
    return true;
  }
  function openGuided(r){
    state.current = r; state.step = 0;
    $('guidedRecipeTitle').textContent = r.titulo;
    listTo($('guidedSteps'), r.pasos.map(p=>p));
    $('guidedModal').classList.remove('hidden');
    if(untrapGuided) untrapGuided(); untrapGuided = trapFocus(els.guidedModal);
    els.status.textContent = "Voz manos libres activa.";
    speakSafe(`Iniciamos ${r.titulo}. Di: siguiente, anterior, repetir, leer ingredientes o salir.`);
    readCurrent();
    saveSession();
    if(state.autoListen) startAutoRecognizer();
  }
  function closeGuided(){
    stopSpeak();
    $('guidedModal').classList.add('hidden');
    els.status.textContent="Cocina guiada cerrada.";
    if(untrapGuided) untrapGuided();
    stopAutoRecognizer();
    saveSession();
  }
  function readCurrent(){
    if(!ensureCurrent()) return;
    const pasos = state.current.pasos || []; if(!pasos.length) return;
    if(state.step<0) state.step=0; if(state.step>=pasos.length) state.step=pasos.length-1;
    speakSafe(`Paso ${state.step+1}. ${pasos[state.step]}`);
    const t = pasos.length; $('guidedProgress').textContent = `Paso ${state.step+1} de ${t}`;
    [...$('guidedSteps').children].forEach((li,i)=>li.style.fontWeight = (i===state.step?'700':'400'));

    clearTimerUI();
    try{
      const p = state.current?.pasos?.[state.step] || "";
      const m = /(\d{1,2})\s*(?:min|mins|minutos)\b/i.exec(p);
      if(m){ const mins = Number(m[1]); if(mins>0){ speakSafe(`Inicio temporizador de ${mins} minutos.`); startStepTimer(mins); } }
    }catch{}
  }
  async function nextStep(){
    if(!ensureCurrent()) return;
    const t = (state.current.pasos||[]).length;
    if(state.step < t-1){ state.step++; stopSpeak(); await sleep(60); readCurrent(); saveSession(); }
    else { stopSpeak(); await sleep(60); speakSafe("Receta terminada. ¡Buen provecho!"); saveSession(); }
  }
  async function prevStep(){
    if(!ensureCurrent()) return;
    if(state.step>0){ state.step--; stopSpeak(); await sleep(60); readCurrent(); saveSession(); }
    else { stopSpeak(); await sleep(60); speakSafe("Ya estás en el primer paso."); }
  }
  function repeatStep(){ stopSpeak(); setTimeout(readCurrent,80); }
  function readIngredients(){
    if(!ensureCurrent()) return;
    const ing = state.current?.ingredientes || [];
    stopSpeak();
    setTimeout(()=>speakSafe(ing.length?("Ingredientes: "+ing.join(", ")):"No hay ingredientes listados."),80);
  }
  function goToStep(n){
    const total = state?.current?.pasos?.length || 0;
    if(n>=0 && n<total){ state.step=n; stopSpeak(); setTimeout(readCurrent,80); saveSession(); }
    else { stopSpeak(); setTimeout(()=>speakSafe("Ese número de paso no existe."),80); }
  }
  $('nextStep').onclick = nextStep; $('prevStep').onclick = prevStep; $('repeatStep').onclick = repeatStep;
  $('stopReading').onclick = ()=>{ stopSpeak(); }; $('closeGuided').onclick = closeGuided;
  $('printRecipe').onclick = ()=>{ window.print(); };

  els.btnReadAll.onclick = ()=>{ if(state.current) readRecipe(state.current); };
  els.btnGuided.onclick = ()=>{ if(state.current) openGuided(state.current); };
  els.btnAddAll.onclick = ()=>{ if(state.current) addMany(state.current.ingredientes||[]); };

  els.grid.addEventListener('click',e=>{
    const b = e.target.closest('button[data-a]'); if(!b) return;
    const r = state.list[Number(b.dataset.i)]; if(!r) return;
    if(b.dataset.a==='leer'){ openDetail(r); readRecipe(r); }
    if(b.dataset.a==='guiada'){ openDetail(r); openGuided(r); }
    if(b.dataset.a==='abrir'){ openDetail(r); }
    if(b.dataset.a==='lista') addMany(r.ingredientes||[]);
    if(b.dataset.a==='fav'){ toggleFav(r); b.setAttribute('aria-pressed', isFav(r)?'true':'false'); b.innerHTML = (isFav(r)?'⭐':'☆') + ' Favorito'; }
  });

  document.addEventListener('keydown',e=>{
    const gmVisible = !$('guidedModal').classList.contains('hidden');
    if(!gmVisible) return;
    if(e.key===' '||e.key==='ArrowRight'){ e.preventDefault(); nextStep(); }
    if(e.key==='ArrowLeft'){ e.preventDefault(); prevStep(); }
    if(e.key==='r'||e.key==='R'){ e.preventDefault(); repeatStep(); }
    if(e.key==='Escape'){ e.preventDefault(); closeGuided(); closeDetail(); }
  });

  /* ===== Lista de la compra ===== */
  const SKEY='shopping.v1'; let shopping=JSON.parse(localStorage.getItem(SKEY)||'[]');
  function save(){ localStorage.setItem(SKEY, JSON.stringify(shopping)); }
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function renderList(){
    $('shoppingList').replaceChildren(...shopping.map(i=>{
      const li=document.createElement('li'); li.className='shopping-item';
      li.innerHTML = `
        <input type="checkbox" ${i.done?'checked':''} data-a="t" data-id="${i.id}" aria-label="Marcar ${i.text}" title="Marcar ${i.text}">
        <input type="text" value="${i.text.replace(/"/g,'&quot;')}" class="shopping-input" data-a="e" data-id="${i.id}" aria-label="Editar ${i.text}" title="Editar ${i.text}">
        <button class="btn btn-ghost" data-a="d" data-id="${i.id}" aria-label="Eliminar ${i.text}" title="Eliminar ${i.text}" type="button">🗑️</button>`;
      return li;
    }));
    $('shoppingEmpty').classList.toggle('hidden', shopping.length>0);
  }
  function addItem(text){ text=(text||"").trim(); if(!text) return; shopping.push({id:uid(),text,done:false}); save(); renderList(); }
  function addMany(arr){ (arr||[]).forEach(addItem); openDrawer(); }
  function openDrawer(){ $('shoppingDrawer').classList.add('open'); $('shoppingDrawer').setAttribute('aria-hidden','false'); }
  function closeDrawer(){ $('shoppingDrawer').classList.remove('open'); $('shoppingDrawer').setAttribute('aria-hidden','true'); }
  els.openShopping.onclick = openDrawer; els.closeShopping.onclick = closeDrawer;
  els.addItem.onclick = ()=>{ addItem(els.newItem.value); els.newItem.value=""; els.newItem.focus(); };
  els.newItem.onkeydown = e=>{ if(e.key==='Enter'){ e.preventDefault(); els.addItem.click(); } };
  $('shoppingList').addEventListener('click',e=>{
    const b=e.target.closest('button[data-a="d"]'); if(!b) return;
    shopping = shopping.filter(x=>x.id!==b.dataset.id); save(); renderList();
  });
  $('shoppingList').addEventListener('change',e=>{
    const c=e.target.closest('input[type="checkbox"][data-a="t"]'); if(!c) return;
    const it=shopping.find(x=>x.id===c.dataset.id); if(it){ it.done=c.checked; save(); }
  });
  $('shoppingList').addEventListener('input',e=>{
    const t=e.target.closest('input[type="text"][data-a="e"]'); if(!t) return;
    const it=shopping.find(x=>x.id===t.dataset.id); if(it){ it.text=t.value; save(); }
  });
  els.clearChecked.onclick = ()=>{ shopping = shopping.filter(i=>!i.done); save(); renderList(); };
  els.exportList.onclick = ()=>{
    const data = shopping.map(i=>`${i.done?'[x]':'[ ]'} ${i.text}`).join('\n');
    const a=document.createElement('a');
    a.href = URL.createObjectURL(new Blob([data],{type:'text/plain'}));
    a.download='lista_compra.txt'; a.click();
  };
  els.printList.onclick = ()=>{
    const w = window.open('','_blank');
    w.document.write(`<pre>${shopping.map(i=>`${i.done?'[x]':'[ ]'} ${i.text}`).join('\n')}</pre>`);
    w.document.close(); w.print(); setTimeout(()=>w.close(),300);
  };

  /* ===== Temporizadores por paso ===== */
  let currentTimer = null, countdownInt = null;
  function clearTimerUI(){
    if(countdownInt) { clearInterval(countdownInt); countdownInt = null; }
    const old = document.getElementById('guidedTimer');
    if(old) old.remove();
  }
  function beep(ms=200, freq=880){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ctx.createOscillator(); const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq; osc.start();
      setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
    }catch{}
  }
  function startStepTimer(minutes){
    clearTimerUI();
    if(currentTimer) { clearTimeout(currentTimer); currentTimer = null; }
    const box = document.createElement('div');
    box.id='guidedTimer'; box.className='mt-3 text-sm';
    box.innerHTML = `<span>⏱️ Temporizador: <strong id="tleft"></strong></span>
      <button class="btn btn-ghost" id="cancelTimer" aria-label="Cancelar temporizador" title="Cancelar temporizador" type="button">Cancelar</button>`;
    document.querySelector('#guidedModal .modal-body-col').appendChild(box);

    let left = Math.round(minutes*60);
    const $left = document.getElementById('tleft');
    const fmt = s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
    $left.textContent = fmt(left);

    countdownInt = setInterval(()=>{ left--; $left.textContent = fmt(Math.max(0,left)); }, 1000);
    currentTimer = setTimeout(()=>{ clearTimerUI(); beep(300); speakSafe("¡Tiempo!"); }, minutes*60*1000);
    document.getElementById('cancelTimer').onclick = ()=>{ clearTimerUI(); if(currentTimer){ clearTimeout(currentTimer); currentTimer=null; } };
  }

  /* ===== JSON-LD (SEO) ===== */
  function toISO8601Duration(texto=""){
    const m = /(\d{1,3})\s*[–-]\s*(\d{1,3})\s*min/i.exec(texto) || /(\d{1,3})\s*min/i.exec(texto);
    const mins = m ? (m[2] ? Math.round((+m[1]+ +m[2])/2) : +m[1]) : 30;
    return `PT${Math.max(1,Math.min(600, mins))}M`;
  }
  function injectRecipeLD(r){
    const ld = {
      "@context":"https://schema.org",
      "@type":"Recipe",
      "name": r.titulo,
      "recipeCategory": r.categoria,
      "image": r.imagen,
      "recipeIngredient": r.ingredientes,
      "recipeInstructions": (r.pasos||[]).map(p=>({"@type":"HowToStep","text":p})),
      "totalTime": toISO8601Duration(r.tiempo)
    };
    let n = document.getElementById("ld-recipe");
    if(!n){ n=document.createElement("script"); n.type="application/ld+json"; n.id="ld-recipe"; document.head.appendChild(n); }
    n.textContent = JSON.stringify(ld);
  }
  function injectListLD(list){
    const items = (list||[]).slice(0,50).map((r,i)=>({
      "@type":"ListItem","position":i+1,"name":r.titulo,"url": location.origin + location.pathname + '#receta=' + slug(r.titulo)
    }));
    const ld = {"@context":"https://schema.org","@type":"ItemList","itemListElement":items};
    let n = document.getElementById("ld-list");
    if(!n){ n=document.createElement("script"); n.type="application/ld+json"; n.id="ld-list"; document.head.appendChild(n); }
    n.textContent = JSON.stringify(ld);
  }

  /* ===== Focus trap ===== */
  function trapFocus(modal){
    const sel = 'a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])';
    const f = modal.querySelectorAll(sel); if(!f.length) return ()=>{};
    const first = f[0], last = f[f.length-1];
    function onKey(e){
      if(e.key!=='Tab') return;
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
    modal.addEventListener('keydown', onKey);
    first.focus();
    return ()=> modal.removeEventListener('keydown', onKey);
  }
  let untrapDetail = null, untrapGuided = null;

  /* ===== Compartir ===== */
  $('btnShare').onclick = async ()=>{
    if(!state.current) return;
    const url = location.origin + location.pathname + '#receta=' + slug(state.current.titulo);
    if(navigator.share){
      try{ await navigator.share({ title: state.current.titulo, text: 'Receta', url }); }catch{}
    }else{
      try{ await navigator.clipboard.writeText(url);}catch{}
      alert('Enlace copiado: ' + url);
    }
  };

  /* ===== STT manos libres ===== */
  const SRClass = (!isIOS) && (window.SpeechRecognition||window.webkitSpeechRecognition)
                ? (window.SpeechRecognition||window.webkitSpeechRecognition) : null;

  let recAuto = null;
  let autoRestartTimer = null;

  function setStatus(msg){ els.status.textContent = msg; }
  function norm(s){ try{ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch{return (s||"").toLowerCase().trim();} }

  const bar = document.querySelector('#voiceWave > i');
  function drawLevel(w){ if(!bar) return; const px=Math.max(4,Math.min(138,Math.round(w*138))); bar.style.width=px+'px'; }

  // Levenshtein light
  function lev(a,b){
    const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
    const dp=new Array(n+1).fill(0); for(let j=0;j<=n;j++) dp[j]=j;
    for(let i=1;i<=m;i++){ let prev=dp[0], tmp; dp[0]=i; for(let j=1;j<=n;j++){
      tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev + (a[i-1]===b[j-1]?0:1)); prev=tmp;
    }}
    return dp[n];
  }

  const CMD_LIST = [
    {type:'next', variants:['siguiente','proximo','avanza','adelante','continuar']},
    {type:'prev', variants:['anterior','atras','retroceder']},
    {type:'repeat', variants:['repetir','otra vez','de nuevo','repite']},
    {type:'ingredients', variants:['leer ingredientes','ingredientes','leer lista']},
    {type:'stop', variants:['salir','parar','detener','cerrar']}
  ];
  const NUM = {uno:1,una:1,dos:2,tres:3,cuatro:4,cinco:5,seis:6,siete:7,ocho:8,nueve:9,diez:10,once:11,doce:12,trece:13,catorce:14,quince:15,dieciseis:16,diecisiete:17,dieciocho:18,diecinueve:19,veinte:20};

  function parseCommand(raw){
    const t = norm(raw).replace(/\bpaso\s+(uno|una|dos|tres|cuatro|cinco|seis|siete|ocho|nueve|diez|once|doce|trece|catorce|quince|dieciseis|diecisiete|dieciocho|diecinueve|veinte)\b/g,
                                (_,w)=>'paso '+NUM[w]);
    const m = t.match(/\bpaso\s+(\d{1,2})\b/); if(m) return {type:'goto', n:+m[1]};
    for(const c of CMD_LIST) for(const v of c.variants) if(t===v) return {type:c.type};
    let best=99, winner={type:'unknown'};
    for(const c of CMD_LIST){ for(const v of c.variants){ const d=lev(t,v); if(d<best){ best=d; winner={type:c.type}; } } }
    return best<=2 ? winner : {type:'unknown', raw:raw};
  }

  function startAutoRecognizer(){
    const hud=document.getElementById('voiceHUD');
    if(!SRClass){
      setStatus(isIOS ? "Voz: iPhone/iPad no permite reconocimiento web. Usa botones." : "Voz: reconocimiento no disponible.");
      hud?.classList.add('disabled');
      return;
    }
    if(recAuto) { try{recAuto.stop();}catch{} recAuto=null; }
    const r=new SRClass(); recAuto=r;
    r.lang='es-ES'; r.continuous=true; r.interimResults=true; r.maxAlternatives=4;

    r.onstart = ()=>{ setStatus("🎙️ Escuchando… (manos libres)"); hud?.classList.add('listening'); };
    r.onerror = e => { setStatus("Voz: " + (e.error||'error')); scheduleRestart(); };
    r.onend   = ()=> { setStatus("Voz detenida. Intentando reanudar…"); scheduleRestart(); };
    r.onresult = ev => {
      let finalText = "";
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        const res=ev.results[i];
        const txt=res[0]?.transcript||'';
        if(res.isFinal) finalText += txt + " ";
        els.heard && (els.heard.textContent=(res.isFinal?"✓ ":"… ")+txt);
        drawLevel(Math.min(1, (txt||'').length/30));
        document.getElementById('voiceHUD')?.classList.toggle('talking', (txt||'').length>5);
      }
      if(finalText.trim()){
        const cmd = parseCommand(finalText.trim());
        if(cmd.type==='stop') return closeGuided();
        if(cmd.type==='repeat') return repeatStep();
        if(cmd.type==='next') return nextStep();
        if(cmd.type==='prev') return prevStep();
        if(cmd.type==='ingredients') return readIngredients();
        if(cmd.type==='goto') return goToStep(Math.max(0,(cmd.n||1)-1));
      }
    };

    try{ r.start(); }catch{ setStatus("Voz: permiso requerido. Pulsa “Reconectar voz”."); }
  }
  function stopAutoRecognizer(){
    if(autoRestartTimer){ clearTimeout(autoRestartTimer); autoRestartTimer=null; }
    if(recAuto){ try{recAuto.onresult=recAuto.onend=recAuto.onerror=null; recAuto.stop(); }catch{} recAuto=null; }
    const hud=document.getElementById('voiceHUD'); hud?.classList.remove('listening','talking'); drawLevel(0);
  }
  function scheduleRestart(){ if(!state.autoListen) return; if(autoRestartTimer){ clearTimeout(autoRestartTimer); } autoRestartTimer = setTimeout(()=>{ try{ recAuto && recAuto.start(); }catch{} }, 600); }
  els.autoListen.onchange = (e)=>{ state.autoListen = !!e.target.checked; if(state.autoListen && !recAuto){ startAutoRecognizer(); } if(!state.autoListen){ stopAutoRecognizer(); } };
  els.toggleMic.onclick = ()=>{ stopAutoRecognizer(); startAutoRecognizer(); };

  /* ===== Reanudar sesión, deep-link ===== */
  const SKEY_SESSION = "session.v1";
  function saveSession(){ try{ if(!state.current) return; localStorage.setItem(SKEY_SESSION, JSON.stringify({ slug: slug(state.current.titulo), step: state.step||0 })); }catch{} }
  function loadSession(){
    try{
      const raw = localStorage.getItem(SKEY_SESSION);
      if(!raw) return null;
      const d = JSON.parse(raw);
      const r = RECETAS.find(x => slug(x.titulo) === d.slug);
      return r ? {recipe:r, step:Math.max(0, Math.min((r.pasos||[]).length-1, d.step||0))} : null;
    }catch{ return null; }
  }
  function fromHashOpen(){
    const m = location.hash.match(/#receta=([a-z0-9\-]+)/i);
    if(!m) return;
    const r = RECETAS.find(x=>slug(x.titulo)===m[1]);
    if(r) openDetail(r);
  }
  window.addEventListener('popstate', fromHashOpen);
  document.addEventListener('DOMContentLoaded', fromHashOpen);

  /* ===== Inicial ===== */
  function initialRender(){ render(RECETAS); renderList(); }
  document.addEventListener('DOMContentLoaded', ()=>{
    initialRender();
    const last = loadSession();
    if(last && confirm(`¿Reanudar "${last.recipe.titulo}" en el paso ${last.step+1}?`)){
      openDetail(last.recipe);
      openGuided(last.recipe);
      state.step = last.step;
      readCurrent();
    }
  });

  // Registro SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").then(reg => {
      reg.addEventListener("updatefound", () => {
        const nw = reg.installing;
        nw?.addEventListener("statechange", () => {
          if (nw.state === "installed" && navigator.serviceWorker.controller) {
            if (confirm("Hay una actualización disponible. ¿Actualizar ahora?")) location.reload();
          }
        });
      });
    }).catch(()=>{});
  }
  </script>
</body>
</html>
