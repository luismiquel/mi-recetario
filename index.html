<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Recetario Español – 160 recetas</title>

  <!-- theme-color (Firefox puede mostrar aviso informativo) -->
  <meta name="theme-color" content="#78350f" />
  <meta name="theme-color" content="#78350f" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b0f19" media="(prefers-color-scheme: dark)">

  <link rel="manifest" href="./manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- ✅ Tailwind compilado (sin CDN) -->
  <link rel="stylesheet" href="./styles.css">

  <!-- Reglas propias (NO poner text-size-adjust aquí; ya va en styles.css) -->
  <style>
    :root{ --base-font:16px; }
    html{ font-size: var(--base-font); }
    body{ -webkit-tap-highlight-color: transparent; }
    /* Foco visible */
    *:focus { outline: 3px solid #4f46e5; outline-offset: 2px; }

    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:1rem;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#92400e;color:#fff}.btn-primary:active{transform:scale(.98)}
    .btn-ghost{background:transparent}.btn-ghost:active{transform:scale(.98)}
    .tab{padding:.5rem .75rem;border-radius:.75rem;font-size:.9rem;font-weight:700}
    .tab[aria-selected="true"]{background:#92400e;color:#fff}
    .card{border-radius:1rem;border:1px solid rgba(120,113,108,.25);overflow:hidden;background:#fff}
    .dark .card{background:#1f2937;border-color:#374151}
    .hc *{ color:#000 !important; background:#fff !important; }
    .hc .tab[aria-selected="true"]{ background:#000 !important; color:#fff !important; }
    .drawer{position:fixed;top:env(safe-area-inset-top,0);right:0;bottom:0;width:380px;max-width:100%;background:#fff;color:#111;box-shadow:-4px 0 20px rgba(0,0,0,.2);transform:translateX(100%);transition:.25s;z-index:60}
    .dark .drawer{background:#111827;color:#e5e7eb}
    .drawer.open{transform:translateX(0)}
    .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip-link:focus{left:1rem;top:1rem;width:auto;height:auto;padding:.5rem .75rem;background:#fff;color:#111;border-radius:.5rem;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    #ttsCaption{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom,0);margin:0 auto;max-width:700px;background:rgba(17,24,39,.92);color:#fff;border-radius:12px 12px 0 0;padding:.6rem .8rem;font-size:.95rem;line-height:1.35;z-index:70;display:none}
    #ttsCaption.show{display:block}
    @media print{header,.no-print,#shoppingDrawer,#ttsCaption{display:none!important}}

    /* Fallback de scrollbars para Safari/Chromium (compat) */
    *::-webkit-scrollbar{ width:12px; height:12px }
    *::-webkit-scrollbar-thumb{ background-color: rgba(120,113,108,.5); border-radius: 8px }
    *::-webkit-scrollbar-track{ background: transparent }
  </style>
</head>
<body class="dark:bg-stone-900 dark:text-stone-200">
  <a href="#main" class="skip-link">Saltar al contenido principal</a>

  <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4" id="app">
    <header class="flex items-center justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold">Recetario Español – 160 recetas</h1>
        <p class="text-sm text-stone-600 dark:text-stone-400">Voz clara · Contraste · Letra grande · Lista de compra.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggleTheme" class="btn btn-ghost" title="Cambiar tema" aria-label="Cambiar tema">🌙/☀️</button>
        <button id="toggleContrast" class="btn btn-ghost" title="Alto contraste" aria-label="Alto contraste">🌓</button>
        <button id="fontMinus" class="btn btn-ghost" title="Reducir letra" aria-label="Reducir letra">A−</button>
        <button id="fontPlus" class="btn btn-ghost" title="Aumentar letra" aria-label="Aumentar letra">A+</button>
        <button id="openShopping" class="btn btn-ghost" title="Abrir lista de la compra" aria-label="Lista de la compra">🧺</button>
      </div>
    </header>

    <section class="card p-4 mb-4" aria-label="Búsqueda y filtros">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
        <div class="flex-1">
          <label for="search" class="block text-sm font-medium mb-1">Buscar</label>
          <input id="search" type="search" inputmode="search" placeholder="Nombre, ingrediente… (Ctrl+/)"
                 class="w-full rounded-xl border border-stone-300 dark:border-stone-700 bg-white dark:bg-stone-900 px-3 py-2" />
        </div>
        <!-- Tabs accesibles -->
        <div class="flex items-center gap-2" role="tablist" aria-label="Categorías">
          <button class="tab" role="tab" id="tab-todas" aria-selected="true" aria-controls="panel-todas" data-cat="Todas" title="Mostrar todas">Todas</button>
          <button class="tab" role="tab" id="tab-aperitivo" aria-selected="false" aria-controls="panel-aperitivo" data-cat="Aperitivo" title="Mostrar aperitivos">Aperitivos</button>
          <button class="tab" role="tab" id="tab-primero" aria-selected="false" aria-controls="panel-primero" data-cat="Primero" title="Mostrar primeros">Primeros</button>
          <button class="tab" role="tab" id="tab-segundo" aria-selected="false" aria-controls="panel-segundo" data-cat="Segundo" title="Mostrar segundos">Segundos</button>
          <button class="tab" role="tab" id="tab-postre" aria-selected="false" aria-controls="panel-postre" data-cat="Postre" title="Mostrar postres">Postres</button>
          <!-- Favoritas se añade por JS -->
        </div>
        <div class="flex items-end gap-2">
          <label class="text-sm" for="voiceRate">Voz:</label>
          <select id="voiceRate" class="rounded-lg border px-2 py-1 dark:bg-stone-900 dark:border-stone-700" aria-label="Velocidad de lectura en voz alta">
            <option value="0.8">Lenta</option>
            <option value="0.9" selected>Clara</option>
            <option value="1.0">Normal</option>
          </select>
          <button id="toggleMic" class="btn btn-primary" title="Mantén pulsado para hablar" aria-label="Mantén pulsado para hablar">🎤 Micro (mantén pulsado)</button>
        </div>
      </div>
      <div id="readerStatus" class="text-xs text-stone-500 mt-2" aria-live="polite"></div>
      <div id="heard" class="text-xs mt-1 text-stone-500">🎧 Oído: <span id="heardText">—</span></div>
    </section>

    <section class="mb-2 text-sm text-stone-600 dark:text-stone-400">
      <span id="countLabel">Mostrando 0 recetas.</span>
    </section>

    <main id="main" aria-labelledby="countLabel">
      <div id="recipesGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4" role="region" aria-label="Listado de recetas"></div>
      <div id="emptyState" class="hidden text-center text-stone-600 dark:text-stone-400 mt-10">No hay resultados.</div>
    </main>

    <!-- Modal Detalle -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 no-print" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="card max-w-3xl w-full">
        <div class="p-3 border-b border-stone-200 dark:border-stone-700 flex items-center justify-between">
          <h3 id="detailTitle" class="text-xl font-semibold">Detalle</h3>
          <button id="closeDetail" class="btn btn-ghost" aria-label="Cerrar detalle" title="Cerrar">✕</button>
        </div>
        <div class="p-4 grid gap-4 md:grid-cols-2">
          <div>
            <img id="detailImg" src="" alt="" class="w-full h-48 object-cover rounded-lg" loading="lazy" width="800" height="500">
            <p id="detailMeta" class="mt-2 text-sm text-stone-600 dark:text-stone-400"></p>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="btnReadAll" class="btn btn-ghost" aria-label="Leer receta en voz alta" title="Leer receta">🔈 Leer</button>
              <button id="btnGuided" class="btn btn-primary" aria-label="Iniciar cocina guiada" title="Cocina guiada">▶️ Guiada</button>
              <button id="btnAddAll" class="btn btn-ghost" aria-label="Añadir todos los ingredientes a la lista" title="Añadir ingredientes">🧺 Añadir todo</button>
              <!-- El botón Compartir se añade por JS -->
            </div>
          </div>
          <div>
            <h4 class="text-lg font-semibold">Ingredientes</h4>
            <ul id="detailIngredients" class="list-disc pl-6 mt-2"></ul>
            <h4 class="text-lg font-semibold mt-4">Pasos</h4>
            <ol id="detailSteps" class="list-decimal pl-6 mt-2"></ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Guiada -->
    <div id="guidedModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 no-print" role="dialog" aria-modal="true" aria-labelledby="guidedTitle">
      <div class="card max-w-2xl w-full">
        <div class="p-3 border-b border-stone-200 dark:border-stone-700 flex items-center justify-between">
          <h3 id="guidedTitle" class="text-xl font-semibold">Cocina guiada</h3>
          <button id="closeGuided" class="btn btn-ghost" aria-label="Cerrar cocina guiada" title="Cerrar">✕</button>
        </div>
        <div class="p-4 space-y-4">
          <p class="text-sm text-stone-600 dark:text-stone-400">Pulsa y mantén el botón de micrófono para hablar. Prueba: “siguiente”, “anterior”, “repetir”, “leer ingredientes”, “paso 2”, “salir”.</p>
          <div class="bg-stone-50 dark:bg-stone-900 rounded-xl p-4">
            <h4 id="guidedRecipeTitle" class="text-lg font-semibold mb-2"></h4>
            <ol id="guidedSteps" class="list-decimal pl-5 space-y-2"></ol>
          </div>
          <div class="flex items-center justify-between">
            <div class="text-xs text-stone-500" id="guidedProgress" aria-live="polite"></div>
            <div class="flex gap-2">
              <button id="prevStep" class="btn btn-ghost" aria-label="Paso anterior" title="Anterior">← Anterior</button>
              <button id="repeatStep" class="btn btn-ghost" aria-label="Repetir paso" title="Repetir">⟲ Repetir</button>
              <button id="nextStep" class="btn btn-primary" aria-label="Paso siguiente" title="Siguiente">Siguiente →</button>
              <button id="stopReading" class="btn btn-ghost" aria-label="Parar lectura" title="Parar">■ Parar</button>
              <button id="printRecipe" class="btn btn-ghost" aria-label="Imprimir receta" title="Imprimir">🖨️ Imprimir</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drawer Lista compra -->
    <aside id="shoppingDrawer" class="drawer" aria-label="Lista de la compra" aria-hidden="true">
      <div class="p-3 border-b border-stone-200 dark:border-stone-700 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Lista de la compra</h3>
        <div class="flex items-center gap-2">
          <button id="exportList" class="btn btn-ghost" aria-label="Exportar lista" title="Exportar lista">⬇️ Exportar</button>
          <button id="printList" class="btn btn-ghost" aria-label="Imprimir lista" title="Imprimir lista">🖨️</button>
          <button id="clearChecked" class="btn btn-ghost" aria-label="Borrar elementos marcados" title="Borrar marcados">🗑️ Marcados</button>
          <button id="closeShopping" class="btn btn-ghost" aria-label="Cerrar lista" title="Cerrar">✕</button>
        </div>
      </div>
      <div class="p-3">
        <div class="flex gap-2 mb-3">
          <label for="newItem" class="sr-only">Nuevo artículo</label>
          <input id="newItem" class="flex-1 rounded-xl border border-stone-300 dark:border-stone-700 bg-white dark:bg-stone-900 px-3 py-2" placeholder="Añadir artículo (ej. 1 kg tomates)" />
          <button id="addItem" class="btn btn-primary" aria-label="Añadir artículo" title="Añadir artículo">Añadir</button>
        </div>
        <ul id="shoppingList" class="space-y-2"></ul>
        <p id="shoppingEmpty" class="text-sm text-stone-500 mt-3 hidden">Tu lista está vacía.</p>
      </div>
    </aside>
  </div>

  <!-- Subtítulos de voz -->
  <div id="ttsCaption" role="status" aria-live="polite"></div>

  <script>
  const APP_VERSION = "recetario-1.3.2";

  /* ===== Datos (160 recetas) ===== */
  const IMG = c => ({
    Aperitivo:"https://placehold.co/800x500?text=Aperitivo",
    Primero:"https://placehold.co/800x500?text=Primero",
    Segundo:"https://placehold.co/800x500?text=Segundo",
    Postre:"https://placehold.co/800x500?text=Postre"
  }[c]);

  const APERITIVOS = [
    "Tostas de tomate y jamón","Tostas de anchoa y pimiento","Tostas de escalivada","Tostas de salmón y queso fresco",
    "Croquetas de jamón","Croquetas de pollo","Croquetas de bacalao","Croquetas de setas",
    "Empanadillas de atún","Empanadillas de carne","Patatas bravas","Patatas alioli",
    "Boquerones en vinagre","Champiñones al ajillo","Gildas donostiarras","Pinchos de tortilla",
    "Pinchos morunos","Queso marinado en aceite","Hummus clásico con crudités","Hummus de remolacha",
    "Hummus de aguacate","Gazpacho en vasitos","Salmorejo en chupitos","Ensaladilla rusa",
    "Tortilla francesa mini","Banderillas variadas","Mejillones en escabeche","Sardinas marinadas",
    "Pulpo a la gallega (tapa)","Calamares a la romana","Torreznos crujientes","Jamón con picos",
    "Queso manchego con membrillo","Pimientos del padrón","Montadito de lomo","Montadito de pringá",
    "Bonito con tomate (tapa)","Pisto con huevo (tapa)","Chistorra a la sidra","Berenjena frita con miel"
  ];

  const PRIMEROS = [
    "Sopa de ajo","Sopa castellana","Gazpacho andaluz","Salmorejo cordobés","Ajoblanco","Crema de calabaza",
    "Crema de puerros","Crema de champiñón","Pisto manchego","Menestra de verduras","Lentejas estofadas",
    "Garbanzos con espinacas","Judías blancas con verduras","Arroz caldoso de verduras","Arroz a la cubana",
    "Arroz negro","Arroz al horno","Paella de verduras","Fideuá de pescado","Macarrones con tomate",
    "Tallarines al ajillo","Espaguetis carbonara ligera","Ensalada mixta","Ensalada campera","Ensalada de garbanzos",
    "Ensalada de pasta fría","Tomates aliñados","Papas arrugadas con mojo","Pimientos asados","Alcachofas salteadas",
    "Acelgas rehogadas","Sopa de pescado","Caldo gallego","Cocido andaluz (sopa)","Sopa minestrone","Vichyssoise",
    "Crema de zanahoria","Porrusalda","Sopa de marisco","Caldo de pollo casero"
  ];

  const SEGUNDOS = [
    "Pollo al ajillo","Pollo al horno con patatas","Pollo en pepitoria","Pechuga de pollo a la plancha",
    "Escalope de ternera","Filete de ternera a la plancha","Carrilleras al vino tinto","Rabo de toro",
    "Albóndigas en salsa","Lomo adobado","Costillas al horno","Chuletillas de cordero","Cordero asado",
    "Secreto ibérico a la plancha","Solomillo al roquefort","Bacalao a la vizcaína","Bacalao al pil-pil",
    "Merluza en salsa verde","Dorada al horno","Lubina a la sal","Salmón al papillote","Atún encebollado",
    "Calamares en su tinta","Pulpo a la gallega","Paella mixta","Arroz con pollo","Arroz con bogavante",
    "Empanada gallega de atún","Pisto con huevos","Tortilla de patatas","Revuelto de setas","Conejo al ajillo",
    "Codornices escabechadas","Callos a la madrileña","Fabada asturiana","Marmitako de bonito",
    "Chuletón a la plancha","Escabeche de caballa","Bonito con tomate","Trucha a la navarra"
  ];

  const POSTRES = [
    "Flan casero","Natillas caseras","Arroz con leche","Leche frita","Torrijas","Crema catalana",
    "Tarta de queso al horno","Tarta de Santiago","Bizcocho de yogur","Bizcocho de naranja","Magdalenas caseras",
    "Galletas de mantequilla","Rosquillas fritas","Pestiños","Buñuelos de viento","Filloas","Peras al vino",
    "Compota de manzana","Macedonia de frutas","Helado rápido de plátano","Mousse de chocolate","Natillas de vainilla",
    "Tarta de manzana","Tarta tres leches (versión)","Brazo de gitano","Quesada pasiega","Tocino de cielo",
    "Pan de Calatrava","Cuajada con miel","Crepes dulces","Flan de café","Crema pastelera con frutas",
    "Tarta de almendra","Tarta de galletas con chocolate","Bizcocho marmolado","Helado de yogur","Brownie sencillo",
    "Crema de limón","Naranja con canela","Fresas con nata"
  ];

  /* Overrides realistas para platos clave (ingredientes + pasos + tiempo) */
  const OV = (()=> {
    function R(ing, pasos, tiempo){ return {ing, pasos, tiempo}; }
    const CROQ_BASE = ["Leche entera","Harina de trigo","Mantequilla","Aceite de oliva","Cebolla","Nuez moscada","Sal","Pimienta","Huevos","Pan rallado"];
    const CROQ_PASOS = [
      "Pica fino cebolla y el relleno.",
      "Pocha cebolla con aceite y mantequilla 6–8 min sin dorar.",
      "Añade el relleno y rehoga 1–2 min.",
      "Incorpora harina (90–100 g/L leche) y cocina 2–3 min.",
      "Agrega la leche caliente poco a poco, removiendo hasta bechamel espesa y lisa.",
      "Sazona con sal, pimienta y nuez moscada; cocina 8–10 min a fuego bajo.",
      "Pasa a fuente, filma a piel y enfría 4 h (mejor de un día para otro).",
      "Da forma, pasa por huevo y pan rallado.",
      "Fríe a 175–180 ºC hasta dorar; escurre."
    ];
    const M = new Map([
      ["croquetas de jamón", R(["Jamón serrano picado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de pollo", R(["Pollo cocido desmigado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de bacalao", R(["Bacalao desalado desmigado",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["croquetas de setas", R(["Setas picadas",...CROQ_BASE], CROQ_PASOS, "45–75 min + reposo")],
      ["patatas bravas", R(
        ["Patatas","Aceite para freír","Sal","Ajo","Pimentón dulce","Pimentón picante","Tomate triturado","Vinagre"],
        ["Fríe patatas en dados hasta dorar.","Sofríe ajo; añade pimentón, tomate y sal.","Cocina 10–12 min y ajusta con vinagre.","Sirve patatas con salsa por encima."],
        "30–40 min"
      )],
      ["patatas alioli", R(
        ["Patatas cocidas","Ajo","Huevo o leche (lactonesa)","Aceite suave","Limón o vinagre","Sal","Perejil"],
        ["Cuece patatas y enfría.","Emulsiona ajo con huevo/leche y aceite, sal y limón.","Mezcla patata en dados con alioli y perejil."],
        "25–35 min"
      )],
      ["calamares a la romana", R(
        ["Calamares","Harina","Huevo","Aceite para freír","Sal","Limón"],
        ["Seca aros de calamar y sala.","Pasa por harina y huevo batido.","Fríe a 175–180 ºC 1–2 min; escurre.","Sirve con limón."],
        "20–30 min"
      )],
      ["gazpacho andaluz", R(["Tomate","Pepino","Pimiento verde","Ajo","Pan","Aceite","Vinagre","Sal"],
        ["Tritura y emulsiona con aceite.","Ajusta sal/vinagre y enfría."],"15–20 min + frío")],
      ["salmorejo cordobés", R(["Tomate","Pan","Ajo","Aceite","Vinagre","Sal","Jamón","Huevo cocido"],
        ["Tritura tomate/pan/ajo/sal.","Emulsiona con aceite y vinagre.","Sirve con jamón y huevo."],"15–20 min + frío")],
      ["ajoblanco", R(["Almendra cruda","Ajo","Pan","Agua fría","Aceite","Vinagre","Sal","Uvas"],
        ["Tritura almendra, ajo, pan, agua y sal.","Emulsiona con aceite y vinagre.","Sirve muy frío con uvas."],"15–20 min + frío")],
      ["fideuá de pescado", R(["Fideo grueso","Caldo de pescado","Sepia/calamar","Gamba","Ajo","Pimentón","Tomate","Aceite","Sal","Allioli (opcional)"],
        ["Sofríe sepia y retira.","Añade ajo, pimentón y tomate.","Tuesta el fideo, moja con caldo y cocina.","Incorpora sepia/gambas al final. Sirve con allioli."],"30–40 min")],
      ["paella de verduras", R(["Arroz","Caldo vegetal","Judía verde","Garrafo/garbanzo","Pimiento","Tomate","Ajo","Aceite","Sal","Azafrán"],
        ["Sofríe verduras.","Añade arroz y nacara un minuto.","Moja con caldo caliente y azafrán.","Cocina 18–20 min; reposo 5."],"35–45 min")],
      ["paella mixta", R(["Arroz","Caldo","Pollo","Conejo","Gamba/Calamar","Pimiento","Tomate","Ajo","Aceite","Sal","Azafrán"],
        ["Dora carnes, añade sofrito.","Agrega arroz, nacara y moja con caldo/azafrán.","Cocina 18–20 min, coloca mariscos al final; reposo 5."],"40–55 min")],
      ["arroz con bogavante", R(["Arroz","Bogavante","Caldo de marisco","Ajo","Pimentón","Tomate","Aceite","Sal"],
        ["Marca bogavante y reserva.","Haz sofrito con ajo/pimentón/tomate.","Añade arroz, caldo y bogavante; cocina 18 min."],"35–45 min")],
      ["tortilla de patatas", R(["Patatas","Cebolla (opcional)","Huevos","Aceite","Sal"],
        ["Fríe patata en aceite suave.","Mezcla con huevo batido y sal.","Cuaja a tu gusto por ambos lados."],"25–35 min")],
      ["pollo al ajillo", R(["Pollo troceado","Ajo","Aceite","Vino blanco","Sal","Pimienta","Laurel"],
        ["Dora pollo con ajos.","Desglasa con vino; reduce.","Ajusta sal/pimienta y sirve."],"25–35 min")],
      ["cordero asado", R(["Paletilla/pierna de cordero","Ajo","Romero","Aceite","Sal","Agua o vino"],
        ["Sala cordero con ajo/romero.","Asa a 180–190 ºC 70–90 min, regando.","Deja reposar y sirve con jugo."],"75–95 min")],
      ["fabada asturiana", R(["Fabes","Compango","Cebolla","Ajo","Pimentón","Sal"],
        ["Desala si procede.","Cuece fabes con compango a fuego bajo (asustando).","Espuma y rectifica sal."],"120–180 min")],
      ["marmitako de bonito", R(["Bonito","Patata","Pimiento","Cebolla","Ajo","Tomate","Caldo","Aceite","Sal"],
        ["Haz sofrito y añade patata.","Cubre con caldo y cocina.","Agrega bonito al final (2–3 min)."],"35–45 min")],
      ["rabo de toro", R(["Rabo de toro","Verduras","Vino tinto","Caldo","Aceite","Sal","Harina (ligar)"],
        ["Dora rabo enharinado.","Sofríe verduras; moja con vino y reduce.","Cuece con caldo 2–3 h hasta meloso."],"150–210 min")],
      ["callos a la madrileña", R(["Callos limpios","Morcilla/chorizo","Pimentón","Guindilla","Cebolla","Ajo","Laurel","Sal"],
        ["Blanquea y enjuaga callos.","Guiso con sofrito y pimentón a fuego bajo hasta tiernos."],"120–180 min")],
      ["bacalao al pil-pil", R(["Bacalao desalado","Ajo","Guindilla","Aceite de oliva"],
        ["Confita ajos y bacalao a baja Tª.","Liga el pil-pil moviendo la cazuela.","Sirve con ajos y guindilla."],"25–35 min")],
      ["merluza en salsa verde", R(["Merluza","Ajo","Perejil","Vino blanco","Caldo","Aceite","Sal","Almejas (opcional)"],
        ["Dora ajo, añade harina ligera.","Vino+caldo, perejil y merluza 5–7 min.","Añade almejas hasta abrir."],"20–30 min")],
      ["pulpo a la gallega", R(["Pulpo cocido","Patata cocida","Aceite","Pimentón","Sal en escamas"],
        ["Corta pulpo y patata.","Aliña con aceite, pimentón y sal."],"10–15 min")],
      ["tarta de queso al horno", R(["Queso crema","Huevos","Azúcar","Nata","Harina (opcional)"],
        ["Mezcla sin batir en exceso.","Hornea 180 ºC 40–50 min; centro tembloroso.","Enfría y sirve."],"60–90 min con enfriado")],
      ["flan casero", R(["Leche","Huevos","Azúcar","Vainilla","Azúcar para caramelo"],
        ["Haz caramelo y forra molde.","Mezcla leche/huevo/azúcar/vainilla.","Horno al baño maría 160–170 ºC 40–55 min.","Enfría y desmolda."],"70–120 min con frío")],
      ["natillas caseras", R(["Leche","Yemas","Azúcar","Maicena","Vainilla","Canela"],
        ["Infusiona leche con vainilla/canela.","Templa yemas con azúcar/maicena.","Cuece sin hervir hasta napar.","Enfría con galleta."],"30–50 min + frío")],
      ["torrijas", R(["Pan","Leche","Azúcar","Canela","Huevo","Aceite","Azúcar/canela o miel"],
        ["Empapa pan en leche aromatizada.","Reboza en huevo y fríe.","Reboza en azúcar/canela o miel."],"30–45 min")],
      ["arroz con leche", R(["Arroz","Leche entera","Azúcar","Canela","Limón"],
        ["Cuece arroz en leche aromatizada a fuego bajo, removiendo.","Azucara al final; enfría."],"45–60 min")],
      ["tarta de santiago", R(["Almendra molida","Azúcar","Huevos","Limón","Canela"],
        ["Mezcla todo y hornea 180 ºC 25–35 min.","Espolvorea azúcar glas con cruz."],"40–55 min")],
      ["brownie sencillo", R(["Chocolate","Mantequilla","Azúcar","Huevos","Harina","Nueces (opcional)"],
        ["Funde choco/mantequilla.","Añade huevos y azúcar, luego harina.","Hornea 170–180 ºC 20–25 min."],"35–45 min")]
    ]);
    return { get: (title) => M.get(title.toLowerCase()) || null };
  })();

  const PASOS_BASE = {
    Aperitivo:["Prepara y ten a mano todo.","Corta/dispón los ingredientes.","Sofríe o mezcla hasta aromatizar.","Monta y ajusta sal/aliño.","Reposa 1–2 min o sirve caliente.","Emplata y sirve."],
    Primero:["Lava y prepara verduras.","Sofríe ajo/cebolla suave.","Añade ingrediente principal y rehoga.","Cubre con caldo/agua y cocina.","Ajusta textura (tritura/reposa).","Sirve caliente o frío."],
    Segundo:["Seca la pieza y sala.","Añade adobo/especias.","Dora/hornea/sella bien.","Agrega guarnición/salsa y cocina al punto.","Reposa unos minutos.","Sirve con su jugo."],
    Postre:["Pesa y mide todo.","Mezcla secos y húmedos aparte.","Aromatiza (cítricos/vainilla/canela).","Hornea/refrigera hasta cuajar.","Enfría o reposa.","Decora y sirve."]
  };

  // Utilidad: quitar diacríticos (compatible)
  function stripDiacritics(s){ try{ return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch{ return s||""; } }

  function ingredientesPara(cat,t){
    t=t.toLowerCase(); let ing=[];
    const ov = OV.get(t); if (ov) return ov.ing;
    if(cat==="Aperitivo"){
      if(/empanadill/.test(t)) ing=["Obladas","Atún/carne","Cebolla","Tomate frito","Huevo","Aceite","Sal"];
      else if(/alioli/.test(t)) ing=["Patatas","Ajo","Huevo o leche","Aceite suave","Limón/vinagre","Sal","Perejil"];
      else if(/boquerones/.test(t)) ing=["Boquerones","Vinagre","Ajo","Perejil","Aceite","Sal"];
      else if(/romana|calamar/.test(t)) ing=["Calamares","Harina","Huevo","Aceite","Sal","Limón"];
      else if(/hummus/.test(t)) ing=["Garbanzos","Tahini","Ajo","Limón","Aceite","Sal","Comino"];
      else ing=["Pan/base","Aceite de oliva","Ajo (opcional)","Sal"];
    } else if(cat==="Primero"){
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/sopa|caldo/.test(t)) ing=["Caldo","Ajo/Cebolla","Aceite","Sal"];
      else if(/crema|vichyssoise|purrusalda|zanahoria/.test(t)) ing=["Verdura principal","Cebolla/Puerro","Caldo","Aceite","Sal"];
      else if(/arroz|paella/.test(t)) ing=["Arroz","Caldo","Verduras","Aceite","Sal","Azafrán (opcional)"];
      else if(/fideu/.test(t)) ing=["Fideos","Caldo de pescado","Ajo","Pimentón","Tomate","Aceite","Sal"];
      else if(/ensalada/.test(t)) ing=["Lechuga/legumbre","Tomate","Cebolla","Aceite","Vinagre","Sal"];
    } else if(cat==="Segundo"){
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/pollo/.test(t)) ing=["Pollo","Ajo","Aceite","Sal","Pimienta"];
      else if(/ternera|solomillo|chulet/.test(t)) ing=["Vacuno","Aceite","Sal","Pimienta"];
      else if(/cordero/.test(t)) ing=["Cordero","Ajo","Romero","Aceite","Sal"];
      else if(/secreto|lomo|costillas/.test(t)) ing=["Cerdo","Ajo","Pimentón","Aceite","Sal"];
      else if(/bacalao|merluza|dorada|lubina|trucha|bonito|atun/.test(t)) ing=["Pescado","Aceite","Ajo/Perejil","Sal"];
      else if(/paella|arroz/.test(t)) ing=["Arroz","Caldo","Pollo/Marisco","Pimiento","Tomate","Azafrán","Sal"];
      else if(/tortilla|revuelto/.test(t)) ing=["Huevos","Patata/Setas","Aceite","Sal"];
    } else {
      if(OV.get(t)) ing=OV.get(t).ing;
      else if(/flan/.test(t)) ing=["Leche","Huevos","Azúcar","Vainilla","Azúcar para caramelo"];
      else if(/natilla/.test(t)) ing=["Leche","Yemas","Azúcar","Maicena","Vainilla"];
      else if(/arroz con leche/.test(t)) ing=["Arroz","Leche","Azúcar","Canela","Limón"];
      else if(/tarta de queso/.test(t)) ing=["Queso crema","Huevos","Azúcar","Nata","Harina (opcional)"];
      else if(/bizcocho|galleta|magdalena|tarta/.test(t)) ing=["Harina","Azúcar","Huevos","Mantequilla/Aceite","Levadura"];
      else if(/helado|mousse/.test(t)) ing=["Fruta/Yogur/Chocolate","Azúcar","Nata/Leche"];
      else ing=["Azúcar","Leche/Huevos/Harina (según postre)"];
    }
    return Array.from(new Set(ing));
  }

  function tiempo(cat,t){
    const ov=OV.get(t.toLowerCase()); if(ov) return ov.tiempo;
    t=t.toLowerCase();
    if(cat==="Aperitivo") return /croqueta|empanad/.test(t)?"25–35 min":"5–15 min";
    if(cat==="Primero")   return /arroz|fideu|estof|fabada|cocido|marisc/.test(t)?"30–50 min":"15–30 min";
    if(cat==="Segundo")   return /asado|horno|costillas|carrilleras|rabo/.test(t)?"45–90 min":"15–35 min";
    if(cat==="Postre")    return /tarta|horno|tocino|calatrava/.test(t)?"40–70 min":/helado|mousse|frutas/.test(t)?"10–20 min":"20–40 min";
    return "20–30 min";
  }

  function pasosPara(cat,t){
    const ov=OV.get(t.toLowerCase()); if(ov) return ov.pasos;
    return PASOS_BASE[cat];
  }

  function build(cat,list){
    return list.map(n=>({categoria:cat,titulo:n,imagen:IMG(cat),
      ingredientes:ingredientesPara(cat,n), pasos:pasosPara(cat,n), tiempo:tiempo(cat,n)}));
  }

  const RECETAS = [
    ...build("Aperitivo", APERITIVOS),
    ...build("Primero", PRIMEROS),
    ...build("Segundo", SEGUNDOS),
    ...build("Postre", POSTRES)
  ];

  /* ===== Estado + UI ===== */
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const state = {
    q:"", cat:"Todas", list:RECETAS, current:null, step:0,
    dark: matchMedia('(prefers-color-scheme: dark)').matches,
    contrast:false, font:16, listening:false, rate:0.9
  };

  const $ = id => document.getElementById(id);
  const els = {
    grid: $('recipesGrid'), empty: $('emptyState'), count: $('countLabel'), search: $('search'),
    tabs: () => document.querySelectorAll('[role="tab"]'),
    status: $('readerStatus'),
    toggleTheme: $('toggleTheme'), toggleContrast: $('toggleContrast'),
    fontPlus: $('fontPlus'), fontMinus: $('fontMinus'),
    toggleMic: $('toggleMic'), heard: $('heardText'), voiceRate: $('voiceRate'),
    detailModal: $('detailModal'), detailTitle: $('detailTitle'), detailImg: $('detailImg'),
    detailMeta: $('detailMeta'), detailIngredients: $('detailIngredients'), detailSteps: $('detailSteps'),
    btnReadAll: $('btnReadAll'), btnGuided: $('btnGuided'), btnAddAll: $('btnAddAll'),
    guidedModal: $('guidedModal'), gTitle: $('guidedTitle'), gSteps: $('guidedSteps'),
    gProg: $('guidedProgress'), next: $('nextStep'), prev: $('prevStep'),
    rep: $('repeatStep'), stop: $('stopReading'), close: $('closeGuided'), printBtn: $('printRecipe'),
    shoppingDrawer: $('shoppingDrawer'), openShopping: $('openShopping'), closeShopping: $('closeShopping'),
    shoppingList: $('shoppingList'), shoppingEmpty: $('shoppingEmpty'), newItem: $('newItem'),
    addItem: $('addItem'), exportList: $('exportList'), printList: $('printList'), clearChecked: $('clearChecked'),
    caption: $('ttsCaption'), closeDetail: $('closeDetail')
  };

  function applyTheme(){ document.documentElement.classList.toggle('dark', state.dark); }
  function applyContrast(){ document.documentElement.classList.toggle('hc', state.contrast); }
  function setFont(px){ state.font = Math.max(14, Math.min(22, px)); document.documentElement.style.setProperty('--base-font', state.font+'px'); }
  applyTheme(); applyContrast(); setFont(state.font);
  els.toggleTheme.onclick = () => { state.dark = !state.dark; applyTheme(); };
  els.toggleContrast.onclick = () => { state.contrast = !state.contrast; applyContrast(); };
  els.fontPlus.onclick = () => setFont(state.font+1);
  els.fontMinus.onclick = () => setFont(state.font-1);

  // Tabs accesibles
  function setActiveTab(btn){
    els.tabs().forEach(t => t.setAttribute('aria-selected', t === btn ? 'true' : 'false'));
    state.cat = btn.dataset.cat;
    filter();
  }
  els.tabs().forEach(b => b.addEventListener('click', () => setActiveTab(b)));

  // ===== Favoritos
  const FKEY='fav.v1';
  let fav = new Set(JSON.parse(localStorage.getItem(FKEY)||'[]'));
  function saveFav(){ try{ localStorage.setItem(FKEY, JSON.stringify([...fav])); }catch{} }
  function isFav(r){ return fav.has(r.titulo); }
  function toggleFav(r){ isFav(r) ? fav.delete(r.titulo) : fav.add(r.titulo); saveFav(); filter(); }

  // ===== Tarjetas (primera fila: eager/high para reducir aviso de lazy)
  function card(r,i){
    const eager = i < 4 ? 'eager' : 'lazy';
    const fetchp = i < 4 ? 'high' : 'auto';
    const star = isFav(r) ? '⭐' : '☆';
    return `<article class="card" role="article" aria-label="${r.titulo}">
      <img src="${r.imagen}" alt="Foto ilustrativa de ${r.titulo}" class="w-full h-44 sm:h-48 object-cover" loading="${eager}" fetchpriority="${fetchp}" decoding="async" width="800" height="500">
      <div class="p-3 space-y-2">
        <h3 class="text-lg font-semibold">${r.titulo}</h3>
        <p class="text-sm text-stone-600 dark:text-stone-400">${r.categoria} · ${r.tiempo}</p>
        <div class="flex flex-wrap gap-2 pt-1">
          <button class="btn btn-ghost" data-a="leer" data-i="${i}" aria-label="Leer ${r.titulo} en voz alta" title="Leer">🔈 Leer</button>
          <button class="btn btn-primary" data-a="guiada" data-i="${i}" aria-label="Cocina guiada para ${r.titulo}" title="Guiada">▶️ Guiada</button>
          <button class="btn btn-ghost" data-a="abrir" data-i="${i}" aria-label="Abrir detalles de ${r.titulo}" title="Abrir">📖 Abrir</button>
          <button class="btn btn-ghost" data-a="lista" data-i="${i}" aria-label="Añadir ingredientes de ${r.titulo} a la lista" title="Añadir a lista">🧺 Añadir</button>
          <button class="btn btn-ghost" data-a="fav" data-i="${i}" aria-label="Marcar favorito" title="Favorito">${star} Favorito</button>
        </div>
      </div>
    </article>`;
  }

  function render(list){
    state.list = list;
    if(!list.length){
      els.grid.innerHTML = "";
      els.empty.classList.remove('hidden');
      els.count.textContent = "Mostrando 0 recetas.";
      return;
    }
    els.empty.classList.add('hidden');
    els.grid.innerHTML = list.map((r,i)=>card(r,i)).join("");
    els.count.textContent = `Mostrando ${list.length} recetas.`;
    try{ injectListLD(list); }catch{}
  }

  function filter(){
    const q = state.q.toLowerCase().trim();
    const lAll = RECETAS.filter(r =>
      (state.cat==="Todas" || r.categoria===state.cat) &&
      (!q || [r.titulo, ...r.ingredientes, ...r.pasos].join(" ").toLowerCase().includes(q))
    );
    const l = state.cat==="Favoritas" ? lAll.filter(r=>fav.has(r.titulo)) : lAll;
    render(l);
  }

  render(RECETAS);

  els.search.oninput = e => { state.q = e.target.value; filter(); };
  document.addEventListener('keydown', e => {
    if(e.ctrlKey && e.key === '/'){ e.preventDefault(); els.search.focus(); }
  });

  function openDetail(r){
    state.current = r;
    els.detailTitle.textContent = r.titulo;
    els.detailImg.src = r.imagen;
    els.detailImg.alt = `Foto de ${r.titulo}`;
    els.detailMeta.textContent = `${r.categoria} · ${r.tiempo}`;
    els.detailIngredients.innerHTML = r.ingredientes.map(i=>`<li>${i}</li>`).join("");
    els.detailSteps.innerHTML = r.pasos.map(p=>`<li>${p}</li>`).join("");
    els.detailModal.classList.remove('hidden'); els.detailModal.classList.add('flex');
    injectRecipeLD(r);
    if(untrapDetail) untrapDetail(); untrapDetail = trapFocus(els.detailModal);
    ensureShareButton();
  }
  function closeDetail(){ els.detailModal.classList.add('hidden'); els.detailModal.classList.remove('flex'); if(untrapDetail) untrapDetail(); }
  els.closeDetail.onclick = closeDetail;
  document.getElementById('detailModal').addEventListener('click', e => { if(e.target.id==='detailModal') closeDetail(); });

  /* ===== Voz (TTS) ===== */
  let ttsVoice = null, voicesReady = false;
  function pickVoice(){
    const vs = speechSynthesis.getVoices();
    voicesReady = vs && vs.length>0;
    ttsVoice = vs.find(v=>/Spanish.*(Spain)|es[-_]ES/i.test(v.name+v.lang))
             || vs.find(v=>/Spanish|es[-_]/i.test(v.name+v.lang))
             || vs[0] || null;
  }
  if('speechSynthesis' in window){
    try{ pickVoice(); speechSynthesis.onvoiceschanged = pickVoice; }catch{}
  }
  els.voiceRate.onchange = e => { state.rate = Number(e.target.value) || 0.9; };

  function unlockTTSOnce(){
    if (!('speechSynthesis' in window) || unlockTTSOnce.done) return;
    try{ speechSynthesis.cancel(); speechSynthesis.resume(); }catch{}
    const u = new SpeechSynthesisUtterance(' ');
    try{ speechSynthesis.speak(u);}catch{} try{ speechSynthesis.cancel(); }catch{}
    unlockTTSOnce.done = true;
    document.removeEventListener('touchend', unlockTTSOnce);
    document.removeEventListener('click', unlockTTSOnce);
  }
  document.addEventListener('touchend', unlockTTSOnce, {passive:true});
  document.addEventListener('click', unlockTTSOnce, {once:true});

  let speakLock=false;
  function stopSpeak(){ try{ speechSynthesis.cancel(); }catch{} }
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  async function speakSafe(text){
    if(!('speechSynthesis' in window)) return;
    while(speakLock) await sleep(20);
    speakLock = true;
    if(!voicesReady){ try{ pickVoice(); }catch{} }
    stopSpeak(); await sleep(120);
    const u = new SpeechSynthesisUtterance(text);
    if(ttsVoice) u.voice = ttsVoice;
    u.lang = (ttsVoice && ttsVoice.lang) || 'es-ES';
    u.rate = state.rate; u.pitch = 1.0;
    const cap = document.getElementById('ttsCaption');
    if(cap){
      u.onstart = ()=>{ cap.textContent = text; cap.classList.add('show'); };
      u.onend   = ()=>{ cap.classList.remove('show'); cap.textContent=''; };
    }
    const done = new Promise(res=>{ u.onend=()=>{ speakLock=false; res(); }; u.onerror=()=>{ speakLock=false; res(); }; });
    try{ speechSynthesis.speak(u); }catch{ speakLock=false; }
    await done;
  }

  function readRecipe(r){
    const intro = `${r.titulo}. ${r.categoria}. Tiempo ${r.tiempo}.`;
    const ing = r.ingredientes?.length ? `Ingredientes: ${r.ingredientes.join(", ")}.` : "";
    const pasos = r.pasos?.length ? `Pasos: ${r.pasos.map((p,i)=>`Paso ${i+1}: ${p}.`).join(" ")}` : "";
    speakSafe([intro,ing,pasos].filter(Boolean).join(" "));
    els.status.textContent = `Leyendo ${r.titulo}.`;
  }

  /* ===== Guiado + Temporizador ===== */
  function ensureCurrent(){
    if(!state.current){
      const primera = (state.list && state.list[0]) || null;
      if(!primera){ els.status.textContent="Abre una receta y pulsa ‘Guiada’."; return false; }
      state.current = primera; state.step = 0;
    }
    return true;
  }
  function openGuided(r){
    state.current = r; state.step = 0;
    $('guidedRecipeTitle').textContent = r.titulo;
    $('guidedSteps').innerHTML = r.pasos.map((p,i)=>`<li data-step="${i}">${p}</li>`).join("");
    $('guidedModal').classList.remove('hidden'); $('guidedModal').classList.add('flex');
    if(untrapGuided) untrapGuided(); untrapGuided = trapFocus(els.guidedModal);
    els.status.textContent = "Micrófono listo: mantén pulsado el botón para hablar.";
    speakSafe(`Iniciamos ${r.titulo}. Di: siguiente, anterior, repetir, leer ingredientes o salir.`);
    readCurrent();
    saveSession();
  }
  function closeGuided(){ stopSpeak(); $('guidedModal').classList.add('hidden'); $('guidedModal').classList.remove('flex'); els.status.textContent="Cocina guiada cerrada."; if(untrapGuided) untrapGuided(); saveSession(); }
  function readCurrent(){
    if(!ensureCurrent()) return;
    const pasos = state.current.pasos || []; if(!pasos.length) return;
    if(state.step<0) state.step=0; if(state.step>=pasos.length) state.step=pasos.length-1;
    speakSafe(`Paso ${state.step+1}. ${pasos[state.step]}`);
    const t = pasos.length; $('guidedProgress').textContent = `Paso ${state.step+1} de ${t}`;
    [...$('guidedSteps').children].forEach((li,i)=>li.classList.toggle('font-semibold', i===state.step));

    // Temporizador por paso (si detecta “X min”)
    clearTimerUI();
    try{
      const p = state.current?.pasos?.[state.step] || "";
      const m = /(\d{1,2})\s*(?:min|mins|minutos)\b/i.exec(p);
      if(m){ const mins = Number(m[1]); if(mins>0){ speakSafe(`Inicio temporizador de ${mins} minutos.`); startStepTimer(mins); } }
    }catch{}
  }
  async function nextStep(){
    if(!ensureCurrent()) return;
    const t = (state.current.pasos||[]).length;
    if(state.step < t-1){ state.step++; stopSpeak(); await sleep(80); readCurrent(); saveSession(); }
    else { stopSpeak(); await sleep(80); speakSafe("Receta terminada. ¡Buen provecho!"); saveSession(); }
  }
  async function prevStep(){
    if(!ensureCurrent()) return;
    if(state.step>0){ state.step--; stopSpeak(); await sleep(80); readCurrent(); saveSession(); }
    else { stopSpeak(); await sleep(80); speakSafe("Ya estás en el primer paso."); }
  }
  function repeatStep(){ stopSpeak(); setTimeout(readCurrent,80); }
  function readIngredients(){
    if(!ensureCurrent()) return;
    const ing = state.current?.ingredientes || [];
    stopSpeak();
    setTimeout(()=>speakSafe(ing.length?("Ingredientes: "+ing.join(", ")):"No hay ingredientes listados."),80);
  }
  function goToStep(n){
    const total = state?.current?.pasos?.length || 0;
    if(n>=0 && n<total){ state.step=n; stopSpeak(); setTimeout(readCurrent,80); saveSession(); }
    else { stopSpeak(); setTimeout(()=>speakSafe("Ese número de paso no existe."),80); }
  }

  els.btnReadAll.onclick = ()=>{ if(state.current) readRecipe(state.current); };
  els.btnGuided.onclick = ()=>{ if(state.current) openGuided(state.current); };
  els.btnAddAll.onclick = ()=>{ if(state.current) addMany(state.current.ingredientes||[]); };

  $('nextStep').onclick = nextStep; $('prevStep').onclick = prevStep; $('repeatStep').onclick = repeatStep;
  $('stopReading').onclick = ()=>{ stopSpeak(); }; $('closeGuided').onclick = closeGuided;
  $('printRecipe').onclick = ()=>{ window.print(); };

  // Delegación en tarjetas
  els.grid.addEventListener('click',e=>{
    const b = e.target.closest('button[data-a]'); if(!b) return;
    const r = state.list[Number(b.dataset.i)]; if(!r) return;
    if(b.dataset.a==='leer')  { openDetailWithHash(r); readRecipe(r); }
    if(b.dataset.a==='guiada'){ openDetailWithHash(r); openGuided(r); }
    if(b.dataset.a==='abrir') { openDetailWithHash(r); }
    if(b.dataset.a==='lista') addMany(r.ingredientes||[]);
    if(b.dataset.a==='fav')  toggleFav(r);
  });

  // Atajos en modal guiado
  document.addEventListener('keydown',e=>{
    if($('guidedModal').classList.contains('hidden')) return;
    if(e.code==='Space'){ e.preventDefault(); /* PTT se maneja abajo */ }
    if(e.key===' '||e.key==='ArrowRight'){ e.preventDefault(); nextStep(); }
    if(e.key==='ArrowLeft'){ e.preventDefault(); prevStep(); }
    if(e.key==='r'||e.key==='R'){ e.preventDefault(); repeatStep(); }
    if(e.key==='Escape'){ e.preventDefault(); closeGuided(); closeDetail(); }
  });

  /* ===== Lista de la compra ===== */
  const SKEY='shopping.v1'; let shopping=JSON.parse(localStorage.getItem(SKEY)||'[]');
  function save(){ localStorage.setItem(SKEY, JSON.stringify(shopping)); }
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function renderList(){
    $('shoppingList').innerHTML = shopping.map(i=>`
      <li class="flex items-center gap-2">
        <input type="checkbox" ${i.done?'checked':''} data-a="t" data-id="${i.id}" aria-label="Marcar ${i.text}" title="Marcar ${i.text}">
        <input type="text" value="${i.text.replace(/"/g,'&quot;')}" class="flex-1 bg-transparent border-b border-stone-300 dark:border-stone-700" data-a="e" data-id="${i.id}" aria-label="Editar ${i.text}" title="Editar ${i.text}">
        <button class="btn btn-ghost" data-a="d" data-id="${i.id}" aria-label="Eliminar ${i.text}" title="Eliminar ${i.text}">🗑️</button>
      </li>`).join("");
    $('shoppingEmpty').classList.toggle('hidden', shopping.length>0);
  }
  function addItem(text){ text=(text||"").trim(); if(!text) return; shopping.push({id:uid(),text,done:false}); save(); renderList(); }
  function addMany(arr){ (arr||[]).forEach(addItem); openDrawer(); }
  function openDrawer(){ $('shoppingDrawer').classList.add('open'); $('shoppingDrawer').setAttribute('aria-hidden','false'); }
  function closeDrawer(){ $('shoppingDrawer').classList.remove('open'); $('shoppingDrawer').setAttribute('aria-hidden','true'); }
  els.openShopping.onclick = openDrawer; els.closeShopping.onclick = closeDrawer;
  els.addItem.onclick = ()=>{ addItem(els.newItem.value); els.newItem.value=""; els.newItem.focus(); };
  els.newItem.onkeydown = e=>{ if(e.key==='Enter'){ e.preventDefault(); els.addItem.click(); } };
  $('shoppingList').addEventListener('click',e=>{
    const b=e.target.closest('button[data-a="d"]'); if(!b) return;
    shopping = shopping.filter(x=>x.id!==b.dataset.id); save(); renderList();
  });
  $('shoppingList').addEventListener('change',e=>{
    const c=e.target.closest('input[type="checkbox"][data-a="t"]'); if(!c) return;
    const it=shopping.find(x=>x.id===c.dataset.id); if(it){ it.done=c.checked; save(); }
  });
  $('shoppingList').addEventListener('input',e=>{
    const t=e.target.closest('input[type="text"][data-a="e"]'); if(!t) return;
    const it=shopping.find(x=>x.id===t.dataset.id); if(it){ it.text=t.value; save(); }
  });
  els.clearChecked.onclick = ()=>{ shopping = shopping.filter(i=>!i.done); save(); renderList(); };
  els.exportList.onclick = ()=>{
    const data = shopping.map(i=>`${i.done?'[x]':'[ ]'} ${i.text}`).join('\n');
    const a=document.createElement('a');
    a.href = URL.createObjectURL(new Blob([data],{type:'text/plain'}));
    a.download='lista_compra.txt'; a.click();
  };
  els.printList.onclick = ()=>{
    const w = window.open('','_blank');
    w.document.write(`<pre>${shopping.map(i=>`${i.done?'[x]':'[ ]'} ${i.text}`).join('\n')}</pre>`);
    w.document.close(); w.print(); setTimeout(()=>w.close(),300);
  };

  /* ===== Temporizadores por paso ===== */
  let currentTimer = null, countdownInt = null;
  function clearTimerUI(){
    if(countdownInt) { clearInterval(countdownInt); countdownInt = null; }
    const old = document.getElementById('guidedTimer');
    if(old) old.remove();
  }
  function beep(ms=200, freq=880){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ctx.createOscillator(); const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq; osc.start();
      setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
    }catch{}
  }
  function startStepTimer(minutes){
    clearTimerUI();
    if(currentTimer) { clearTimeout(currentTimer); currentTimer = null; }
    const box = document.createElement('div');
    box.id='guidedTimer';
    box.className='mt-3 text-sm';
    box.innerHTML = `<span>⏱️ Temporizador: <strong id="tleft"></strong></span>
      <button class="btn btn-ghost ml-2" id="cancelTimer" aria-label="Cancelar temporizador" title="Cancelar temporizador">Cancelar</button>`;
    document.querySelector('#guidedModal .p-4').appendChild(box);

    let left = Math.round(minutes*60);
    const $left = document.getElementById('tleft');
    const fmt = s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
    $left.textContent = fmt(left);

    countdownInt = setInterval(()=>{ left--; $left.textContent = fmt(Math.max(0,left)); }, 1000);
    currentTimer = setTimeout(()=>{ clearTimerUI(); beep(300); speakSafe("¡Tiempo!"); }, minutes*60*1000);
    document.getElementById('cancelTimer').onclick = ()=>{ clearTimerUI(); if(currentTimer){ clearTimeout(currentTimer); currentTimer=null; } };
  }

  /* ===== JSON-LD (SEO) ===== */
  const slug = s => stripDiacritics((s||"").toLowerCase()).replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  function injectRecipeLD(r){
    const ld = {
      "@context":"https://schema.org",
      "@type":"Recipe",
      "name": r.titulo,
      "recipeCategory": r.categoria,
      "image": r.imagen,
      "recipeIngredient": r.ingredientes,
      "recipeInstructions": (r.pasos||[]).map(p=>({"@type":"HowToStep","text":p})),
      "totalTime": "PT30M"
    };
    let n = document.getElementById("ld-recipe");
    if(!n){ n=document.createElement("script"); n.type="application/ld+json"; n.id="ld-recipe"; document.head.appendChild(n); }
    n.textContent = JSON.stringify(ld);
  }
  function injectListLD(list){
    const items = (list||[]).slice(0,50).map((r,i)=>({
      "@type":"ListItem","position":i+1,"name":r.titulo,"url": location.origin + location.pathname + '#receta=' + slug(r.titulo)
    }));
    const ld = {"@context":"https://schema.org","@type":"ItemList","itemListElement":items};
    let n = document.getElementById("ld-list");
    if(!n){ n=document.createElement("script"); n.type="application/ld+json"; n.id="ld-list"; document.head.appendChild(n); }
    n.textContent = JSON.stringify(ld);
  }

  /* ===== Focus trap en modales ===== */
  function trapFocus(modal){
    const sel = 'a[href],button,textarea,input,select,[tabindex]:not([tabindex="-1"])';
    const f = modal.querySelectorAll(sel); if(!f.length) return ()=>{};
    const first = f[0], last = f[f.length-1];
    function onKey(e){
      if(e.key!=='Tab') return;
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
    modal.addEventListener('keydown', onKey);
    first.focus();
    return ()=> modal.removeEventListener('keydown', onKey);
  }
  let untrapDetail = null, untrapGuided = null;

  /* ===== Deep-link & Compartir ===== */
  function openDetailWithHash(r){
    openDetail(r);
    const h = '#receta=' + slug(r.titulo);
    if(location.hash !== h){ history.pushState({}, "", h); }
  }
  function fromHashOpen(){
    const m = location.hash.match(/#receta=([a-z0-9\-]+)/i);
    if(!m) return;
    const r = RECETAS.find(x=>slug(x.titulo)===m[1]);
    if(r) openDetail(r);
  }
  window.addEventListener('popstate', fromHashOpen);
  document.addEventListener('DOMContentLoaded', fromHashOpen);

  function ensureShareButton(){
    const bar = document.querySelector('#detailModal .mt-3.flex');
    if(!bar) return;
    let btn = document.getElementById('btnShare');
    if(!btn){
      btn = document.createElement('button');
      btn.id='btnShare';
      btn.className='btn btn-ghost';
      btn.setAttribute('aria-label','Compartir receta');
      btn.setAttribute('title','Compartir receta');
      btn.textContent='📤 Compartir';
      bar.appendChild(btn);
    }
    btn.onclick = async ()=>{
      if(!state.current) return;
      const url = location.origin + location.pathname + '#receta=' + slug(state.current.titulo);
      if(navigator.share){
        try{ await navigator.share({ title: state.current.titulo, text: 'Receta', url }); }catch{}
      }else{
        try{ await navigator.clipboard.writeText(url);}catch{}
        alert('Enlace copiado: ' + url);
      }
    };
  }

  /* ===== Reconocimiento de voz (STT) PTT ===== */
  const SRClass = (!isIOS) && (window.SpeechRecognition||window.webkitSpeechRecognition)
                ? (window.SpeechRecognition||window.webkitSpeechRecognition) : null;

  if(isIOS || !SRClass){
    els.toggleMic.disabled = true;
    els.toggleMic.classList.add('opacity-60','cursor-not-allowed');
    els.status.textContent = isIOS
      ? "Voz: el micrófono no está soportado en iPhone/iPad (Safari). Usa los botones."
      : "Voz: reconocimiento no disponible en este navegador.";
  }

  let VOICE_MODE = 'ptt'; // 'ptt' por defecto
  let rec=null, listenTimeout=null, listening=false;

  function makeRecognizer(){
    const r = new SRClass();
    r.lang = 'es-ES';
    r.continuous = (VOICE_MODE === 'continuous');
    r.interimResults = true;
    r.maxAlternatives = 3;
    const SGL = window.SpeechGrammarList || window.webkitSpeechGrammarList;
    if (SGL) {
      try {
        const g = new SGL();
        const cmds = ["siguiente","anterior","repetir","leer ingredientes","paso uno","paso dos","paso tres","salir"];
        g.addFromString(`#JSGF V1.0; grammar cmds; public <cmd> = ${cmds.join(' | ')} ;`, 1);
        r.grammars = g;
      } catch {}
    }
    return r;
  }

  function updateMic(){
    if(!SRClass) return;
    els.toggleMic.textContent = "🎤 Micro (mantén pulsado)";
    els.toggleMic.setAttribute('title','Mantén pulsado para hablar');
    els.toggleMic.setAttribute('aria-label','Mantén pulsado para hablar');
  }
  updateMic();

  function startPTT(){
    if(!SRClass) return;
    clearTimeout(listenTimeout);
    if(!rec) rec = makeRecognizer();
    try{
      els.status.textContent = "🎙️ Escuchando… suelta para enviar.";
      els.toggleMic.textContent = "🎙️ Grabando… (suelta)";
      beep(90, 940);
      rec.onresult = onResult;
      rec.onerror = onError;
      rec.onend = onEnd;
      listening = true;
      rec.start();
      listenTimeout = setTimeout(()=>{ try{ rec.stop(); }catch{} }, 6000);
    }catch{
      els.status.textContent = "Voz: no se pudo iniciar (revisa permisos del micrófono).";
    }
  }
  function stopPTT(){
    clearTimeout(listenTimeout);
    if(!rec) return;
    try{ rec.stop(); }catch{}
  }

  const NUM = {uno:1, una:1, dos:2, tres:3, cuatro:4, cinco:5, seis:6, siete:7, ocho:8, nueve:9, diez:10,
               once:11, doce:12, trece:13, catorce:14, quince:15, dieciseis:16, diecisiete:17, dieciocho:18, diecinueve:19, veinte:20};
  const norm = s => stripDiacritics((s||"").toLowerCase()).replace(/\s+/g,' ').trim();
  function parseCommand(text){
    const t = norm(text);
    const tNum = t.replace(/\bpaso\s+(uno|una|dos|tres|cuatro|cinco|seis|siete|ocho|nueve|diez|once|doce|trece|catorce|quince|dieciseis|diecisiete|dieciocho|diecinueve|veinte)\b/g,
                           (_,w)=>'paso '+NUM[w]);
    if (/^(salir|parar|detener|cerrar)$/i.test(tNum)) return {type:'stop'};
    if (/^(repetir|otra vez|de nuevo|repite)$/i.test(tNum)) return {type:'repeat'};
    if (/^(siguiente|sigue|proximo|adelante|avanza|continuar|continuar paso)$/i.test(tNum)) return {type:'next'};
    if (/^(anterior|atras|retroceder)$/i.test(tNum)) return {type:'prev'};
    if (/^(leer ingredientes?|ingredientes|leer lista)$/i.test(tNum)) return {type:'ingredients'};
    const m = tNum.match(/\bpaso\s+(\d{1,2})\b/); if (m) return {type:'goto', n: Number(m[1])};
    if (/\b(siguiente|avanza)\b/.test(tNum)) return {type:'next'};
    if (/\b(anterior|atras)\b/.test(tNum)) return {type:'prev'};
    return {type:'unknown', raw:t};
  }

  function onResult(ev){
    let finalTranscript = "";
    for (let i = ev.resultIndex; i < ev.results.length; i++) {
      const res = ev.results[i];
      const txt = res[0]?.transcript || '';
      if (res.isFinal) finalTranscript += txt + " ";
      els.heard.textContent = (res.isFinal ? "✓ " : "… ") + txt;
    }
    if (finalTranscript.trim()){
      handleCommand(finalTranscript.trim());
    }
  }
  function onError(e){ els.status.textContent = `Voz: ${e.error || 'error'}`; }
  function onEnd(){
    listening = false;
    els.toggleMic.textContent = "🎤 Micro (mantén pulsado)";
    els.status.textContent = "Micrófono listo.";
    beep(70, 700);
    if (VOICE_MODE === 'continuous' && state.listening) {
      setTimeout(()=>{ try{ rec.start(); }catch{} }, 350);
    }
  }
  function handleCommand(text){
    const cmd = parseCommand(text);
    if(cmd.type==='unknown'){
      els.status.textContent = `No entendido: “${text}”. Prueba “siguiente / anterior / repetir / paso 2 / leer ingredientes / salir”.`;
      return;
    }
    if(cmd.type==='stop') return closeGuided();
    if(cmd.type==='repeat') return repeatStep();
    if(cmd.type==='next') return nextStep();
    if(cmd.type==='prev') return prevStep();
    if(cmd.type==='ingredients') return readIngredients();
    if(cmd.type==='goto') return goToStep((cmd.n||1)-1);
  }

  // Botón PTT (ratón/táctil/teclado)
  els.toggleMic.onmousedown = (e)=>{ if(!SRClass) return; e.preventDefault(); startPTT(); };
  els.toggleMic.onmouseup   = (e)=>{ if(!SRClass) return; e.preventDefault(); stopPTT(); };
  els.toggleMic.onmouseleave= (e)=>{ if(!SRClass) return; e.preventDefault(); stopPTT(); };
  els.toggleMic.ontouchstart= (e)=>{ if(!SRClass) return; e.preventDefault(); startPTT(); };
  els.toggleMic.ontouchend  = (e)=>{ if(!SRClass) return; e.preventDefault(); stopPTT(); };
  document.addEventListener('keydown', (e)=>{
    if(!SRClass) return;
    if(e.code==='Space'){ e.preventDefault(); if(!listening) startPTT(); }
  });
  document.addEventListener('keyup', (e)=>{
    if(!SRClass) return;
    if(e.code==='Space'){ e.preventDefault(); stopPTT(); }
  });

  // Pestaña Favoritas
  (function addFavTab(){
    const tablist = document.querySelector('[role="tablist"]');
    const btn = document.createElement('button');
    btn.className='tab'; btn.role='tab'; btn.id='tab-fav'; btn.dataset.cat='Favoritas';
    btn.setAttribute('aria-selected','false'); btn.setAttribute('title','Mostrar favoritas'); btn.setAttribute('aria-label','Mostrar favoritas');
    btn.textContent='Favoritas';
    tablist.appendChild(btn);
    btn.addEventListener('click', ()=>setActiveTab(btn));
  })();

  /* ===== SW: aviso de actualización si existe sw.js ===== */
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").then(reg=>{
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        nw.addEventListener('statechange', ()=>{
          if(nw.state==='installed' && navigator.serviceWorker.controller){
            if(confirm('Hay una actualización disponible. ¿Actualizar ahora?')) location.reload();
          }
        });
      });
    }).catch(()=>{});
  }

  /* ===== Reanudar sesión ===== */
  const SKEY_SESSION = "session.v1"; // {slug, step}
  function saveSession(){
    try{
      if(!state.current) return;
      localStorage.setItem(SKEY_SESSION, JSON.stringify({ slug: slug(state.current.titulo), step: state.step||0 }));
    }catch{}
  }
  function loadSession(){
    try{
      const raw = localStorage.getItem(SKEY_SESSION);
      if(!raw) return null;
      const d = JSON.parse(raw);
      const r = RECETAS.find(x => slug(x.titulo) === d.slug);
      return r ? {recipe:r, step:Math.max(0, Math.min((r.pasos||[]).length-1, d.step||0))} : null;
    }catch{ return null; }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const last = loadSession();
    if(last && confirm(`¿Reanudar "${last.recipe.titulo}" en el paso ${last.step+1}?`)){
      openDetailWithHash(last.recipe);
      openGuided(last.recipe);
      state.step = last.step;
      readCurrent();
    }
  });

  /* ===== Accesibilidad extra: añade title a botones sin título ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('button, [role="button"], a[role="button"]').forEach(el=>{
      const label = el.getAttribute('aria-label') || el.innerText?.trim() || el.textContent?.trim();
      if(label && !el.hasAttribute('title')) el.setAttribute('title', label);
    });
    // Detección de IDs duplicados (si los hubiera por extensiones/overlays)
    const seen = new Set(), dups = [];
    document.querySelectorAll('[id]').forEach(el=>{
      if(seen.has(el.id)) dups.push(el.id);
      seen.add(el.id);
    });
    if(dups.length){ console.warn('IDs duplicados detectados (posibles extensiones):', [...new Set(dups)]); }
  });

  /* ===== Inicial ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    filter(); renderList();
  });

  </script>
</body>
</html>
