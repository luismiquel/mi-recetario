<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recetario Delicioso</title>

    <meta name="theme-color" content="#78350f"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Recetario">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/78350f/ffffff?text=R">
    
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;Recetario Delicioso&quot;,
        &quot;short_name&quot;: &quot;Recetario&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#f8f7f5&quot;,
        &quot;theme_color&quot;: &quot;#78350f&quot;,
        &quot;description&quot;: &quot;Tu app de recetas de cocina española.&quot;,
        &quot;icons&quot;: [{
            &quot;src&quot;: &quot;https://placehold.co/192x192/78350f/ffffff?text=R&quot;,
            &quot;sizes&quot;: &quot;192x192&quot;,
            &quot;type&quot;: &quot;image/png&quot;
        }, {
            &quot;src&quot;: &quot;https://placehold.co/512x512/78350f/ffffff?text=R&quot;,
            &quot;sizes&quot;: &quot;512x512&quot;,
            &quot;type&quot;: &quot;image/png&quot;
        }]
    }">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7f5;
        }
        .dark body {
            background-color: #1c1917;
        }
        h1, h2, h3, h4 {
            font-family: 'Lora', serif;
        }
        .category-btn.active, .filter-btn.active, .time-filter-btn.active {
            background-color: #78350f;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .dark .category-btn.active, .dark .filter-btn.active, .dark .time-filter-btn.active {
            background-color: #f59e0b;
            color: #1c1917;
        }
        .category-btn, .filter-btn, .time-filter-btn {
            transition: all 0.3s ease-in-out;
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            border: 1px solid transparent;
            font-size: 0.875rem;
        }
        .category-btn:hover:not(.active), .filter-btn:hover:not(.active), .time-filter-btn:hover:not(.active) {
            background-color: #f0ead6;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
        }
        .dark .category-btn:hover:not(.active), .dark .filter-btn:hover:not(.active), .dark .time-filter-btn:hover:not(.active) {
            background-color: #3b3735;
        }

        #categoryFilters, #timeFilters {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 0.5rem;
        }
        #categoryFilters::-webkit-scrollbar, #timeFilters::-webkit-scrollbar {
            display: none;
        }
        #categoryFilters .category-btn, #timeFilters .time-filter-btn {
            flex-shrink: 0;
            white-space: nowrap;
        }

        .recipe-card > div {
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease-in-out;
        }
        .recipe-card > div:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        .recipe-card img.recipe-image {
            width: 100%;
            height: 192px; /* Altura fija para todas las imágenes de tarjeta */
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }


        #searchInput {
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        #searchInput:focus {
            ring-width: 3px;
            ring-offset-width: 1px;
        }

        /* ESTILOS DEL MODAL */
        #recipeModal, #shoppingListModal { 
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #recipeModal.modal-visible, #shoppingListModal.modal-visible {
            visibility: visible;
            opacity: 1;
        }

        #modalContent, #shoppingListModal > div { 
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 42rem; 
            max-height: 90vh;
            overflow-y: auto;
            
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        #recipeModal.modal-visible #modalContent, #shoppingListModal.modal-visible > div {
            transform: scale(1);
        }
        #shoppingListModal > div { 
            max-width: 36rem; 
        }


        .dark #modalContent, .dark #shoppingListModal > div {
            background-color: #292524;
        }
        /* FIN ESTILOS DEL MODAL */

        /* ESTILOS DEL SKELETON LOADER */
        .skeleton-card {
            background-color: #e0e0e0; 
            border-radius: 1.25rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            animation: pulse-bg 1.5s infinite; 
        }
        .dark .skeleton-card {
            background-color: #3b3735;
        }

        .skeleton-image {
            height: 10rem; 
            background-color: #cccccc; 
        }
        .dark .skeleton-image {
            background-color: #2a2826;
        }

        .skeleton-text {
            height: 0.875rem; 
            background-color: #cccccc;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .dark .skeleton-text {
            background-color: #2a2826;
        }
        .skeleton-text.long { width: 90%; }
        .skeleton-text.medium { width: 70%; }
        .skeleton-text.short { width: 40%; }
        .skeleton-text.small { height: 0.75rem; } 


        @keyframes pulse-bg {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        /* FIN ESTILOS DEL SKELETON LOADER */

        /* NUEVOS ESTILOS PARA LA LISTA DE COMPRA INTERACTIVA */
        #finalShoppingList li {
            cursor: pointer;
            padding: 0.5rem 0;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            list-style: none; /* Eliminar el bullet point por defecto */
            position: relative; 
            padding-left: 1.5rem; 
        }
        #finalShoppingList li:hover {
            background-color: #f0ead6;
            border-radius: 0.25rem;
        }
        .dark #finalShoppingList li:hover {
            background-color: #3b3735;
        }

        /* Estilo para los ítems marcados */
        #finalShoppingList li.checked {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
            opacity: 0.7;
        }
        .dark #finalShoppingList li.checked {
            color: #6b7280; /* gray-500 */
        }

        /* Pseudo-elementos para el icono de check/bullet */
        #finalShoppingList li::before {
            content: '•'; /* Un bullet simple */
            color: #78350f; /* Color del bullet */
            position: absolute;
            left: 0;
            font-size: 1.2em;
            line-height: 1;
        }
        #finalShoppingList li.checked::before {
            content: '✓'; /* Un checkmark */
            color: #10b981; /* green-500 */
        }
        /* FIN NUEVOS ESTILOS PARA LA LISTA DE COMPRA INTERACTIVA */

        /* Estilos para las notificaciones Toast */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 20rem; /* Ancho máximo para que no sea demasiado largo */
        }

        .toast-message {
            background-color: #333;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeIn 0.3s forwards, fadeOut 0.5s 2.5s forwards; /* Entra, se queda 2.5s, sale */
            transition: background-color 0.2s ease;
        }

        .toast-message.success { background-color: #10b981; } /* green-500 */
        .toast-message.error { background-color: #ef4444; }    /* red-500 */
        .toast-message.info { background-color: #3b82f6; }     /* blue-500 */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        /* Fin de estilos Toast */

        /* Estilos de Temporizador */
        .timer-card {
            background-color: #f0ead6;
            color: #78350f;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: space-between;
        }
        .dark .timer-card {
            background-color: #4a2e0a;
            color: #f59e0b;
        }
        .timer-card button {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            font-size: 1rem;
            padding: 0 0.25rem;
            line-height: 1;
        }
        /* Fin Estilos de Temporizador */

        @media print {
            body * { visibility: hidden; }
            #recipeModal, #recipeModal * { display: none !important; } 
            #shoppingListModal, #shoppingListModal * { visibility: visible; }
            #shoppingListModal { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: auto; 
                background: none; 
                display: block !important; 
                opacity: 1 !important;
                visibility: visible !important;
            }
            #shoppingListModal > div { 
                box-shadow: none; 
                border: none; 
                max-width: 100%; 
                max-height: none; 
                overflow-y: visible; 
                background-color: white !important; 
                color: black !important; 
                transform: scale(1) !important; 
            }
            #closeShoppingListModalBtn, .modal-buttons-container, #toast-container, .timer-card { display: none !important; } 
            .dark #shoppingListModal > div, .dark #shoppingListModal * { background-color: white !important; color: black !important; }
            h2, h4 { color: black !important; }
            ul, ol { color: #333 !important; }
            img { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #ingredient-list li, #steps-list li, #finalShoppingList li { 
                color: #333 !important;
            }
        }
    </style>
</head>
<body class="dark:bg-stone-900 dark:text-stone-200">

    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <header class="relative text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900 dark:text-amber-500">Recetario Delicioso</h1>
            <p class="text-gray-600 dark:text-stone-400 mt-2">150 recetas para inspirar tu cocina.</p>
            <div id="user-info" class="text-xs text-gray-400 mt-2"></div>
            
            <div class="absolute top-0 left-0"> 
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-stone-700 focus:outline-none">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 101.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zM6.464 16.364l-.707.707a1 1 0 001.414 1.414l.707-.707a1 1 0 00-1.414-1.414zM13.536 16.364a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414l.707.707z"></path></svg>
                </button>
            </div>
        </header>
        
        <div class="sticky top-4 bg-f8f7f5/90 dark:bg-stone-900/90 backdrop-blur-sm z-10 py-4 rounded-xl shadow-sm">
            <div class="flex flex-col sm:flex-row gap-4 mb-4 px-4">
                <div class="relative flex-grow">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre o ingrediente..." class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-stone-600 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white dark:bg-stone-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <div class="flex items-center justify-center shrink-0 gap-2 bg-amber-100 dark:bg-stone-800 p-1 rounded-full">
                    <button id="filterAll" class="filter-btn px-4 py-2 rounded-full text-sm font-medium">Todas</button>
                    <button id="filterFavorites" class="filter-btn px-4 py-2 rounded-full text-sm font-medium">Favoritas</button>
                </div>
            </div>
            <div id="categoryFilters" class="flex items-center justify-start sm:justify-center gap-2 bg-amber-50 dark:bg-stone-800 p-2 rounded-full mx-4">
                <button data-category="all" class="category-btn active px-3 py-1.5 rounded-full text-sm">Todos</button>
                <button data-category="Aperitivo" class="category-btn px-3 py-1.5 rounded-full text-sm">Aperitivos</button>
                <button data-category="Primero" class="category-btn px-3 py-1.5 rounded-full text-sm">Primeros</button>
                <button data-category="Segundo" class="category-btn px-3 py-1.5 rounded-full text-sm">Segundos</button>
                <button data-category="Postre" class="category-btn px-3 py-1.5 rounded-full text-sm">Postres</button>
            </div>
            <div id="timeFilters" class="flex items-center justify-start sm:justify-center gap-2 bg-amber-50 dark:bg-stone-800 p-2 rounded-full mx-4 mt-2">
                <span class="text-sm text-gray-600 dark:text-stone-400 font-medium">Tiempo:</span>
                <button data-time="all" class="time-filter-btn active px-3 py-1.5 rounded-full text-sm">Cualquiera</button>
                <button data-time="short" class="time-filter-btn px-3 py-1.5 rounded-full text-sm">Rápida (&lt;30 min)</button>
                <button data-time="medium" class="time-filter-btn px-3 py-1.5 rounded-full text-sm">Media (30-60 min)</button>
                <button data-time="long" class="time-filter-btn px-3 py-1.5 rounded-full text-sm">Larga (&gt;60 min)</button>
            </div>
             <button id="viewShoppingListBtn" class="mt-4 mx-4 w-auto bg-amber-700 hover:bg-amber-800 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75V11a.75.75 0 01-1.5 0V2.75A.75.75 0 0110 2zM5.5 9.75a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5H6.25a.75.75 0 01-.75-.75zM10 18a.75.75 0 01-.75-.75V12a.75.75 0 011.5 0v5.25a.75.75 0 01-.75.75z" clip-rule="evenodd" />
                </svg>
                Ver Lista de Compra (<span id="shopping-list-count">0</span>)
            </button>
        </div>

        <div id="no-results" class="hidden text-center py-12">
            <p class="text-gray-600 dark:text-stone-400">No se encontraron recetas. ¡Intenta otra búsqueda o filtro!</p>
        </div>

        <div id="recipeGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-6 mt-8">
            </div>
    </div>

    <div id="recipeModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="modalContent" class="bg-white dark:bg-stone-800 rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"></div>
    </div>
    
    <div id="shoppingListModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-stone-800 rounded-2xl shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-3xl font-bold text-amber-900 dark:text-amber-500">Tu Lista de Compra</h2>
                <button id="closeShoppingListModalBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-stone-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <ul id="finalShoppingList" class="list-disc list-inside space-y-2 text-gray-700 dark:text-stone-300 mb-6">
                </ul>
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="clearShoppingListBtn" class="bg-red-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-700 transition shadow-lg">Vaciar Lista</button>
                <button id="printShoppingListBtn" class="bg-gray-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-gray-600 transition shadow-lg">Imprimir Lista</button>
            </div>
        </div>
    </div>

    <div id="cooking-mode-view" class="fixed inset-0 bg-white dark:bg-stone-900 z-50 hidden flex-col">
        <div id="cooking-step-content" class="flex-grow flex flex-col justify-center items-center p-8 text-center">
            <p id="step-counter" class="text-lg text-amber-600 dark:text-amber-400 font-semibold mb-4"></p>
            <p id="step-text" class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-100"></p>
            <div id="active-timers-container" class="mt-8 flex flex-wrap justify-center gap-4"></div>
        </div>
        <div id="cooking-controls" class="p-4 bg-slate-100 dark:bg-stone-800 grid grid-cols-3 gap-4">
            <button id="prev-step-btn" class="p-4 rounded-lg bg-slate-200 dark:bg-stone-700 text-slate-700 dark:text-slate-200 font-bold">Anterior</button>
            <button id="repeat-step-btn" class="p-4 rounded-lg bg-amber-500 text-white font-bold col-span-1">Repetir</button>
            <button id="next-step-btn" class="p-4 rounded-lg bg-slate-200 dark:bg-stone-700 text-slate-700 dark:text-slate-200 font-bold">Siguiente</button>
        </div>
        <button id="exit-cooking-btn" class="absolute top-4 right-4 p-2 bg-slate-100 dark:bg-stone-700 rounded-full">
            <svg class="w-6 h-6 text-slate-600 dark:text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <div id="toast-container"></div>


    <footer class="text-center mt-12 py-4 border-t border-gray-200 dark:border-stone-700">
        <p class="text-sm text-gray-500 dark:text-stone-400">
            &copy; <span id="copyright-year"></span> Luis Miguel Garcia De Las Morenas. Todos los derechos reservados.
        </p>
    </footer>
    
    <script type="module">
        // --- CONSOLIDACIÓN DE IMPORTACIONES Y CONFIGURACIÓN DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js"; 

        function runRecipeApp() {
            const firebaseConfig = {
                apiKey: "AIzaSyBnYukeJLJHs9lLNpnGYHRZ58SVE3CpTBQ", // <--- ¡Asegúrate de pegar tu API Key real aquí!
                authDomain: "lucid-copilot-454618-k7.firebaseapp.com",
                projectId: "lucid-copilot-454618-k7",
                storageBucket: "lucid-copilot-454618-k7.firebasestorage.app",
                messagingSenderId: "948763528254",
                appId: "1:948763528254:web:3eba3d724edf844528956f", 
                measurementId: "G-256GP1S7YX" 
            };

            const appId = firebaseConfig.appId;

            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app); 

            const db = getFirestore(app);
            const auth = getAuth(app);

            let userFavorites = [], userId = null;
            let currentFilter = 'all', currentCategory = 'all';
            let currentTimeFilter = 'all'; 

            let shoppingList = []; 

            const dom = {
                grid: document.getElementById('recipeGrid'),
                search: document.getElementById('searchInput'),
                filterAllBtn: document.getElementById('filterAll'),
                filterFavBtn: document.getElementById('filterFavorites'),
                categoryFilters: document.getElementById('categoryFilters'),
                timeFilters: document.getElementById('timeFilters'), 
                noResults: document.getElementById('no-results'),
                modal: document.getElementById('recipeModal'),
                modalContent: document.getElementById('modalContent'),
                userInfo: document.getElementById('user-info'),
                themeToggle: document.getElementById('theme-toggle'),
                darkIcon: document.getElementById('theme-toggle-dark-icon'),
                lightIcon: document.getElementById('theme-toggle-light-icon'),
                copyrightYear: document.getElementById('copyright-year'),
                viewShoppingListBtn: document.getElementById('viewShoppingListBtn'), 
                shoppingListCount: document.getElementById('shopping-list-count'), 
                shoppingListModal: document.getElementById('shoppingListModal'), 
                closeShoppingListModalBtn: document.getElementById('closeShoppingListModalBtn'),
                finalShoppingList: document.getElementById('finalShoppingList'),
                clearShoppingListBtn: document.getElementById('clearShoppingListBtn'),
                printShoppingListBtn: document.getElementById('printShoppingListBtn'),
                toastContainer: document.getElementById('toast-container'),
                activeTimersContainer: document.getElementById('active-timers-container') // Nuevo elemento DOM
            };
            
            const allRecipes = [
                // 25 Aperitivos
                { categoria: "Aperitivo", titulo: "Brochetas de aceituna y pimiento", raciones: 4, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Brochetas+Aceituna", ingredientes: ["Aceitunas verdes y negras", "Pimiento rojo troceado", "Hojas de albahaca", "Aceite de oliva", "Pimienta negra"], pasos: ["Ensarta aceitunas, pimiento y albahaca en palillos.", "Aliña con aceite y pimienta.", "Sirve frío."] },
                { categoria: "Aperitivo", titulo: "Garbanzos crujientes al horno", raciones: 2, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Garbanzos+Crujientes", ingredientes: ["200 g garbanzos cocidos", "1 cda. AOVE", "1/2 cdita pimentón ahumado", "1/4 cdita comino", "Sal"], pasos: ["Mezcla garbanzos con aceite y especias.", "Hornea 35 min a 180 °C.", "Enfría y sirve."] },
                { categoria: "Aperitivo", titulo: "Hummus clásico con crudités", raciones: 4, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Hummus+Crudites", ingredientes: ["400 g garbanzos cocidos", "2 cdas. tahini", "1 diente de ajo", "Zumo de 1 limón", "Aceite de oliva", "Palitos de zanahoria y apio"], pasos: ["Tritura los garbanzos con tahini, ajo, limón y aceite.", "Sirve con los crudités de verdura."] },
                { categoria: "Aperitivo", titulo: "Guacamole rápido", raciones: 3, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Guacamole+Rapido", ingredientes: ["2 aguacates maduros", "1/2 cebolla morada", "1 tomate pequeño", "Zumo de 1 lima", "Sal", "Nachos de maíz integral"], pasos: ["Tritura el aguacate con la cebolla, tomate y lima.", "Sirve con nachos o verduras."] },
                { categoria: "Aperitivo", titulo: "Rollitos de jamón y espárragos", raciones: 2, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Rollitos+Jamon+Esparragos", ingredientes: ["5 lonchas de jamón serrano", "5 espárragos verdes cocidos", "Aceite de oliva"], pasos: ["Enrolla cada espárrago con jamón.", "Rocía con un poco de aceite y sirve frío."] },
                { categoria: "Aperitivo", titulo: "Chips de kale al horno", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Chips+Kale+Horno", ingredientes: ["Hojas de kale", "1 cda. aceite de oliva", "Sal marina"], pasos: ["Lava y seca bien las hojas.", "Rocía con aceite y sal.", "Hornea 15 min a 150 °C."] },
                { categoria: "Aperitivo", titulo: "Dip de yogur y pepino", raciones: 4, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Dip+Yogur+Pepino", ingredientes: ["1 yogur natural", "1/2 pepino rallado", "1 diente de ajo", "Hierbabuena", "Sal y pimienta"], pasos: ["Mezcla todos los ingredientes.", "Sirve frío con pan pita o verduras."] },
                { categoria: "Aperitivo", titulo: "Tomates cherry rellenos de queso", raciones: 3, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tomates+Rellenos+Queso", ingredientes: ["Tomates cherry", "Queso crema light", "Cebollino picado"], pasos: ["Corta la tapa a los tomates.", "Rellena con queso y decora con cebollino."] },
                { categoria: "Aperitivo", titulo: "Tostadas integrales con aguacate", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tostadas+Aguacate", ingredientes: ["2 rebanadas de pan integral", "1 aguacate", "Zumo de limón", "Pimienta y sal"], pasos: ["Tritura el aguacate y mezcla con limón y sal.", "Unta sobre las tostadas y añade pimienta."] },
                { categoria: "Aperitivo", titulo: "Mini tortillas de espinaca", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Mini+Tortillas+Espinaca", ingredientes: ["2 huevos", "Un puñado de espinacas frescas", "1 cda. queso rallado light", "Sal"], pasos: ["Bate los huevos, añade espinaca y queso.", "Cocina en sartén pequeña o molde al horno."] },
                { categoria: "Aperitivo", titulo: "Palitos de zanahoria al horno", raciones: 3, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Palitos+Zanahoria+Horno", ingredientes: ["2 zanahorias grandes", "1 cda. aceite de oliva", "Pimienta", "Pimentón dulce"], pasos: ["Corta zanahorias en tiras.", "Condimenta con aceite y especias.", "Hornea 25 min a 180 °C."] },
                { categoria: "Aperitivo", titulo: "Edamame con sal y limón", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Edamame+Sal+Limon", ingredientes: ["200 g edamame congelado", "Sal marina", "Zumo de limón"], pasos: ["Hierve el edamame 5 minutos.", "Escurre, rocía con limón y añade sal."] },
                { categoria: "Aperitivo", titulo: "Tostas de hummus y tomate seco", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tostas+Hummus+Tomate", ingredientes: ["2 tostadas integrales", "2 cdas. hummus", "Tomate seco en tiras"], pasos: ["Unta el hummus sobre las tostadas.", "Decora con tomate seco."] },
                { categoria: "Aperitivo", titulo: "Aceitunas marinadas caseras", raciones: 4, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Aceitunas+Marinadas", ingredientes: ["Aceitunas verdes", "Aceite de oliva", "Ajo picado", "Orégano"], pasos: ["Mezcla todos los ingredientes.", "Deja reposar 1 hora antes de servir."] },
                { categoria: "Aperitivo", titulo: "Gazpacho ligero de remolacha", raciones: 4, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Gazpacho+Remolacha", ingredientes: ["3 tomates maduros", "1 remolacha cocida", "1/2 pepino", "Ajo, sal, aceite y vinagre"], pasos: ["Tritura todos los ingredientes hasta obtener una mezcla fina.", "Sirve muy frío."] },
                { categoria: "Aperitivo", titulo: "Canapés de salmón y queso crema", raciones: 4, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Canapes+Salmon", ingredientes: ["Pan tostado", "Salmón ahumado", "Queso crema light", "Eneldo fresco"], pasos: ["Unta el pan con queso crema.", "Coloca el salmón encima y decora con eneldo."] },
                { categoria: "Aperitivo", titulo: "Crema fría de aguacate", raciones: 3, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Aguacate", ingredientes: ["2 aguacates", "Zumo de 1 lima", "Caldo de verduras frío", "Cilantro", "Sal"], pasos: ["Tritura los aguacates con el zumo de lima y el caldo.", "Añade cilantro y sal, y sirve muy frío."] },
                { categoria: "Aperitivo", titulo: "Bastones de pepino con hummus", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pepino+Hummus", ingredientes: ["1 pepino", "Hummus casero o comprado"], pasos: ["Corta el pepino en bastones.", "Sirve con el hummus para mojar."] },
                { categoria: "Aperitivo", titulo: "Chips de batata al horno", raciones: 3, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Chips+Batata+Horno", ingredientes: ["1 batata grande", "1 cda. aceite de oliva", "Pimentón dulce", "Sal"], pasos: ["Corta la batata en rodajas finas.", "Mézclala con aceite, pimentón y sal.", "Hornea a 180°C hasta que estén crujientes."] },
                { categoria: "Aperitivo", titulo: "Brochetas Caprese mini", raciones: 4, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Brochetas+Caprese", ingredientes: ["Tomates cherry", "Bolas de mozzarella mini", "Hojas de albahaca fresca", "Aceite de oliva virgen extra", "Vinagre balsámico"], pasos: ["Ensarta un tomate, una bola de mozzarella y una hoja de albahaca en cada palillo.", "Aliña con aceite de oliva y vinagre balsámico al gusto."] },
                { categoria: "Aperitivo", titulo: "Paté de berenjena (Baba Ghanoush)", raciones: 4, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pate+Berenjena", ingredientes: ["1 berenjena grande", "2 cdas. tahini", "Zumo de 1/2 limón", "1 diente de ajo", "Aceite de oliva", "Comino molido", "Sal y perejil picado"], pasos: ["Asa la berenjena hasta que esté tierna y retira la pulpa.", "Tritura la pulpa con tahini, limón, ajo, aceite, comino y sal hasta obtener una crema suave.", "Sirve decorado con perejil."] },
                { categoria: "Aperitivo", titulo: "Rollitos de calabacín y queso", raciones: 3, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Rollitos+Calabacin", ingredientes: ["1 calabacín", "100 g queso fresco batido", "Hojas de menta", "Sal y pimienta"], pasos: ["Corta el calabacín en láminas finas y pásalas por la plancha.", "Mezcla el queso fresco con la menta picada, sal y pimienta.", "Rellena cada lámina de calabacín con la mezcla de queso y enrolla."] },
                { categoria: "Aperitivo", titulo: "Pincho de tortilla de patatas", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pincho+Tortilla", ingredientes: ["2 huevos", "1 patata pequeña", "1/4 cebolla", "Aceite de oliva", "Sal"], pasos: ["Pela y corta la patata y la cebolla en trozos pequeños, sofríe en aceite.", "Bate los huevos, añade la patata y cebolla escurridas y sal.", "Cuaja la tortilla en una sartén pequeña por ambos lados.", "Corta en pinchos."] },
                { categoria: "Aperitivo", titulo: "Vasitos de gazpacho con langostinos", raciones: 4, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Vasitos+Gazpacho", ingredientes: ["2 tomates maduros", "1/4 pepino", "1/4 pimiento verde", "1/4 diente de ajo", "Aceite de oliva", "Vinagre", "Sal", "8 langostinos cocidos"], pasos: ["Prepara el gazpacho triturando los ingredientes y colándolo.", "Sirve el gazpacho frío en vasitos pequeños y decora con un langostino en cada uno."] },
                { categoria: "Aperitivo", titulo: "Brochetas de pollo satay mini", raciones: 3, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Brochetas+Pollo+Satay", ingredientes: ["150 g pechuga de pollo", "1 cda. salsa de cacahuete", "1/2 cdita. curry en polvo", "Palillos de brocheta"], pasos: ["Corta el pollo en dados y marina con la salsa de cacahuete y curry.", "Ensarta el pollo en mini brochetas y cocina a la plancha hasta que estén doradas."] },
                // 5 Nuevos Aperitivos Típicos Españoles (previos)
                { categoria: "Aperitivo", titulo: "Patatas Bravas Caseras", raciones: 4, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Patatas+Bravas", ingredientes: ["4 patatas medianas", "Aceite de oliva virgen extra", "Sal", "Para la salsa brava: 1 cebolla", "2 dientes de ajo", "1 lata tomate triturado (400g)", "1 cda. pimentón dulce", "1/2 cdita. pimentón picante", "Caldo de pollo o verdura (100ml)"], pasos: ["Pela y corta las patatas en dados, fríelas hasta que estén doradas y crujientes.", "Para la salsa: sofríe la cebolla y el ajo. Añade el tomate, pimentones y caldo. Cocina 15 min a fuego lento. Tritura.", "Sirve las patatas con la salsa por encima."] },
                { categoria: "Aperitivo", titulo: "Gambas al Ajillo", raciones: 2, tiempo: "10 min", imagen: "http://googleusercontent.com/image_generation_content/0", ingredientes: ["250 g gambas peladas", "4 dientes de ajo", "1 guindilla (opcional)", "Aceite de oliva virgen extra", "Perejil fresco picado", "Sal"], pasos: ["En una cazuela de barro, calienta el aceite. Añade el ajo laminado y la guindilla.", "Cuando el ajo dore, incorpora las gambas y cocina 2-3 min hasta que cambien de color.", "Retira del fuego, añade perejil picado y sirve burbujeando."] },
                { categoria: "Aperitivo", titulo: "Pan con Tomate y Jamón", raciones: 2, tiempo: "5 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pan+Tomate+Jamon", ingredientes: ["2 rebanadas de pan de pueblo", "1 tomate maduro", "1 diente de ajo (opcional)", "Aceite de oliva virgen extra", "Sal", "4 lonchas de jamón serrano"], pasos: ["Tuesta el pan. Frota el tomate sobre el pan tostado (puedes frotar un diente de ajo antes).", "Rocía con aceite de oliva y un poco de sal.", "Coloca las lonchas de jamón serrano por encima y sirve."] },
                { categoria: "Aperitivo", titulo: "Banderillas de Encurtidos", raciones: 4, tiempo: "5 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Banderillas+Encurtidos", ingredientes: ["10 aceitunas rellenas", "10 pepinillos en vinagre", "10 cebolletas en vinagre", "10 trozos de pimiento rojo asado (de bote)", "10 boquerones en vinagre (opcional)"], pasos: ["Ensarta los ingredientes en palillos de brocheta en el orden deseado.", "Sirve en un plato como aperitivo frío."] },
                { categoria: "Aperitivo", titulo: "Pintxo de Gilda", raciones: 2, tiempo: "5 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pintxo+Gilda", ingredientes: ["4 guindillas en vinagre", "4 aceitunas rellenas de anchoa", "2 filetes de anchoa en aceite"], pasos: ["Ensarta en un palillo una guindilla, una aceituna y dobla un filete de anchoa.", "Repite el proceso para hacer 2 pintxos por ración. Sirve inmediatamente."] },
                // NUEVAS RECETAS APERITIVOS (6 para llegar a 37)
                { categoria: "Aperitivo", titulo: "Montadito de Sobrasada y Miel", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Montadito+Sobrasada+Miel", ingredientes: ["4 rebanadas de pan tostado", "50 g sobrasada", "1 cda. miel", "Opcional: un poco de queso fresco"], pasos: ["Unta la sobrasada sobre las rebanadas de pan tostado.", "Rocía con miel por encima.", "Si deseas, añade una pequeña cantidad de queso fresco antes de la miel y sirve al momento."] },
                { categoria: "Aperitivo", titulo: "Croquetas de Jamón Caseras", raciones: 4, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Croquetas+Jamon", ingredientes: ["100 g jamón serrano picado", "50 g harina de trigo", "50 g mantequilla", "500 ml leche entera", "Nuez moscada", "Sal", "1 huevo batido", "Pan rallado", "Aceite de oliva para freír"], pasos: ["Prepara una bechamel: derrite la mantequilla, añade la harina y cocina 2 min. Incorpora la leche caliente poco a poco sin dejar de remover hasta que espese. Añade el jamón y nuez moscada. Cocina 5 min más.", "Extiende la masa en una bandeja y deja enfriar completamente (mín. 4 horas o toda la noche en nevera).", "Forma las croquetas, pásalas por huevo batido y luego por pan rallado. Fríe en abundante aceite caliente hasta que estén doradas por todos lados. Escurre sobre papel absorbente y sirve calientes."] },
                { categoria: "Aperitivo", titulo: "Boquerones en Vinagre Caseros", raciones: 4, tiempo: "20 min + 48h congelado", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Boquerones+Vinagre", ingredientes: ["500 g boquerones frescos", "250 ml vinagre de vino blanco", "150 ml agua", "Sal (abundante)", "4 dientes de ajo laminados", "Perejil fresco picado", "Aceite de oliva virgen extra"], pasos: ["Limpia los boquerones, retirando cabeza, tripas y espina central. Ábrelos en forma de mariposa. Lava bien bajo el grifo. CONGELA los boquerones limpios por al menos 48 horas (por seguridad parasitaria).", "Descongela los boquerones. Prepara la mezcla de marinado: mezcla vinagre, agua y sal en un recipiente. Sumerge los boquerones limpios y déjalos en la nevera unas 6-8 horas hasta que se blanqueen.", "Escurre bien los boquerones del marinado. Colócalos en un recipiente y cúbrelos con aceite de oliva, ajo laminado y perejil picado. Deja macerar en la nevera al menos 2 horas antes de servir. Pueden durar varios días en la nevera bien cubiertos de aceite."] },
                { categoria: "Aperitivo", titulo: "Tabla de Embutidos y Quesos Españoles", raciones: 4, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tabla+Embutidos", ingredientes: ["100 g jamón ibérico", "100 g chorizo ibérico", "100 g salchichón ibérico", "150 g queso manchego semicurado", "100 g queso de cabra curado", "Picos de pan o tostadas", "Aceitunas"], pasos: ["Dispón el jamón en lonchas finas. Corta el chorizo, salchichón y quesos en rodajas o cuñas. Para el queso manchego, corta en cuñas o triángulos.", "Presenta todos los embutidos y quesos de forma atractiva en una tabla de madera o plato grande. Acompaña con picos de pan, tostadas y unas aceitunas para complementar.", "Sirve a temperatura ambiente para que los sabores se realcen. Puedes añadir un poco de membrillo junto al queso."] },
                { categoria: "Aperitivo", titulo: "Ensaladilla Rusa Tradicional", raciones: 4, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensaladilla+Rusa", ingredientes: ["3 patatas medianas", "2 zanahorias", "100 g guisantes (frescos o congelados)", "2 latas de atún en aceite (escurrido)", "2 huevos duros", "Mayonesa (casera o comercial)", "Aceitunas rellenas (para decorar)", "Sal"], pasos: ["Cuece las patatas y zanahorias, peladas y troceadas, hasta que estén tiernas. Cuece los guisantes por separado. Escurre y deja enfriar todas las verduras.", "Pica finamente las patatas y zanahorias cocidas. En un bol grande, mezcla las verduras con los guisantes.", "Desmenuza el atún y añádelo a las verduras. Incorpora la mayonesa y mezcla bien hasta integrar todos los ingredientes. Ajusta de sal.", "Pica los huevos duros y decora la ensaladilla con ellos y las aceitunas rellenas. Refrigera al menos 1 hora antes de servir para que los sabores se asienten."] },
                { categoria: "Aperitivo", titulo: "Pimientos de Padrón Fritos", raciones: 3, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pimientos+Padron", ingredientes: ["250 g pimientos de Padrón", "Aceite de oliva virgen extra (para freír)", "Sal gorda marina"], pasos: ["Lava y seca muy bien los pimientos de Padrón. Es crucial que estén secos para evitar salpicaduras al freír.", "En una sartén con base ancha, calienta abundante aceite de oliva a fuego medio-alto. Una vez caliente, añade los pimientos en una sola capa, sin amontonarlos para que se frían uniformemente.", "Fríe los pimientos, dándoles la vuelta ocasionalmente, hasta que estén tiernos, ligeramente arrugados y con la piel burbujeante y algunas zonas tostadas. Esto suele tardar unos 5-7 minutos.", "Retira los pimientos con una espumadera y colócalos sobre papel absorbente para eliminar el exceso de aceite. Inmediatamente después, espolvorea generosamente con sal gorda marina. Sirve calientes. Recuerda: unos pican y otros no!"] },
                // NUEVAS RECETAS APERITIVOS (6 para llegar a 37)
                { categoria: "Aperitivo", titulo: "Champiñones al Ajillo", raciones: 3, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Champinones+Ajillo", ingredientes: ["300 g champiñones frescos", "4 dientes de ajo laminados", "1 guindilla (opcional)", "Perejil fresco picado", "Aceite de oliva virgen extra", "Sal"], pasos: ["Limpia los champiñones y córtalos por la mitad o en cuartos si son grandes.", "En una sartén con un buen chorro de aceite, dora los ajos laminados y la guindilla. Añade los champiñones y saltea a fuego fuerte hasta que suelten su agua y se doren.", "Salpimenta al gusto y añade el perejil picado. Cocina un par de minutos más y sirve caliente."] },
                { categoria: "Aperitivo", titulo: "Cogollos con Anchoas", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Cogollos+Anchoas", ingredientes: ["2 cogollos de Tudela", "8 filetes de anchoa en aceite", "Aceite de oliva virgen extra", "Vinagre de Jerez (opcional)"], pasos: ["Lava y corta los cogollos por la mitad o en cuartos a lo largo.", "Colócalos en un plato y distribuye los filetes de anchoa por encima.", "Rocía con un buen chorro de aceite de oliva y, si te gusta, unas gotas de vinagre de Jerez. Sirve frío."] },
                { categoria: "Aperitivo", titulo: "Espárragos con Mayonesa", raciones: 2, tiempo: "5 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Esparragos+Mayonesa", ingredientes: ["1 bote de espárragos blancos gruesos (6-8 unidades)", "Mayonesa (al gusto)", "Opcional: pimiento rojo asado en tiras"], pasos: ["Escurre bien los espárragos del líquido de la conserva y colócalos en un plato.", "Cubre los espárragos con una generosa cantidad de mayonesa.", "Si deseas, decora con unas tiras de pimiento rojo asado. Sirve frío."] },
                { categoria: "Aperitivo", titulo: "Pimientos Rellenos de Brandada de Bacalao", raciones: 4, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pimientos+Brandada", ingredientes: ["1 lata de pimientos del piquillo enteros", "250 g bacalao desalado y desmigado", "100 ml nata líquida para cocinar", "2 dientes de ajo", "Aceite de oliva", "Perejil picado"], pasos: ["Sofríe los ajos en aceite. Añade el bacalao desmigado y cocina unos minutos. Incorpora la nata y cocina a fuego suave hasta que espese. Tritura ligeramente hasta obtener una brandada. Rellena los pimientos del piquillo con la brandada. Gratina en el horno unos minutos y decora con perejil."] },
                { categoria: "Aperitivo", titulo: "Ensalada de Naranja y Bacalao (Remojón)", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Remojon", ingredientes: ["2 naranjas", "200 g bacalao desalado desmigado", "1/2 cebolla morada", "Aceitunas negras sin hueso", "Aceite de oliva virgen extra", "Vinagre de vino (opcional)"], pasos: ["Pela las naranjas a vivo, retirando toda la parte blanca, y córtalas en rodajas o gajos. Desmiga el bacalao.", "Corta la cebolla morada en juliana fina. En un bol, mezcla la naranja, el bacalao, la cebolla y las aceitunas.", "Aliña con abundante aceite de oliva y, si lo deseas, un chorrito de vinagre. Mezcla suavemente y sirve frío."] },
                { categoria: "Aperitivo", titulo: "Tostas de Escalivada", raciones: 3, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Escalivada", ingredientes: ["1 berenjena", "1 pimiento rojo", "1 cebolla", "Pan de hogaza (rebanadas)", "Aceite de oliva virgen extra", "Sal", "Opcional: anchoas"], pasos: ["Asa la berenjena, el pimiento y la cebolla enteros en el horno a 180°C hasta que estén muy tiernos y la piel se pueda retirar (aprox. 45-50 min). También puedes asar en el fuego o a la parrilla.", "Una vez asados, retira la piel de las verduras y córtalas en tiras. Mezcla las tiras de verdura en un bol y aliña con aceite de oliva y sal.", "Tuesta las rebanadas de pan. Monta la escalivada sobre el pan tostado. Si lo deseas, coloca un filete de anchoa encima. Sirve templado o frío."] },


                // 25 Primeros
                { categoria: "Primero", titulo: "Ensalada de quinoa con verduras", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Quinoa", ingredientes: ["1 taza de quinoa cocida", "Pimiento rojo y verde", "Tomates cherry", "Cebolla morada", "Aceite de oliva", "Zumo de limón"], pasos: ["Mezcla la quinoa con las verduras picadas.", "Aliña con aceite y limón."] },
                { categoria: "Primero", titulo: "Sopa de lentejas rojas", raciones: 4, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Lentejas+Rojas", ingredientes: ["1 taza lentejas rojas", "1 zanahoria", "1 cebolla", "1 diente de ajo", "1 cdita comino", "Sal y pimienta"], pasos: ["Sofríe ajo, cebolla y zanahoria picados.", "Agrega lentejas y agua, cocina 20 min.", "Tritura si deseas una textura cremosa."] },
                { categoria: "Primero", titulo: "Crema de calabaza", raciones: 4, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Calabaza", ingredientes: ["500 g calabaza", "1 puerro", "1 patata", "Aceite de oliva", "Sal y nuez moscada"], pasos: ["Cocina calabaza, patata y puerro en agua.", "Tritura con aceite y nuez moscada."] },
                { categoria: "Primero", titulo: "Ensalada de garbanzos mediterránea", raciones: 3, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Garbanzos", ingredientes: ["400 g garbanzos cocidos", "Pepino", "Tomate", "Cebolla morada", "Aceitunas negras", "Limón y aceite"], pasos: ["Mezcla todos los ingredientes picados.", "Aliña con limón y aceite."] },
                { categoria: "Primero", titulo: "Gazpacho andaluz tradicional", raciones: 4, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Gazpacho+Andaluz", ingredientes: ["1 kg tomates maduros", "1 pepino", "1/2 pimiento verde", "1 diente de ajo", "Aceite de oliva", "Vinagre de jerez", "Sal"], pasos: ["Tritura todos los ingredientes hasta obtener una sopa fina.", "Sirve muy frío, opcionalmente con picatostes."] },
                { categoria: "Primero", titulo: "Tabulé de bulgur con hierbas", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tabule+Bulgur+Hierbas", ingredientes: ["1 taza de bulgur cocido", "1 tomate", "1/2 pepino", "1/2 cebolla", "Zumo de limón", "Menta fresca", "Perejil fresco", "Aceite de oliva", "Sal"], pasos: ["Pica las verduras y hierbas finamente.", "Mezcla con el bulgur, limón y aceite.", "Refrigera antes de servir para que los sabores se asienten."] },
                { categoria: "Primero", titulo: "Crema de zanahoria y jengibre", raciones: 4, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Zanahoria+Jengibre", ingredientes: ["4 zanahorias", "1 patata", "1 trozo de jengibre fresco", "1 cda. aceite de oliva", "Sal y pimienta"], pasos: ["Hierve zanahorias, patata y jengibre hasta que estén tiernos.", "Tritura con un poco del agua de cocción y aliña."] },
                { categoria: "Primero", titulo: "Ensalada de lentejas con vinagreta", raciones: 3, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Lentejas+Vinagreta", ingredientes: ["1 taza lentejas cocidas", "Pimiento rojo", "Zanahoria", "Cebolla", "1 cda. mostaza", "Aceite de oliva", "Vinagre de vino"], pasos: ["Corta finas las verduras y mezcla con lentejas.", "Prepara una vinagreta con mostaza, aceite y vinagre, y aliña la ensalada."] },
                { categoria: "Primero", titulo: "Sopa miso con tofu y algas", raciones: 2, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Miso+Tofu", ingredientes: ["750 ml agua", "1 cda. pasta miso", "Tofu en cubos", "Alga wakame seca", "Cebolleta picada"], pasos: ["Calienta el agua y disuelve el miso.", "Añade tofu, alga wakame (previamente hidratada) y cebolleta.", "Calienta sin hervir para no perder propiedades del miso."] },
                { categoria: "Primero", titulo: "Crema de espinacas cremosa", raciones: 4, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Espinacas+Cremosa", ingredientes: ["200 g espinacas frescas", "1 patata mediana", "1 puerro pequeño", "500 ml caldo de verduras", "Aceite de oliva", "Sal"], pasos: ["Sofríe el puerro, añade las espinacas y la patata troceada.", "Cubre con caldo y cuece hasta que esté tierno.", "Tritura y ajusta de sal."] },
                { categoria: "Primero", titulo: "Ensalada de arroz integral y atún", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Arroz+Atun", ingredientes: ["1 taza de arroz integral cocido", "1 lata de atún al natural", "Maíz dulce", "Tomates cherry", "Pepino", "Aceite de oliva", "Vinagre de manzana"], pasos: ["Mezcla el arroz cocido con el atún escurrido, maíz, tomates y pepino troceado.", "Aliña con aceite y vinagre."] },
                { categoria: "Primero", titulo: "Sopa de pollo y fideos", raciones: 4, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Pollo+Fideos", ingredientes: ["1 litro de caldo de pollo", "100 g fideos finos", "Trocitos de pechuga de pollo cocida", "Zanahoria y apio picados"], pasos: ["Calienta el caldo y añade la zanahoria y el apio.", "Cuando estén tiernos, agrega el pollo y los fideos.", "Cocina hasta que los fideos estén listos."] },
                { categoria: "Primero", titulo: "Puré de patata y calabacín", raciones: 3, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pure+Patata+Calabacin", ingredientes: ["2 patatas", "1 calabacín", "50 ml leche desnatada", "Sal", "Nuez moscada"], pasos: ["Hierve las patatas y el calabacín hasta que estén muy tiernos.", "Escurre, aplasta y mezcla con leche, sal y nuez moscada hasta obtener un puré suave."] },
                { categoria: "Primero", titulo: "Ensalada César ligera", raciones: 2, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Cesar+Ligera", ingredientes: ["Lechuga romana", "Pechuga de pollo a la plancha", "Picatostes integrales", "Queso parmesano bajo en grasa", "Salsa César light"], pasos: ["Corta la lechuga y el pollo.", "Mezcla todos los ingredientes con la salsa César ligera."] },
                { categoria: "Primero", titulo: "Crema de champiñones", raciones: 4, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Champiñones", ingredientes: ["300 g champiñones", "1 cebolla", "500 ml caldo de verduras", "1 cda. maicena", "Aceite de oliva", "Perejil"], pasos: ["Sofríe la cebolla y los champiñones.", "Añade el caldo y la maicena disuelta.", "Cocina hasta espesar y tritura. Decora con perejil."] },
                { categoria: "Primero", titulo: "Salmorejo cordobés tradicional", raciones: 4, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Salmorejo+Cordobes", ingredientes: ["1 kg tomates maduros", "200 g pan de telera (o pan blanco duro)", "1 diente de ajo", "100 ml aceite de oliva virgen extra", "Sal", "Huevo duro y jamón serrano para decorar (opcional)"], pasos: ["Remoja el pan en agua.", "Tritura los tomates, el pan escurrido, el ajo y la sal.", "Emulsiona con el aceite hasta obtener una crema homogénea.", "Sirve frío, decorado con huevo duro y jamón si lo deseas."] },
                { categoria: "Primero", titulo: "Ensalada de pasta integral con verduras", raciones: 3, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Pasta+Integral", ingredientes: ["200 g pasta integral", "Pimiento rojo", "Maíz", "Aceitunas verdes", "Tomates cherry", "Aceite de oliva", "Orégano"], pasos: ["Cuece la pasta. Enfría.", "Mezcla la pasta con las verduras.", "Aliña con aceite y orégano."] },
                { categoria: "Primero", titulo: "Sopa de verduras casera", raciones: 4, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Verduras+Casera", ingredientes: ["1 zanahoria", "1 puerro", "1 patata", "Un puñado de judías verdes", "Caldo de verduras", "Sal y pimienta"], pasos: ["Corta todas las verduras en trozos pequeños.", "Hierve en el caldo hasta que estén tiernas.", "Ajusta de sal y pimienta."] },
                { categoria: "Primero", titulo: "Crema de guisantes con menta", raciones: 3, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Guisantes+Menta", ingredientes: ["300 g guisantes (frescos o congelados)", "1 cebolleta", "Menta fresca", "Caldo de verduras", "Aceite de oliva"], pasos: ["Sofríe la cebolleta, añade los guisantes y el caldo.", "Cocina unos minutos y tritura con unas hojas de menta."] },
                { categoria: "Primero", titulo: "Ensalada de remolacha y queso de cabra", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Remolacha+Queso", ingredientes: ["2 remolachas cocidas", "100 g queso de cabra", "Nueces", "Rúcula", "Vinagreta de miel y mostaza"], pasos: ["Corta la remolacha en cubos y el queso en medallones.", "Combina con rúcula y nueces.", "Aliña con una vinagreta de miel y mostaza."] },
                { categoria: "Primero", titulo: "Crema de espárragos verdes", raciones: 4, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Esparragos", ingredientes: ["500 g espárragos verdes", "1 patata", "1 cebolla", "Caldo de verduras", "Nata líquida ligera (opcional)", "Sal y pimienta"], pasos: ["Sofríe la cebolla, añade los espárragos troceados y la patata.", "Cubre con caldo y cuece hasta que estén tiernos.", "Tritura y pasa por un colador para una crema fina. Añade nata si quieres una textura más cremosa."] },
                { categoria: "Primero", titulo: "Sopa de ajo castellana", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Ajo+Castellana", ingredientes: ["4 dientes de ajo", "4 rebanadas de pan duro", "1 cdita. pimentón dulce", "Caldo de pollo o verduras", "Aceite de oliva", "Huevo (opcional)"], pasos: ["Lamina los ajos y sofríelos en aceite. Añade el pan troceado y el pimentón.", "Cubre con caldo y cuece unos 10-15 minutos.", "Sirve caliente, opcionalmente con un huevo escalfado."] },
                { categoria: "Primero", titulo: "Ensalada de cuscús con pasas y piñones", raciones: 3, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Cuscús", ingredientes: ["1 taza de cuscús", "1.5 tazas de agua o caldo", "1/4 taza de pasas", "2 cdas. piñones tostados", "Pepino y tomate picado", "Aceite de oliva", "Zumo de limón", "Menta fresca"], pasos: ["Hidrata el cuscús con el agua caliente.", "Mezcla con pasas, piñones, pepino, tomate, aceite, limón y menta picada.", "Deja reposar antes de servir."] },
                { categoria: "Primero", titulo: "Crema de calabacín y manzana", raciones: 4, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Calabacin+Manzana", ingredientes: ["2 calabacines", "1 manzana verde", "1/2 cebolla", "Caldo de verduras", "Aceite de oliva", "Sal"], pasos: ["Sofríe la cebolla, añade el calabacín y la manzana troceados.", "Cubre con caldo y cuece hasta que estén tiernos.", "Tritura hasta obtener una crema suave."] },
                { categoria: "Primero", titulo: "Salpicón de marisco ligero", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Salpicon+Marisco", ingredientes: ["100 g gambas cocidas y peladas", "100 g pulpo cocido", "1/2 cebolla morada", "1/2 pimiento rojo", "Perejil fresco", "Aceite de oliva", "Vinagre de vino", "Sal"], pasos: ["Corta el marisco y las verduras en trozos pequeños.", "Mezcla todo en un bol.", "Aliña con aceite, vinagre y sal. Sirve frío."] },
                // 5 Nuevos Primeros Típicos Españoles (previos)
                { categoria: "Primero", titulo: "Cocido Madrileño (Sopa)", raciones: 4, tiempo: "90 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Cocido+Madrileno+Sopa", ingredientes: ["200 g garbanzos (previamente en remojo)", "100 g fideos finos", "1 zanahoria", "1 puerro", "1 trozo de carne de res (jarrete)", "1 trozo de hueso de jamón", "Agua", "Sal"], pasos: ["Cocer los garbanzos, carne y hueso en olla a presión hasta que estén tiernos.", "Retirar la carne y el hueso. Colar el caldo y desgrasar. Volver a calentar.", "Añadir la zanahoria y el puerro picados, y los fideos. Cocinar hasta que los fideos estén listos.", "Servir caliente. La carne y los garbanzos se sirven aparte."] },
                { categoria: "Primero", titulo: "Sopa de Pescado y Marisco", raciones: 4, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Pescado+Marisco", ingredientes: ["200 g pescado blanco (merluza)", "100 g gambas", "1 cebolla", "2 tomates", "1 diente de ajo", "Perejil", "1 litro de caldo de pescado", "Aceite de oliva", "Sal y pimienta"], pasos: ["Sofríe la cebolla, ajo y tomate picados. Añade el pescado en trozos y las gambas.", "Cubre con caldo y cocina 15 min. Salpimenta.", "Tritura ligeramente una parte si quieres una sopa más espesa. Sirve con perejil."] },
                { categoria: "Primero", titulo: "Judiones de la Granja", raciones: 3, tiempo: "120 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Judiones+Granja", ingredientes: ["250 g judiones (alubias grandes, en remojo)", "100 g chorizo", "50 g panceta", "1 cebolla", "1 diente de ajo", "Pimentón dulce", "Agua", "Sal"], pasos: ["Cocer los judiones con chorizo y panceta hasta que estén tiernos (en olla a presión 30-40 min).", "Sofríe cebolla y ajo, añade pimentón y agrega a las judías.", "Cocinar a fuego lento 20 min más para que los sabores se mezclen. Ajustar de sal."] },
                { categoria: "Primero", titulo: "Crema de Marisco (Suave)", raciones: 4, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Marisco", ingredientes: ["200 g langostinos o gambas", "1 cebolla", "1 puerro", "1 zanahoria", "2 cdas. arroz", "1 litro de caldo de pescado", "50 ml nata líquida para cocinar", "Aceite de oliva", "Sal y pimienta"], pasos: ["Sofríe las verduras picadas. Añade las cabezas y pieles de los langostinos (reservar cuerpos) y sofríe.", "Incorpora el arroz y el caldo. Cocina 20 min.", "Tritura y cuela. Vuelve al fuego, añade la nata y los cuerpos de langostino troceados. Calienta sin hervir. Sirve."] },
                { categoria: "Primero", titulo: "Potaje de Garbanzos y Espinacas", raciones: 3, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Potaje+Garbanzos", ingredientes: ["400 g garbanzos cocidos", "200 g espinacas frescas", "1 cebolla", "2 dientes de ajo", "1 rebanada de pan frito", "1 huevo duro", "Pimentón dulce", "Caldo de verduras", "Aceite de oliva", "Sal"], pasos: ["Sofríe cebolla y ajo. Añade las espinacas y cocina hasta que se reduzcan.", "Haz un majado con el pan frito y un poco de ajo. Incorpora al sofrito.", "Añade los garbanzos y el caldo. Cocina 15 min. Sirve con huevo duro troceado."] },
                // NUEVAS RECETAS PRIMEROS (6 para llegar a 37)
                { categoria: "Primero", titulo: "Ensalada de Pasta Mediterránea", raciones: 4, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Ensalada+Pasta", ingredientes: ["250 g pasta corta", "1 pimiento rojo", "1 pepino", "100 g queso feta", "50 g aceitunas negras", "Tomates cherry", "Aceite de oliva virgen extra", "Orégano", "Sal y pimienta"], pasos: ["Cuece la pasta al dente y enfría.", "Corta las verduras y el queso feta en dados.", "Mezcla la pasta con las verduras, el queso feta y las aceitunas.", "Aliña con aceite de oliva, orégano, sal y pimienta al gusto. Sirve fría."] },
                { categoria: "Primero", titulo: "Lentejas Estofadas a la Española", raciones: 4, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Lentejas+Estofadas", ingredientes: ["250 g lentejas pardinas", "100 g chorizo (troceado)", "50 g panceta (troceada)", "1 zanahoria", "1 patata pequeña", "1 cebolla", "2 dientes de ajo", "1 cdita. pimentón dulce", "1 hoja de laurel", "Caldo de carne o agua (1 litro)", "Aceite de oliva", "Sal"], pasos: ["Lava las lentejas y ponlas a remojo si no son pardinas (las pardinas no necesitan remojo).", "En una olla, sofríe en aceite la cebolla picada y el ajo. Añade el chorizo y la panceta y cocina unos minutos.", "Incorpora la zanahoria y patata troceadas, el pimentón y el laurel. Remueve.", "Añade las lentejas escurridas y el caldo (o agua). Lleva a ebullición, luego baja el fuego y cocina a fuego lento durante 45-60 minutos, o hasta que las lentejas estén tiernas. Ajusta de sal al final."] },
                { categoria: "Primero", titulo: "Patatas a la Riojana", raciones: 3, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Patatas+Riojana", ingredientes: ["500 g patatas", "150 g chorizo fresco (para cocinar)", "1 pimiento verde", "1 cebolla", "2 dientes de ajo", "1 cda. pimentón dulce", "Caldo de carne o agua (aprox. 500 ml)", "1 hoja de laurel", "Aceite de oliva", "Sal"], pasos: ["En una cazuela con aceite, sofríe la cebolla y el pimiento verde picados. Añade el ajo laminado.", "Incorpora el chorizo en rodajas y cocina hasta que suelte su grasa. Retira el exceso de grasa si lo deseas.", "Añade el pimentón dulce y remueve rápidamente para que no se queme. Inmediatamente después, añade las patatas cascadas (rotas en lugar de cortadas para que suelten el almidón y espesen la salsa).", "Cubre con el caldo (o agua) hasta que las patatas estén casi cubiertas. Añade la hoja de laurel y sal. Cocina a fuego medio-bajo unos 20-25 minutos, o hasta que las patatas estén tiernas y el caldo haya espesado. Remueve de vez en cuando. Sirve caliente."] },
                { categoria: "Primero", titulo: "Sopa de Cocido Casera", raciones: 4, tiempo: "15 min (si hay caldo)", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Cocido", ingredientes: ["1 litro de caldo de cocido (desgrasado)", "100 g fideos finos o arroz", "Opcional: trozos de garbanzos, carne o verdura del cocido"], pasos: ["Cuela el caldo del cocido para eliminar impurezas y desgrásalo (retira la capa de grasa superior una vez frío).", "Lleva el caldo a ebullición en una olla. Si deseas, añade algunos garbanzos o trozos pequeños de carne y verdura del cocido original.", "Incorpora los fideos finos (o arroz) y cocina según las instrucciones del paquete, hasta que estén en su punto. El tiempo suele ser de 3 a 5 minutos para fideos finos.", "Sirve la sopa bien caliente. Es un excelente primer plato para un cocido completo o como plato único ligero."] },
                { categoria: "Primero", titulo: "Arroz a Banda (Versión Express)", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Arroz+a+Banda", ingredientes: ["150 g arroz bomba", "500 ml caldo de pescado (fume) caliente", "100 g gambas peladas", "100 g calamares limpios (en aros o trozos)", "1 tomate maduro rallado", "1 diente de ajo picado", "Unas hebras de azafrán o colorante alimentario", "Aceite de oliva virgen extra", "Sal"], pasos: ["En una paella o sartén ancha, calienta un poco de aceite. Sofríe las gambas y los calamares rápidamente hasta que cambien de color. Retira y reserva.", "En el mismo aceite, sofríe el ajo picado. Añade el tomate rallado y cocina hasta que el agua se evapore y el sofrito se dore un poco.", "Incorpora el arroz y rehógalo unos minutos para que absorba los sabores. Añade el azafrán (previamente disuelto en un poco de caldo caliente si usas hebras).", "Vierte el caldo de pescado muy caliente. Cocina a fuego medio-alto durante unos 10 minutos, luego baja el fuego a medio-bajo y cocina 8-10 minutos más, o hasta que el arroz haya absorbido el caldo y esté en su punto. No remuevas demasiado.", "Reparte por encima las gambas y calamares reservados en los últimos minutos de cocción. Deja reposar fuera del fuego 5 minutos tapado antes de servir. Tradicionalmente se acompaña con alioli."] },
                { categoria: "Primero", titulo: "Pisto Manchego Casero", raciones: 4, tiempo: "50 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pisto+Manchego", ingredientes: ["1 cebolla grande", "2 pimientos verdes italianos", "1 pimiento rojo", "1 calabacín mediano", "1 berenjena mediana", "400 g tomate triturado (natural o de lata)", "Aceite de oliva virgen extra", "Sal", "Azúcar (una pizca, para el tomate)"], pasos: ["Lava y corta todas las verduras en dados de tamaño similar: cebolla, pimientos, calabacín y berenjena.", "En una sartén grande o cazuela con un buen chorro de aceite de oliva, empieza sofriendo la cebolla a fuego medio hasta que esté transparente. Añade los pimientos (verde y rojo) y cocina hasta que se ablanden (unos 10-15 minutos).", "Incorpora el calabacín y la berenjena. Sube un poco el fuego y cocina, removiendo ocasionalmente, hasta que las verduras empiecen a dorarse ligeramente (unos 10-15 minutos más).", "Finalmente, añade el tomate triturado, una pizca de azúcar para corregir la acidez del tomate y sal al gusto. Baja el fuego y cocina a fuego lento, removiendo de vez en cuando, durante al menos 20-30 minutos, o hasta que el pisto esté bien pochado y el tomate haya reducido su líquido. Las verduras deben quedar muy tiernas y sabrosas. Sirve caliente o templado, solo o como acompañamiento de huevos fritos, carnes o pescados."] },
                // NUEVAS RECETAS PRIMEROS (6 para llegar a 37)
                { categoria: "Primero", titulo: "Gazpacho de Sandía", raciones: 4, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Gazpacho+Sandia", ingredientes: ["500 g sandía sin pepitas", "2 tomates maduros", "1/4 pepino", "1/4 pimiento verde", "1/4 diente de ajo", "Aceite de oliva virgen extra", "Vinagre de vino", "Sal"], pasos: ["Trocea la sandía, los tomates, el pepino, el pimiento y el ajo. Tritura todos los ingredientes en una batidora hasta obtener una crema fina y homogénea.", "Pasa el gazpacho por un colador fino para eliminar posibles grumos o restos de pepitas. Ajusta de sal y vinagre al gusto.", "Refrigera el gazpacho en la nevera por al menos 1 hora antes de servir. Sirve muy frío, opcionalmente decorado con un trozo de sandía o unas hojas de menta."] },
                { categoria: "Primero", titulo: "Sopa Fría de Melón con Jamón", raciones: 2, tiempo: "10 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sopa+Melon+Jamon", ingredientes: ["500 g melón maduro", "50 ml nata líquida para cocinar (o yogur natural)", "Una pizca de sal", "Virutas de jamón serrano (para decorar)"], pasos: ["Corta el melón, retira las pepitas y la piel. Trocea la pulpa y tritúrala en una batidora hasta obtener una crema muy fina.", "Añade la nata líquida (o yogur) y una pizca de sal. Vuelve a triturar brevemente para integrar.", "Refrigera la sopa de melón por al menos 1 hora para que esté bien fría. Sirve en copas o cuencos pequeños, decorada con unas virutas de jamón serrano por encima."] },
                { categoria: "Primero", titulo: "Alubias con Chorizo", raciones: 4, tiempo: "90 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Alubias+Chorizo", ingredientes: ["250 g alubias blancas (en remojo la noche anterior)", "150 g chorizo para cocinar", "50 g panceta fresca", "1 cebolla", "2 dientes de ajo", "1 hoja de laurel", "Pimentón dulce", "Caldo de carne o agua", "Aceite de oliva", "Sal"], pasos: ["Escurre las alubias de su remojo. En una olla, sofríe en aceite la cebolla y los ajos picados. Añade el chorizo y la panceta en trozos y sofríe unos minutos.", "Incorpora el pimentón y remueve rápidamente. Añade las alubias escurridas, la hoja de laurel y cubre con caldo o agua. Lleva a ebullición.", "Baja el fuego, tapa y cocina a fuego lento durante 1 hora y 15 minutos a 1 hora y 30 minutos, o hasta que las alubias estén tiernas. Remueve ocasionalmente y añade más líquido si es necesario. Ajusta de sal al final."] },
                { categoria: "Primero", titulo: "Garbanzos con Bacalao", raciones: 4, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Garbanzos+Bacalao", ingredientes: ["400 g garbanzos cocidos", "250 g bacalao desalado", "1 cebolla", "2 dientes de ajo", "1 pimiento verde", "400 g tomate triturado", "Pimentón dulce", "Caldo de pescado o agua", "Aceite de oliva", "Sal", "Huevo duro (opcional)"], pasos: ["Sofríe la cebolla, pimiento y ajos picados en aceite. Añade el tomate triturado y una pizca de pimentón, cocina el sofrito 10-15 minutos.", "Incorpora los garbanzos cocidos y el bacalao desalado y desmigado. Cubre con caldo de pescado o agua y cocina a fuego medio-bajo durante 15-20 minutos para que se mezclen los sabores.", "Sirve caliente, opcionalmente decorado con huevo duro picado."] },
                { categoria: "Primero", titulo: "Fideuá de Marisco", raciones: 4, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Fideua+Marisco", ingredientes: ["250 g fideos para fideuá (cabello de ángel o finos)", "200 g gambas peladas", "200 g calamares limpios", "1 cebolla", "2 tomates maduros", "1 diente de ajo", "1 litro caldo de pescado", "Aceite de oliva", "Sal"], pasos: ["En una paella o sartén ancha, tuesta los fideos en un poco de aceite hasta que estén dorados. Retira y reserva.", "En la misma paella, sofríe la cebolla y el ajo picados. Añade los calamares en trozos y cocina unos minutos. Incorpora el tomate rallado y cocina hasta que se reduzca.", "Añade las gambas y rehoga brevemente. Vierte el caldo de pescado muy caliente. Cuando hierva, añade los fideos tostados y extiéndelos uniformemente.", "Cocina a fuego medio-alto durante unos 10-15 minutos, o hasta que los fideos hayan absorbido el caldo y estén cocidos. Deja reposar unos minutos antes de servir."] },
                { categoria: "Primero", titulo: "Crema de Coliflor Gratinada", raciones: 4, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Crema+Coliflor", ingredientes: ["1 coliflor mediana", "1 patata", "1 cebolla pequeña", "500 ml caldo de verduras", "50 ml nata líquida para cocinar", "Queso rallado para gratinar", "Aceite de oliva", "Sal", "Nuez moscada"], pasos: ["Limpia la coliflor y córtala en ramilletes. Pela y trocea la patata y la cebolla.", "En una olla, sofríe la cebolla en aceite. Añade la coliflor y la patata. Cubre con el caldo de verduras y cocina hasta que las verduras estén muy tiernas.", "Tritura la crema hasta obtener una textura suave. Añade la nata, un poco de nuez moscada y ajusta de sal. Calienta sin hervir.", "Vierte la crema en cuencos individuales aptos para horno, espolvorea queso rallado por encima y gratina en el horno hasta que el queso esté dorado. Sirve caliente."] },

                // 25 Segundos
                { categoria: "Segundo", titulo: "Pollo al horno con limón y hierbas", raciones: 2, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pollo+Horno+Limon", ingredientes: ["2 pechugas de pollo", "1 limón", "Tomillo", "Romero", "Aceite de oliva", "Sal y pimienta"], pasos: ["Marina el pollo con zumo de limón, hierbas, aceite, sal y pimienta.", "Hornea 25 minutos a 200°C."] },
                { categoria: "Segundo", titulo: "Salmón a la plancha con espárragos", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Salmon+Plancha+Esparragos", ingredientes: ["2 lomos de salmón", "1 manojo de espárragos verdes", "Aceite de oliva", "Sal en escamas", "Pimienta"], pasos: ["Cocina el salmón y los espárragos a la plancha con un poco de aceite.", "Sazona con sal y pimienta al servir."] },
                { categoria: "Segundo", titulo: "Wok de ternera y brócoli", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Wok+Ternera+Brocoli", ingredientes: ["200 g ternera en tiras", "1 brócoli", "Salsa de soja baja en sodio", "Jengibre rallado", "Aceite de sésamo"], pasos: ["Saltea la ternera en un wok.", "Añade el brócoli y cocina hasta que esté tierno.", "Adereza con soja, jengibre y aceite de sésamo."] },
                { categoria: "Segundo", titulo: "Pavo a la plancha con puré de manzana", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pavo+Plancha+Pure+Manzana", ingredientes: ["2 filetes de pavo", "2 manzanas", "Canela", "Sal"], pasos: ["Cocina el pavo a la plancha.", "Asa las manzanas y tritúralas con canela para hacer el puré.", "Sirve el pavo con el puré."] },
                { categoria: "Segundo", titulo: "Merluza en salsa verde", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Merluza+Salsa+Verde", ingredientes: ["2 lomos de merluza", "1 diente de ajo", "Perejil fresco", "1/2 vaso de vino blanco", "Caldo de pescado", "Guisantes"], pasos: ["Sofríe el ajo y perejil.", "Añade la merluza, vino y caldo.", "Cocina 10 minutos y agrega los guisantes."] },
                { categoria: "Segundo", titulo: "Berenjenas rellenas de carne picada", raciones: 2, tiempo: "50 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Berenjenas+Rellenas+Carne", ingredientes: ["2 berenjenas", "200 g carne picada de pavo", "Cebolla", "Tomate triturado", "Queso rallado light"], pasos: ["Asa las berenjenas y vacía la pulpa.", "Sofríe la carne con cebolla y tomate, mezcla con la pulpa.", "Rellena, espolvorea queso y gratina."] },
                { categoria: "Segundo", titulo: "Tofu salteado con verduras", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tofu+Salteado+Verduras", ingredientes: ["200 g tofu firme", "Pimiento", "Calabacín", "Cebolla", "Salsa de soja"], pasos: ["Corta el tofu y las verduras.", "Saltea todo en un wok con un poco de salsa de soja."] },
                { categoria: "Segundo", titulo: "Pechuga de pollo a la naranja", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pechuga+Pollo+Naranja", ingredientes: ["2 pechugas de pollo", "Zumo de 2 naranjas", "1 cdita maicena", "Sal y pimienta"], pasos: ["Dora el pollo en una sartén.", "Mezcla el zumo con la maicena, vierte sobre el pollo y cocina hasta que espese."] },
                { categoria: "Segundo", titulo: "Atún a la plancha con ensalada", raciones: 2, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Atun+Plancha+Ensalada", ingredientes: ["2 filetes de atún fresco", "Tomates cherry", "Rúcula", "Vinagre balsámico"], pasos: ["Cocina el atún a la plancha, vuelta y vuelta.", "Sirve con una ensalada de tomates y rúcula, aliñada con balsámico."] },
                { categoria: "Segundo", titulo: "Solomillo de cerdo con champiñones", raciones: 2, tiempo: "35 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Solomillo+Cerdo+Champiñones", ingredientes: ["1 solomillo de cerdo", "200 g champiñones", "1/2 cebolla", "Nata líquida light", "Sal y pimienta"], pasos: ["Sella el solomillo y reserva.", "Sofríe la cebolla y los champiñones, añade la nata y tritura.", "Sirve el solomillo con la salsa."] },
                { categoria: "Segundo", titulo: "Lasaña de verduras ligera", raciones: 4, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Lasagna+Verduras+Ligera", ingredientes: ["Láminas de lasaña integral", "Calabacín", "Berenjena", "Pimiento", "Tomate triturado", "Queso rallado light"], pasos: ["Saltea las verduras picadas con el tomate.", "Monta la lasaña alternando capas de pasta y verduras.", "Cubre con queso y hornea."] },
                { categoria: "Segundo", titulo: "Bacalao con sofrito de tomate", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Bacalao+Sofrito+Tomate", ingredientes: ["2 lomos de bacalao desalado", "1 cebolla", "400 g tomate triturado", "Aceite de oliva", "Sal"], pasos: ["Sofríe la cebolla, añade el tomate y cocina 15 min.", "Incorpora el bacalao y cocina 10 min más hasta que esté en su punto."] },
                { categoria: "Segundo", titulo: "Curry de garbanzos y espinacas", raciones: 3, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Curry+Garbanzos+Espinacas", ingredientes: ["400 g garbanzos cocidos", "200 g espinacas", "1 cebolla", "Leche de coco light", "Curry en polvo", "Jengibre fresco (opcional)"], pasos: ["Sofríe la cebolla, añade el curry (y jengibre).", "Incorpora los garbanzos y la leche de coco, cocina 5 min.", "Añade las espinacas y cocina hasta que se reduzcan."] },
                { categoria: "Segundo", titulo: "Sepia a la plancha con alioli suave", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Sepia+Plancha+Alioli", ingredientes: ["1 sepia grande y limpia", "2 dientes de ajo", "Perejil fresco", "Aceite de oliva", "Limón", "Alioli ligero (opcional)"], pasos: ["Corta la sepia en trozos.", "Cocina a la plancha hasta que esté dorada.", "Sirve con un majado de ajo y perejil o alioli ligero."] },
                { categoria: "Segundo", titulo: "Hamburguesas de pollo caseras", raciones: 2, tiempo: "25 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Hamburguesas+Pollo+Caseras", ingredientes: ["300 g carne picada de pollo", "1/2 cebolla pequeña", "Huevo", "Pan rallado integral", "Sal y especias al gusto"], pasos: ["Mezcla la carne con la cebolla picada, huevo, pan rallado y especias.", "Forma las hamburguesas y cocina a la plancha.", "Sirve con ensalada o en pan integral."] },
                { categoria: "Segundo", titulo: "Dorada al papillote con verduras", raciones: 1, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Dorada+Papillote+Verduras", ingredientes: ["1 dorada limpia", "Verduras variadas (calabacín, zanahoria, pimiento)", "Aceite de oliva", "Hierbas aromáticas", "Sal y pimienta"], pasos: ["Corta las verduras en juliana.", "Coloca la dorada sobre papel de horno con las verduras.", "Aliña y cierra el papillote.", "Hornea 20-25 min a 180°C."] },
                { categoria: "Segundo", titulo: "Muslos de pollo con arroz integral", raciones: 2, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Muslos+Pollo+Arroz+Integral", ingredientes: ["2 muslos de pollo sin piel", "1 taza de arroz integral", "Caldo de pollo", "Cebolla", "Pimiento", "Aceite de oliva"], pasos: ["Dora los muslos de pollo.", "Sofríe la cebolla y el pimiento.", "Añade el arroz y el caldo, cocina hasta que el arroz esté listo."] },
                { categoria: "Segundo", titulo: "Calabacines rellenos de arroz y verduras", raciones: 2, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Calabacines+Rellenos+Arroz", ingredientes: ["2 calabacines grandes", "1 taza de arroz cocido", "Champiñones", "Tomate triturado", "Queso light rallado"], pasos: ["Corta los calabacines por la mitad y vacía.", "Saltea la pulpa con champiñones, tomate y arroz.", "Rellena los calabacines, cubre con queso y hornea."] },
                { categoria: "Segundo", titulo: "Pinchos de gambas y piña a la plancha", raciones: 2, tiempo: "15 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pinchos+Gambas+Piña", ingredientes: ["200 g gambas peladas", "Piña natural en trozos", "Aceite de oliva", "Pimentón dulce", "Limón"], pasos: ["Ensarta gambas y piña en brochetas.", "Cocina a la plancha con un poco de aceite.", "Espolvorea pimentón y rocía con limón antes de servir."] },
                { categoria: "Segundo", titulo: "Huevos revueltos con espárragos y setas", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Huevos+Revueltos+Esparragos", ingredientes: ["3 huevos", "1 manojo de espárragos trigueros", "100 g setas variadas", "Aceite de oliva", "Sal y pimienta"], pasos: ["Saltea los espárragos y las setas en una sartén.", "Añade los huevos batidos y remueve hasta que cuajen al gusto.", "Salpimenta y sirve."] },
                { categoria: "Segundo", titulo: "Albóndigas de pollo en salsa de tomate", raciones: 3, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Albondigas+Pollo", ingredientes: ["300 g carne picada de pollo", "1/2 cebolla", "Pan rallado", "1 huevo", "400 g tomate triturado", "Aceite de oliva", "Sal y orégano"], pasos: ["Mezcla el pollo picado con cebolla rallada, pan rallado, huevo y sal.", "Forma albóndigas y dóralas en una sartén.", "Añade el tomate triturado y orégano, cocina a fuego lento 20 minutos."] },
                { categoria: "Segundo", titulo: "Pescado al horno con patatas panaderas", raciones: 2, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pescado+Horno+Patatas", ingredientes: ["2 filetes de pescado blanco (merluza, bacalao)", "2 patatas medianas", "1 cebolla", "Aceite de oliva", "Sal y perejil"], pasos: ["Corta las patatas y cebolla en rodajas finas.", "Colócalas en una bandeja de horno con aceite y sal.", "Hornea 20 minutos a 180°C. Añade el pescado y hornea 15 minutos más. Sirve con perejil."] },
                { categoria: "Segundo", titulo: "Champiñones rellenos de verduras", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Champinones+Rellenos", ingredientes: ["8 champiñones grandes", "1/2 pimiento", "1/2 cebolla", "Pulpa de champiñones", "Queso light rallado"], pasos: ["Limpia los champiñones y pica los tallos y las verduras.", "Sofríe las verduras con la pulpa de los champiñones.", "Rellena los sombreros, espolvorea queso y gratina."] },
                { categoria: "Segundo", titulo: "Brochetas de verduras a la parrilla", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Brochetas+Verduras", ingredientes: ["Calabacín", "Berenjena", "Pimiento", "Cebolla", "Tomates cherry", "Aceite de oliva", "Hierbas provenzales", "Palillos de brocheta"], pasos: ["Corta las verduras en trozos, ensártalas en los palillos.", "Aliña con aceite y hierbas.", "Cocina en parrilla o sartén hasta que estén tiernas y doradas."] },
                { categoria: "Segundo", titulo: "Pollo estilo oriental con arroz basmati", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pollo+Oriental", ingredientes: ["200 g pechuga de pollo", "1/2 pimiento rojo", "1/2 cebolla", "Salsa de soja", "Jengibre", "Arroz basmati cocido"], pasos: ["Corta el pollo y las verduras en tiras.", "Saltea en un wok con jengibre y salsa de soja.", "Sirve con arroz basmati."] },
                // 5 Nuevos Segundos Típicos Españoles (previos)
                { categoria: "Segundo", titulo: "Paella de Marisco (Vegetariana)", raciones: 4, tiempo: "50 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Paella+Marisco", ingredientes: ["300 g arroz redondo", "100 g garrofón", "100 g judía verde plana", "1 tomate maduro", "1/2 cebolla", "1 diente de ajo", "Pimentón dulce", "Azafrán o colorante alimentario", "1 litro caldo de verduras", "Aceite de oliva", "Sal"], pasos: ["Sofríe la cebolla, ajo, judía verde y garrofón. Añade el tomate rallado y pimentón.", "Incorpora el arroz y rehoga. Añade el caldo caliente con azafrán.", "Cocina a fuego medio-alto 18 min, luego 2 min a fuego fuerte para el 'socarrat'. Deja reposar."] },
                { categoria: "Segundo", titulo: "Tortilla de Patatas Española", raciones: 4, tiempo: "40 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Tortilla+Patatas", ingredientes: ["500 g patatas", "1 cebolla grande (opcional)", "6 huevos grandes", "Aceite de oliva virgen extra", "Sal"], pasos: ["Pela y corta las patatas en láminas finas. Si usas cebolla, córtala en juliana.", "Fríe las patatas (y cebolla) en abundante aceite a fuego medio-bajo hasta que estén blandas.", "Escurre bien el aceite. Bate los huevos con sal. Mezcla las patatas con los huevos.", "Cuaja la tortilla en una sartén antiadherente con un poco de aceite, volteando para dorar por ambos lados. Sirve caliente o templada."] },
                { categoria: "Segundo", titulo: "Bacalao a la Vizcaína", raciones: 2, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Bacalao+Vizcaina", ingredientes: ["400 g lomos de bacalao desalado", "3 cebollas grandes", "2 dientes de ajo", "3 pimientos choriceros (previamente hidratados)", "100 ml caldo de pescado", "Aceite de oliva", "Sal"], pasos: ["Sofríe las cebollas cortadas en juliana hasta que estén muy pochadas. Añade el ajo laminado.", "Añade la pulpa de los pimientos choriceros y un poco de caldo. Cocina 10 min.", "Coloca los lomos de bacalao en la salsa y cocina a fuego lento unos 10-15 min, moviendo suavemente para que la salsa ligue. Rectifica de sal."] },
                { categoria: "Segundo", titulo: "Pescado al Horno con Verduras Mediterráneas", raciones: 2, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pescado+Verduras+Horno", ingredientes: ["2 rodajas de merluza o dorada", "1 calabacín", "1 berenjena", "1 pimiento rojo", "1 cebolla", "Tomates cherry", "Aceite de oliva", "Hierbas provenzales", "Sal y pimienta"], pasos: ["Corta las verduras en rodajas o dados. Colócalas en una bandeja de horno.", "Rocía con aceite, sal, pimienta y hierbas. Hornea 15 min a 180°C.", "Añade el pescado sobre las verduras y hornea 15-20 min más hasta que el pescado esté hecho."] },
                { categoria: "Segundo", titulo: "Fabada Asturiana (Adaptada)", raciones: 4, tiempo: "120 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Fabada+Asturiana", ingredientes: ["250 g fabes (alubias blancas, en remojo)", "100 g chorizo asturiano", "50 g morcilla asturiana", "50 g lacón o panceta curada", "1 cebolla", "Ajo", "Agua", "Sal"], pasos: ["Cocer las fabes con el chorizo, morcilla y lacón en agua fría. Llevar a ebullición y 'asustar' (añadir un chorro de agua fría tres veces).", "Cocinar a fuego lento durante 1.5 - 2 horas o hasta que las fabes estén muy tiernas. Puedes usar olla a presión (30-40 min).", "Sofríe un poco de cebolla y ajo, tritúralo y añádelo a la fabada para espesar. Ajustar de sal. Dejar reposar antes de servir."] },
                // NUEVAS RECETAS SEGUNDOS (6) - Carnes Variadas (contando 5 anteriores + 1 nueva)
                { categoria: "Segundo", titulo: "Estofado de Ternera con Patatas", raciones: 4, tiempo: "90 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Estofado+Ternera", ingredientes: ["500 g ternera para estofado", "2 patatas grandes", "2 zanahorias", "1 cebolla", "200 ml caldo de carne", "100 ml vino tinto", "Harina para rebozar", "Aceite de oliva", "Sal y pimienta"], pasos: ["Corta la ternera en dados, salpimenta y pasa por harina. Dora en aceite.", "En la misma olla, sofríe cebolla y zanahorias. Añade la ternera, el vino y el caldo.", "Cocina a fuego lento por 1 hora. Añade las patatas troceadas y cocina 30 min más hasta que todo esté tierno."] },
                { categoria: "Segundo", titulo: "Conejo al Ajillo con Romesco", raciones: 2, tiempo: "45 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Conejo+Ajillo", ingredientes: ["1 conejo troceado", "6 dientes de ajo", "Ramas de romero fresco", "100 ml vino blanco", "Aceite de oliva virgen extra", "Sal y pimienta", "Salsa Romesco para acompañar"], pasos: ["Salpimenta el conejo y dóralo en una sartén con aceite. Retira.", "En el mismo aceite, dora los ajos laminados y el romero. Añade el conejo, vierte el vino y cocina hasta que se evapore el alcohol.", "Cubre con un poco de agua o caldo y cocina a fuego lento hasta que el conejo esté tierno (unos 30 min). Sirve con salsa Romesco."] },
                { categoria: "Segundo", titulo: "Chuletas de Cordero a la Parrilla", raciones: 2, tiempo: "20 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Chuletas+Cordero", ingredientes: ["4 chuletas de cordero", "Aceite de oliva", "Sal en escamas", "Pimienta negra recién molida", "Ajo granulado (opcional)"], pasos: ["Saca las chuletas de la nevera 15 min antes. Salpimenta y si quieres, añade ajo granulado.", "Calienta bien una sartén o parrilla con un poco de aceite.", "Cocina las chuletas 3-4 min por cada lado para un punto medio, o más si te gustan bien hechas.", "Deja reposar un par de minutos antes de servir."] },
                { categoria: "Segundo", titulo: "Pinchos Morunos de Cerdo", raciones: 3, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pinchos+Morunos", ingredientes: ["300 g carne de cerdo (lomo o aguja)", "1 cebolla pequeña", "1 pimiento verde", "Palillos de brocheta", "Para la marinada: 2 cda. especias para pinchos morunos", "1 cda. aceite de oliva", "Zumo de 1/2 limón", "Sal"], pasos: ["Corta la carne en dados. Prepara la marinada con las especias, aceite, limón y sal. Marina la carne al menos 30 min (idealmente 2 horas).", "Corta la cebolla y el pimiento en trozos. Ensarta la carne alternando con cebolla y pimiento.", "Cocina los pinchos en una plancha o parrilla caliente hasta que la carne esté dorada y cocida por dentro. Sirve calientes."] },
                { categoria: "Segundo", titulo: "Pollo Asado con Hierbas y Patatas", raciones: 4, tiempo: "75 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Pollo+Asado", ingredientes: ["1 pollo entero (aprox. 1.2 kg)", "4 patatas medianas", "2 dientes de ajo", "Ramas de romero y tomillo", "Aceite de oliva", "Sal y pimienta"], pasos: ["Precalienta el horno a 190°C. Lava y seca bien el pollo.", "Frota el pollo por dentro y por fuera con aceite, sal, pimienta, ajos machacados, romero y tomillo.", "Corta las patatas en gajos y mézclalas con un poco de aceite, sal y pimienta.", "Coloca el pollo en una fuente de horno con las patatas alrededor. Hornea durante 60-70 minutos, volteando las patatas a mitad de cocción, hasta que el pollo esté dorado y cocido."] },
                { categoria: "Segundo", titulo: "Marmitako (Atún con Patatas)", raciones: 4, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Marmitako", ingredientes: ["500 g bonito o atún fresco", "500 g patatas", "1 cebolla", "1 pimiento verde", "2 tomates maduros", "Caldo de pescado", "Aceite de oliva", "Sal", "Perejil picado"], pasos: ["Sofríe la cebolla, el pimiento y el tomate picados hasta que estén blandos. Añade las patatas cascadas.", "Cubre con caldo de pescado y cocina hasta que las patatas estén casi tiernas.", "Incorpora el bonito o atún en dados y cocina unos minutos hasta que esté hecho. Sirve caliente con perejil."] },
                { categoria: "Segundo", titulo: "Fricandó de Ternera", raciones: 4, tiempo: "90 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Fricando+Ternera", ingredientes: ["500 g filetes finos de ternera (babilla o tapa)", "20 g setas deshidratadas (moixernons, senderuelas o setas variadas)", "1 cebolla grande", "1 tomate maduro", "30 g almendras tostadas", "1 cda. piñones", "Harina para rebozar", "200 ml vino blanco seco", "400 ml caldo de carne", "Aceite de oliva virgen extra", "Sal", "Pimienta negra"], pasos: ["Pon las setas deshidratadas en remojo en agua tibia durante al menos 30 minutos. Escurre y reserva el agua del remojo.", "Salpimenta los filetes de ternera y pásalos ligeramente por harina. Sella los filetes en una cazuela ancha con un poco de aceite hasta que estén dorados. Retira y reserva.", "En la misma cazuela, sofríe la cebolla picada hasta que esté bien pochada. Añade el tomate rallado y cocina hasta que se reduzca.", "Incorpora las setas escurridas al sofrito y cocina unos minutos. Vierte el vino blanco y deja reducir el alcohol.", "Vuelve a añadir la ternera a la cazuela y cubre con el caldo de carne y parte del agua de remojo de las setas (colada). Cocina a fuego lento durante 45-60 minutos, o hasta que la carne esté muy tierna.", "Mientras, prepara la picada: tritura las almendras tostadas y los piñones (puedes añadir un diente de ajo pequeño si quieres) con un poco de caldo hasta obtener una pasta. Añade esta picada a la cazuela en los últimos 10 minutos de cocción, removiendo para que la salsa espese. Sirve caliente."] },
                { categoria: "Segundo", titulo: "Conejo a la Cazadora", raciones: 2, tiempo: "60 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=Conejo+Cazadora", ingredientes: ["1 conejo troceado", "1 cebolla", "200 g champiñones laminados", "100 g bacon o panceta", "100 ml vino tinto", "200 ml caldo de pollo", "2 dientes de ajo", "Tomillo fresco", "Aceite de oliva", "Sal y pimienta"], pasos: ["Salpimenta el conejo. En una cazuela con aceite, dora el conejo por todos lados. Retira y reserva.", "En la misma cazuela, dora el bacon o panceta en trozos. Añade la cebolla picada y los ajos laminados, sofríe hasta que la cebolla esté transparente. Incorpora los champiñones y cocina hasta que suelten su agua.", "Vuelve a añadir el conejo a la cazuela. Vierte el vino tinto y deja que reduzca el alcohol. Añade el caldo de pollo y unas ramitas de tomillo.", "Cubre la cazuela y cocina a fuego lento durante unos 40-45 minutos, o hasta que el conejo esté tierno y la salsa haya espesado. Sirve caliente."] },
                { categoria: "Segundo", titulo: "San Jacobos Caseros", raciones: 2, tiempo: "30 min", imagen: "https://placehold.co/800x600/d1c4b5/4a2e0a?text=San+Jacobos", ingredientes: ["4 lonchas de lomo de cerdo (finas)", "4 lonchas de jamón cocido", "4 lonchas de queso (tipo Havarti o similar)", "1 huevo batido", "Pan rallado", "Aceite de girasol para freír", "Sal"], pasos: ["Extiende una loncha de lomo de cerdo. Sobre ella, coloca una loncha de jamón cocido y una de queso. Cubre con otra loncha de lomo de cerdo, formando un sándwich. Presiona bien los bordes para sellar.", "Pasa cada 'San Jacobo' por huevo batido y luego por pan rallado, asegurándote de que quede bien cubierto por todos lados. Presiona suavemente para que el pan rallado se adhiera bien.", "Calienta abundante aceite de girasol en una sartén a fuego medio. Cuando esté caliente, fríe los San Jacobos por ambos lados hasta que estén dorados y el queso se haya fundido por dentro (unos 3-4 minutos por lado).", "Retira los San Jacobos con una espumadera y colócalos sobre papel absorbente para eliminar el exceso de grasa. Sirve inmediatamente, acompañados de patatas fritas o ensalada."}
            ];
            
            // Función para renderizar las tarjetas de receta.
            function renderRecipes(recipesToRender) {
                console.log('renderRecipes: Renderizando', recipesToRender.length, 'recetas.');
                let recipeHTML = '';
                // Mostrar skeletons mientras se carga
                for (let i = 0; i < 8; i++) { 
                    recipeHTML += `
                        <div class="skeleton-card h-64 flex flex-col p-4 space-y-3">
                            <div class="skeleton-image w-full rounded-md"></div>
                            <div class="flex-grow space-y-2 pt-2">
                                <div class="skeleton-text long"></div>
                                <div class="skeleton-text medium small"></div>
                                <div class="skeleton-text short small"></div>
                            </div>
                        </div>
                    `;
                }
                dom.grid.innerHTML = recipeHTML; 
                dom.noResults.style.display = 'none'; 

                setTimeout(() => { 
                    recipeHTML = ''; 
                    if (recipesToRender.length === 0) {
                        dom.noResults.style.display = 'block';
                    } else {
                        dom.noResults.style.display = 'none';
                        recipesToRender.forEach(recipe => {
                            const searchTerms = `${recipe.titulo.toLowerCase()} ${recipe.ingredientes.join(' ').toLowerCase()}`;
                            recipeHTML += `
                                <div class="recipe-card" data-id="${recipe.titulo}" data-category="${recipe.categoria}" data-search="${searchTerms}">
                                    <div class="relative bg-white dark:bg-stone-800 rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer h-full flex flex-col">
                                        <img src="${recipe.imagen}" alt="Imagen de ${recipe.titulo}" class="w-full h-40 object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x300/d1c4b5/4a2e0a?text=Receta';">
                                        <div class="absolute top-2 left-2 bg-amber-800 text-white text-xs font-semibold px-2 py-1 rounded-full">${recipe.categoria}</div>
                                        <button class="favorite-btn absolute top-2 right-2 bg-white/80 rounded-full p-2 hover:bg-white dark:hover:bg-stone-600 transition">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                                        </button>
                                        <div class="p-4 flex-grow flex flex-col">
                                            <h3 class="font-bold text-lg text-amber-900 dark:text-amber-500 truncate">${recipe.titulo}</h3>
                                            <p class="text-sm text-gray-500 dark:text-stone-400 mt-1">Tiempo: ${recipe.tiempo} | Raciones: ${recipe.raciones}</p>
                                        </div>
                                    </div>
                                </div>`;
                        });
                    }
                    dom.grid.innerHTML = recipeHTML;
                    updateFavoriteIcons();
                }, 500); 
            }
            
            // Un solo event listener en el contenedor padre (delegación de eventos)
            dom.grid.addEventListener('click', (event) => {
                console.log('Clic detectado en dom.grid.');
                const card = event.target.closest('.recipe-card');
                if (!card) {
                    console.log('Clic no fue en una tarjeta de receta.');
                    return; 
                }

                console.log('Clic en tarjeta:', card.dataset.id);

                if (event.target.closest('.favorite-btn')) { 
                    console.log('Clic en botón de favoritos.');
                    event.stopPropagation(); 
                    toggleFavorite(card.dataset.id);
                } else { 
                    console.log('Clic para abrir detalles de receta.');
                    const recipe = allRecipes.find(r => r.titulo === card.dataset.id);
                    if (recipe) {
                        showRecipeDetail(recipe);
                    } else {
                        console.error('Receta no encontrada para ID:', card.dataset.id);
                    }
                }
            });
            
            // Inicializa la UI con todas las recetas al cargar la página
            renderRecipes(allRecipes); 

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase: Usuario autenticado con ID:", userId);
                    dom.userInfo.textContent = `ID de sesión: ${userId.substring(0,8)}...`;
                    await loadUserData();
                    updateFavoriteIcons();
                    showToast('¡Bienvenido! Sesión iniciada.', 'success'); 
                } else {
                    console.log("Firebase: No hay usuario, intentando iniciar sesión anónimamente...");
                    signInAnonymously(auth).then(() => {
                        console.log("Firebase: Sesión anónima iniciada con éxito.");
                    }).catch((error) => {
                        console.error("Firebase: Error al iniciar sesión anónimamente:", error.message);
                        dom.userInfo.textContent = `Error de autenticación: ${error.code}`;
                        showToast('Error de autenticación. Favoritos no guardados.', 'error'); 
                    });
                }
            });

            async function loadUserData() {
                if (!userId) {
                    console.warn("loadUserData: No hay userId para cargar datos.");
                    return;
                }
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data/profile`);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        userFavorites = data.favorites || [];
                        console.log("Firebase: Favoritos cargados:", userFavorites);
                    } else {
                        console.log("Firebase: Documento de favoritos no existe para este usuario.");
                        userFavorites = [];
                    }
                } catch (error) {
                    console.error("Firebase: Error cargando datos de usuario:", error.message);
                }
            }

            async function saveData(data) {
                if (!userId) {
                    console.warn("saveData: No hay userId para guardar datos.");
                    return;
                }
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data/profile`);
                    await setDoc(userDocRef, data, { merge: true });
                    console.log("Firebase: Favoritos guardados con éxito.");
                } catch (error) {
                    console.error("Firebase: Error guardando datos de usuario:", error.message);
                    showToast(`Error al guardar: ${error.message}`, 'error'); 
                }
            }

            async function toggleFavorite(recipeId) {
                if (!userId) {
                    console.warn("toggleFavorite: Usuario no autenticado para favoritos.");
                    showToast('Debes iniciar sesión para guardar favoritos. Recargando...', 'info'); 
                    signInAnonymously(auth).catch((error) => console.error("Error login anónimo para favoritos:", error));
                    return;
                }
                const isFavorite = userFavorites.includes(recipeId);
                userFavorites = isFavorite ? userFavorites.filter(id => id !== recipeId) : [...userFavorites, recipeId];
                
                updateFavoriteIcons(); 
                applyFilters(); 

                await saveData({ favorites: userFavorites });
                showToast(isFavorite ? 'Receta eliminada de favoritos.' : 'Receta añadida a favoritos.', 'success'); 
            }

            function updateFavoriteIcons() {
                document.querySelectorAll('.recipe-card').forEach(card => {
                    const heartIcon = card.querySelector('.favorite-btn svg');
                    if (heartIcon) { 
                        if (userFavorites.includes(card.dataset.id)) {
                            heartIcon.classList.add('text-red-500', 'fill-current');
                            heartIcon.classList.remove('text-gray-600', 'dark:text-gray-400');
                        } else {
                            heartIcon.classList.remove('text-red-500', 'fill-current');
                            heartIcon.classList.add('text-gray-600', 'dark:text-gray-400');
                        }
                    }
                });
            }

            let currentPrepareTimeFilter = 'all';

            function applyFilters() {
                const searchTerm = dom.search.value.toLowerCase();
                const filteredRecipes = allRecipes.filter(recipe => {
                    const id = recipe.titulo;
                    const category = recipe.categoria;
                    const searchData = `${recipe.titulo.toLowerCase()} ${recipe.ingredientes.join(' ').toLowerCase()}`;
                    
                    const prepareTimeValue = parseInt(recipe.tiempo.replace(' min', '')); 
                    const prepareTime = isNaN(prepareTimeValue) ? 0 : prepareTimeValue; 

                    const isFavorite = userFavorites.includes(id);
                    
                    const categoryMatch = currentCategory === 'all' || category === currentCategory;
                    const searchMatch = searchTerm === '' || searchData.includes(searchTerm);
                    const favoriteMatch = currentFilter !== 'favorites' || isFavorite;
                    
                    let timeMatch = true;
                    if (currentTimeFilter === 'short') {
                        timeMatch = prepareTime < 30;
                    } else if (currentTimeFilter === 'medium') {
                        timeMatch = prepareTime >= 30 && prepareTime <= 60;
                    } else if (currentTimeFilter === 'long') {
                        timeMatch = prepareTime > 60;
                    }
                    
                    return categoryMatch && searchMatch && favoriteMatch && timeMatch;
                });
                renderRecipes(filteredRecipes); 
            }

            let currentRecipeDetail = null; 
            let currentServings = 0; 

            // --- LISTA DE LA COMPRA ---
            function loadShoppingList() {
                const storedList = localStorage.getItem('shoppingList');
                shoppingList = storedList ? JSON.parse(storedList).map(item => ({ ...item, checked: item.checked ?? false })) : [];
                updateShoppingListCount();
                console.log("Lista de compra cargada:", shoppingList);
            }

            function saveShoppingList() {
                localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
                updateShoppingListCount();
                console.log("Lista de compra guardada:", shoppingList);
            }

            function updateShoppingListCount() {
                const totalItems = shoppingList.filter(item => item.value > 0 || (item.value === 0 && item.originalFormatted)).length; 
                dom.shoppingListCount.textContent = totalItems;
            }

            function addToShoppingList(recipe, servings) {
                const factor = servings / recipe.raciones;
                const ingredientsToProcess = [];

                recipe.ingredientes.forEach(originalIng => {
                    const parsed = parseIngredient(originalIng);
                    if (parsed.baseName || (parsed.value === 0 && parsed.original)) { 
                            ingredientsToProcess.push({
                                name: parsed.baseName || parsed.original.toLowerCase(), 
                                unit: parsed.unit,
                                value: parsed.value,
                                originalFormatted: formatIngredient(parsed, factor), 
                                checked: false 
                            });
                    } else if (parsed.original) {
                        ingredientsToProcess.push({
                            name: parsed.original.toLowerCase(),
                            unit: '',
                            value: 0, 
                            originalFormatted: parsed.original,
                            checked: false 
                        });
                    }
                });

                ingredientsToProcess.forEach(ing => {
                    const existingItemIndex = shoppingList.findIndex(item => 
                        item.name === ing.name && item.unit === ing.unit
                    );

                    if (existingItemIndex !== -1) {
                        if (ing.value > 0) { 
                            shoppingList[existingItemIndex].value += ing.value; 
                             if (shoppingList[existingItemIndex].value > 0) { 
                                const tempParsed = { value: shoppingList[existingItemIndex].value, unit: shoppingList[existingItemIndex].unit, name: shoppingList[existingItemIndex].name, baseName: shoppingList[existingItemIndex].name, original: '' };
                                shoppingList[existingItemIndex].originalFormatted = formatIngredient(tempParsed, 1);
                             }
                        }
                    } else {
                        shoppingList.push({
                            name: ing.name,
                            unit: ing.unit,
                            value: ing.value,
                            originalFormatted: ing.originalFormatted,
                            checked: false 
                        });
                    }
                });

                saveShoppingList(); 
                showToast(`¡Ingredientes de "${recipe.titulo}" (${servings} raciones) añadidos!`, 'success'); 
                closeModal(); 
            }

            function showShoppingListModal() {
                dom.finalShoppingList.innerHTML = ''; 
                const itemsToDisplay = shoppingList.filter(item => item.value > 0 || (item.value === 0 && item.originalFormatted));

                if (itemsToDisplay.length === 0) {
                    dom.finalShoppingList.innerHTML = '<li class="text-gray-500 dark:text-stone-400">Tu lista de compra está vacía.</li>';
                } else {
                    const sortedList = [...itemsToDisplay].sort((a, b) => a.name.localeCompare(b.name));
                    
                    sortedList.forEach((item, index) => { 
                        const li = document.createElement('li');
                        li.dataset.itemIndex = shoppingList.indexOf(item); 
                        
                        if (item.checked) {
                            li.classList.add('checked');
                        }

                        if (item.value > 0) {
                            const tempParsed = { value: item.value, unit: item.unit, name: item.name, baseName: item.name, original: item.originalFormatted };
                            li.textContent = formatIngredient(tempParsed, 1); 
                        } else {
                            li.textContent = item.originalFormatted; 
                        }
                        dom.finalShoppingList.appendChild(li);
                    });
                }
                dom.shoppingListModal.classList.remove('hidden');
                dom.shoppingListModal.classList.add('modal-visible');

                dom.finalShoppingList.addEventListener('click', toggleIngredientChecked);
            }

            function closeShoppingListModal() {
                dom.shoppingListModal.classList.remove('modal-visible');
                dom.finalShoppingList.removeEventListener('click', toggleIngredientChecked); 
                setTimeout(() => {
                    dom.shoppingListModal.classList.add('hidden');
                }, 300);
            }

            function toggleIngredientChecked(event) {
                const listItem = event.target.closest('li');
                if (listItem && listItem.dataset.itemIndex !== undefined) { 
                    const index = parseInt(listItem.dataset.itemIndex);
                    if (shoppingList[index]) {
                        shoppingList[index].checked = !shoppingList[index].checked; 
                        saveShoppingList(); 
                        showShoppingListModal(); 
                        showToast(shoppingList[index].checked ? 'Ingrediente marcado.' : 'Ingrediente desmarcado.', 'info');
                    }
                }
            }


            function clearShoppingList() {
                if (confirm('¿Estás seguro de que quieres vaciar toda la lista de compra?')) {
                    shoppingList = [];
                    saveShoppingList();
                    showShoppingListModal(); 
                    showToast('Lista de compra vaciada.', 'info');
                }
            }

            function parseIngredient(ingredient) {
                const regex = /^(\d+(?:[.,]\d+)?|\d+\/\d+)?\s*(un|una|medio|media|gran|pequeña|puñado|chorrito)?\s*(g|ml|litro|kg|cdita|cda|taza|vaso|trozo|hojas|onza|rebanada|lonchas|lomos|filetes|manojo|piezas|patata|pimientos|ramas|ramitas|cucharadas|unidad|unidades|latas|gramos|cucharaditas|dientes|bolas|ramo|ramita)?\s*(.+)?$/i;
                let match = ingredient.match(regex);
                
                let value = 0;
                let unit = '';
                let name = ingredient.trim(); 
                let baseName = ''; 

                if (match) {
                    if (match[1]) { 
                        value = match[1].includes('/') ? parseFloat(match[1].split('/')[0]) / parseFloat(match[1].split('/')[1]) : parseFloat(match[1].replace(',', '.'));
                    } else if (match[2]) { 
                        const quantWord = match[2].toLowerCase();
                        if (quantWord === 'medio' || quantWord === 'media') value = 0.5;
                        else if (['un', 'una', 'puñado', 'chorrito'].includes(quantWord)) value = 1;
                    }

                    unit = match[3] ? match[3].toLowerCase() : '';
                    name = match[4] ? match[4].trim() : ''; 
                    
                    if (match[2] && !match[3] && ['un', 'una', 'medio', 'media', 'gran', 'pequeña', 'puñado', 'chorrito'].includes(match[2].toLowerCase())) {
                        name = (match[2] + ' ' + name).trim();
                        unit = ''; 
                    }
                } else {
                    // Si no hay ningún match con la regex, es un ingrediente "al gusto" o sin cantidad explícita.
                    // Su `value` seguirá siendo 0 y `name` será el `ingredient` original.
                    // Esto se manejará en `formatIngredient` para mostrar el string original.
                }
                
                baseName = getBaseName(name || ingredient); 
                
                return { value, unit, name, baseName: baseName.trim(), original: ingredient };
            }

            // Función para obtener el nombre base del ingrediente
            function getBaseName(rawName) {
                let lowerName = rawName.toLowerCase();
                let base = lowerName;

                const specificCompoundsMap = {
                    "jamón serrano": "jamón serrano", "tomates cherry": "tomate cherry",
                    "espárragos verdes": "espárrago verde", "queso crema": "queso crema",
                    "leche vegetal": "leche vegetal", "chocolate negro": "chocolate negro",
                    "sirope de agave": "sirope de agave", "aceite de oliva": "aceite de oliva",
                    "pan integral": "pan integral", "carne picada": "carne picada",
                    "alga wakame": "alga wakame", "pan de telera": "pan de telera",
                    "judías verdes": "judía verde", "aceitunas verdes": "aceituna verde",
                    "aceitunas negras": "aceituna negra", "cebolla morada": "cebolla morada",
                    "pimiento rojo": "pimiento rojo", "pimiento verde": "pimiento verde",
                    "crema de cacahuete": "crema de cacahuete", "sal marina": "sal marina",
                    "queso rallado": "queso rallado", "zumo de limón": "zumo de limón",
                    "vinagre balsámico": "vinagre balsámico", "leche desnatada": "leche desnatada",
                    "yogur griego": "yogur griego", "esencia de vainilla": "esencia de vainilla",
                    "harina integral": "harina integral", "copos de avena": "copos de avena",
                    "semillas de chía": "semillas de chía", "frutos rojos": "fruto rojo",
                    "fruta fresca": "fruta fresca", "caldo de verduras": "caldo de verduras",
                    "caldo de pollo": "caldo de pollo", "salsa de soja": "salsa de soja",
                    "aceite de sésamo": "aceite de sésamo", "pasta miso": "pasta miso",
                    "pimienta negra": "pimienta negra", "nuez moscada": "nuez moscada",
                    "curry en polvo": "curry en polvo", "jengibre fresco": "jengibre fresco",
                    "hierbas aromáticas": "hierba aromática", "hierbas provenzales": "hierba provenzal",
                    "pulpa de açaí": "pulpa de açaí", "pan rallado": "pan rallado",
                    "huevo duro": "huevo duro", "jamón serrano": "jamón serrano",
                    "queso de cabra": "queso de cabra", "setas variadas": "seta variada",
                    "langostinos cocidos": "langostino cocido", "pollo picado": "pollo picado",
                    "arroz integral": "arroz integral", "maicena": "maicena",
                    "champiñones": "champiñón", 
                    "patatas": "patata", 
                    "garbanzos": "garbanzo", 
                    "espinacas": "espinaca", 
                    "judiones": "judión", 
                    "fabes": "fabes", 
                    "cebolletas": "cebolleta",
                    "boquerones": "boquerón", "guindillas": "guindilla", "pepinillos": "pepinillo",
                    "morcilla": "morcilla", "chorizo": "chorizo", "lacón": "lacón", "fideos": "fideo",
                    "churro": "churro", "natillas": "natilla", "torrija": "torrija", "arroz": "arroz",
                    "tarta": "tarta", "galleta": "galleta", "bizcocho": "bizcocho", "flan": "flan",
                    "gelatina": "gelatina", "almendra molida": "almendra molida", "azúcar glas": "azúcar glas",
                    "sobrasada": "sobrasada", "miel": "miel", "queso feta": "queso feta", "pasta corta": "pasta corta",
                    "ternera para estofado": "ternera para estofado", "vino tinto": "vino tinto",
                    "conejo troceado": "conejo troceado", "romero fresco": "romero fresco",
                    "salsa romesco": "salsa romesco", "chuletas de cordero": "chuleta de cordero",
                    "ajo granulado": "ajo granulado", "carne de cerdo": "carne de cerdo",
                    "especias para pinchos morunos": "especias para pinchos morunos", "pollo entero": "pollo entero",
                    "gajos": "gajo", "pollo asado": "pollo asado", "bacalao desmigado": "bacalao desmigado",
                    "pimientos del piquillo": "pimiento del piquillo", "brandada de bacalao": "brandada de bacalao",
                    "almendras tostadas": "almendra tostada", "piñones": "piñón", "escalivada": "escalivada",
                    "sandía": "sandía", "melón": "melón", "jamón serrano": "jamón serrano",
                    "alubias blancas": "alubia blanca", "chorizo para cocinar": "chorizo para cocinar",
                    "panceta fresca": "panceta fresca", "hoja de laurel": "hoja de laurel",
                    "bacalao desalado": "bacalao desalado", "fideos para fideuá": "fideo para fideuá",
                    "conejo a la cazadora": "conejo a la cazadora", "san jacobos": "san jacobo",
                    "miel sobre hojuelas": "miel sobre hojuelas"
                };

                for (const compound in specificCompoundsMap) {
                    if (lowerName.includes(compound)) {
                        return specificCompoundsMap[compound];
                    }
                }

                const commonSingularPluralMap = {
                    "patata": "patatas", "zanahoria": "zanahorias", "cebolla": "cebollas",
                    "pimiento": "pimientos", "huevo": "huevos", "diente": "dientes",
                    "ramita": "ramitas", "bola": "bolas", "pieza": "piezas",
                    "unidad": "unidades", "hoja": "hojas", "lomo": "lomos",
                    "filete": "filetes", "manojo": "manojos", "lata": "latas",
                    "cucharada": "cucharadas", "cucharadita": "cucharaditas", "trozo": "trozos",
                    "vaso": "vasos", "taza": "tazas", "rebanada": "rebanadas",
                    "gramo": "gramos", "mililitro": "mililitros", "litro": "litros", "kilogramo": "kilogramos",
                    "brocheta": "brochetas", "espárrago": "espárragos", "espárrago triguero": "espárragos trigueros",
                    "loncha": "lonchas",
                    "aceituna": "aceitunas", "nuez": "nueces", "pasa": "pasas", "espinaca": "espinacas",
                    "judía verde": "judías verdes", "tomate cherry": "tomates cherry", "seta": "setas",
                    "gamba": "gambas", "pulpo": "pulpo", "compota": "compotas", "galleta": "galletas",
                    "fruto rojo": "frutos rojos", "zumo": "zumos", "plátano": "plátanos", "dátil": "dátiles",
                    "almendra": "almendras", "pera": "peras", "naranja": "naranjas", "fresa": "fresas",
                    "kiwi": "kiwis", "melón": "melones", "uva": "uvas", "churro": "churros",
                    "natilla": "natillas", "torrija": "torrijas", "arroz": "arroces", 
                    "morcilla": "morcillas", "chorizo": "chorizos", "lacón": "lacones", "judión": "judiones",
                    "fideo": "fideos", "guindilla": "guindillas", "pepinillo": "pepinillos",
                    "cebolleta": "cebolletas", "boquerón": "boquerones", "coco": "cocos",
                    "sobrasada": "sobrasadas", "miel": "mieles", "queso feta": "quesos feta", "pasta corta": "pastas cortas",
                    "ternera": "terneras", "vino": "vinos", "conejo": "conejos", "romero": "romeros",
                    "chuleta": "chuletas", "cordero": "corderos", "cerdo": "cerdos", "pollo": "pollos",
                    "gajo": "gajos", "bacalao": "bacalaos", "pimiento": "pimientos", "brandada": "brandadas",
                    "almendra": "almendras", "piñón": "piñones", "escalivada": "escalivadas",
                    "sandía": "sandías", "alubia": "alubias", "panceta": "pancetas", "conejo": "conejos",
                    "san jacobo": "san jacobos", "miel sobre hojuelas": "miel sobre hojuelas"
                };
                
                const words = lowerName.split(' ').map(w => w.replace(/[^a-záéíóúüñ]/g, '')); 
                for (const word of words) {
                    if (commonSingularPluralMap[word]) return word; 
                    const singularForm = Object.keys(commonSingularPluralMap).find(key => commonSingularPluralMap[key] === word); 
                    if (singularForm) return singularForm; 
                }
                
                if (lowerName.endsWith('s') && lowerName.length > 3 && !['hummus', 'cuscús', 'miso', 'açaí', 'fabes', 'pasas', 'nueces', 'espinacas', 'judías verdes', 'tomates cherry', 'setas', 'aceitunas', 'fabes', 'patatas', 'gambas', 'alubias', 'champiñones', 'boquerones', 'pimientos', 'cigalas', 'piñones'].includes(lowerName)) {
                    return lowerName.slice(0, -1); 
                }

                return lowerName; 
            }

            function formatIngredient(parsedIng, factor) {
                if (parsedIng.value === 0) { 
                    return parsedIng.original; 
                }
                
                let newValue = parsedIng.value * factor;
                let unit = parsedIng.unit;
                let name = parsedIng.name;
                let baseName = parsedIng.baseName; 

                if (unit === 'kg' && newValue < 1) { newValue *= 1000; unit = 'g'; } 
                else if (unit === 'litro' && newValue < 1) { newValue *= 1000; unit = 'ml'; } 
                else if (unit === 'g' && newValue >= 1000) { newValue /= 1000; unit = 'kg'; } 
                else if (unit === 'ml' && newValue >= 1000) { newValue /= 1000; unit = 'litro'; }
                
                if (Math.abs(newValue % 1) < 0.0001) { 
                    newValue = Math.round(newValue);
                } else if (Math.abs((newValue * 10) % 1) < 0.0001) { 
                    newValue = Math.round(newValue * 10) / 10;
                } else { 
                    newValue = Math.round(newValue * 100) / 100; 
                }
                
                let formattedName = name;
                const commonFormsMap = {
                    "patata": "patatas", "zanahoria": "zanahorias", "cebolla": "cebollas",
                    "pimiento": "pimientos", "huevo": "huevos", "diente": "dientes",
                    "ramita": "ramitas", "bola": "bolas", "pieza": "piezas",
                    "unidad": "unidades", "hoja": "hojas", "lomo": "lomos",
                    "filete": "filetes", "manojo": "manojos", "lata": "latas",
                    "cucharada": "cucharadas", "cucharadita": "cucharaditas", "trozo": "trozos",
                    "vaso": "vasos", "taza": "tazas", "rebanada": "rebanadas",
                    "gramo": "gramos", "mililitro": "mililitros", "litro": "litros", "kilogramo": "kilogramos",
                    "brocheta": "brochetas", "espárrago": "espárragos", "espárrago triguero": "espárragos trigueros",
                    "loncha": "lonchas",
                    "aceituna": "aceitunas", "nuez": "nueces", "pasa": "pasas", "espinaca": "espinacas",
                    "judía verde": "judías verdes", "tomate cherry": "tomates cherry", "seta": "setas",
                    "gamba": "gambas", "pulpo": "pulpo", "compota": "compotas", "galleta": "galletas",
                    "fruto rojo": "frutos rojos", "zumo": "zumos", "plátano": "plátanos", "dátil": "dátiles",
                    "almendra": "almendras", "pera": "peras", "naranja": "naranjas", "fresa": "fresas",
                    "kiwi": "kiwis", "melón": "melones", "uva": "uvas", "churro": "churros",
                    "natilla": "natillas", "torrija": "torrijas", "arroz": "arroces", 
                    "morcilla": "morcillas", "chorizo": "chorizos", "lacón": "lacones", "judión": "judiones",
                    "fideo": "fideos", "guindilla": "guindillas", "pepinillo": "pepinillos",
                    "cebolleta": "cebolletas", "boquerón": "boquerones", "coco": "cocos",
                    "sobrasada": "sobrasadas", "miel": "mieles", "queso feta": "quesos feta", "pasta corta": "pastas cortas",
                    "ternera": "terneras", "vino": "vinos", "conejo": "conejos", "romero": "romeros",
                    "chuleta": "chuletas", "cordero": "corderos", "cerdo": "cerdos", "pollo": "pollos",
                    "gajo": "gajos", "bacalao": "bacalaos", "brandada": "brandadas", "piñón": "piñones",
                    "escalivada": "escalivadas", "sandía": "sandías", "alubia": "alubias", "panceta": "pancetas",
                    "san jacobo": "san jacobos", "miel sobre hojuelas": "miel sobre hojuelas"
                };

                let targetNounForm = baseName;

                if (newValue === 1) {
                    targetNounForm = Object.keys(commonFormsMap).find(key => commonFormsMap[key] === baseName) || baseName;
                    if (targetNounForm === baseName && baseName.endsWith('s') && !['pasas', 'nueces', 'espinacas', 'judías verdes', 'tomates cherry', 'setas', 'aceitunas', 'fabes', 'patatas', 'gambas', 'alubias', 'champiñones', 'boquerones', 'pimientos', 'cigalas', 'piñones'].includes(baseName)) {
                           targetNounForm = baseName.slice(0, -1); 
                    }
                } else { 
                    targetNounForm = commonFormsMap[baseName] || baseName;
                    if (targetNounForm === baseName && !baseName.endsWith('s')) {
                        targetNounForm = baseName + 's'; 
                    }
                }
                
                formattedName = name.replace(new RegExp(`\\b${parsedIng.baseName.replace(/s\b/, '')}(s)?\\b`, 'i'), targetNounForm);
                
                formattedName = formattedName.trim();

                const unitInNameRegex = new RegExp(`\\b${unit}(es)?\\b`, 'i');
                formattedName = formattedName.replace(unitInNameRegex, '').trim();
                
                formattedName = formattedName.split(' ').filter((word, index, arr) => {
                    return index === 0 || word.toLowerCase() !== arr[index - 1].toLowerCase();
                }).join(' ').trim();

                if (unit === 'cdita' || unit === 'cda') {
                    return `${newValue} ${unit}. ${formattedName}`.trim();
                }
                if (newValue === 1 && (unit === '' || ['un', 'una', 'unidad', 'unidades', 'puñado', 'chorrito'].includes(parsedIng.unit))) {
                    return formattedName; 
                }
                if (unit !== '') {
                    return `${newValue} ${unit} ${formattedName}`.trim();
                }
                return `${newValue} ${formattedName}`.trim();
            }


            function updateIngredientsDisplay(servings) {
                if (!currentRecipeDetail) return;

                const ingredientList = document.getElementById('ingredient-list');
                ingredientList.innerHTML = '';
                const factor = servings / currentRecipeDetail.raciones;

                currentRecipeDetail.ingredientes.forEach(originalIng => {
                    const parsed = parseIngredient(originalIng);
                    const formatted = formatIngredient(parsed, factor);
                    const li = document.createElement('li');
                    li.textContent = formatted;
                    ingredientList.appendChild(li);
                });
            }
            
            function showRecipeDetail(recipe) {
                console.log('showRecipeDetail: Abriendo modal para', recipe.titulo);
                currentRecipeDetail = recipe; 
                currentServings = recipe.raciones; 

                dom.modalContent.innerHTML = `
                    <div class="p-6 md:p-8">
                        <div class="flex justify-between items-start">
                            <h2 class="text-3xl font-bold text-amber-900 dark:text-amber-500 mb-4">${recipe.titulo}</h2>
                            <button id="closeModalBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-stone-700 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <img src="${recipe.imagen}" alt="Imagen de ${recipe.titulo}" class="w-full h-64 object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/600x400/d1c4b5/4a2e0a?text=Receta';">
                        <div id="recipe-content-normal">
                            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-3">
                                <p class="text-md font-semibold text-gray-700 dark:text-stone-300">Tiempo de preparación: <span class="text-amber-700 dark:text-amber-400">${recipe.tiempo}</span></p>
                                <div id="portion-adjuster" class="flex items-center justify-center space-x-3 text-lg font-medium text-gray-700 dark:text-stone-300">
                                    <span>Raciones:</span>
                                    <input type="number" id="servings-input" value="${recipe.raciones}" min="1" class="w-16 text-center bg-white dark:bg-stone-700 border border-gray-300 dark:border-stone-600 rounded-md p-1">
                                    <button id="decrease-servings" class="px-3 py-1 bg-amber-100 dark:bg-amber-700 rounded-md hover:bg-amber-200 dark:hover:bg-amber-600 transition-colors">-</button>
                                    <button id="increase-servings" class="px-3 py-1 bg-amber-100 dark:bg-amber-700 rounded-md hover:bg-amber-200 dark:hover:bg-amber-600 transition-colors">+</button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-xl font-semibold border-b-2 border-amber-200 dark:border-amber-800 pb-2">Ingredientes</h4>
                                    <ul id="ingredient-list" class="list-disc list-inside space-y-2 text-gray-700 dark:text-stone-300"></ul>
                                </div>
                                <div>
                                    <h4 class="text-xl font-semibold mb-3 border-b-2 border-amber-200 dark:border-amber-800 pb-2">Pasos</h4>
                                    <ol id="steps-list" class="list-decimal list-inside space-y-3 text-gray-700 dark:text-stone-300"></ol>
                                </div>
                            </div>
                             <div class="modal-buttons-container text-center mt-8 flex flex-wrap gap-4 justify-center">
                                <button id="printRecipeBtn" class="bg-gray-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-gray-600 transition shadow-lg">Imprimir</button>
                                <button id="shareRecipeBtn" class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition shadow-lg">Compartir</button>
                                <button id="start-cooking-btn" class="bg-green-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-green-700 transition shadow-lg">Iniciar Cocina Guiada</button>
                                <button id="add-to-shopping-list-btn" class="bg-teal-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-teal-700 transition shadow-lg">Añadir a la Lista de Compra</button>
                            </div>
                        </div>
                    </div>`;
                
                const stepsList = document.getElementById('steps-list');
                stepsList.innerHTML = recipe.pasos.map(step => `<li>${step}</li>`).join('');

                updateIngredientsDisplay(currentServings);

                dom.modal.classList.remove('hidden');
                dom.modal.classList.add('modal-visible'); 
                
                document.getElementById('closeModalBtn').addEventListener('click', closeModal);
                document.getElementById('printRecipeBtn').addEventListener('click', () => window.print());
                
                const shareBtn = document.getElementById('shareRecipeBtn');
                if (navigator.share) {
                    shareBtn.addEventListener('click', async () => {
                        try {
                            await navigator.share({
                                title: recipe.titulo,
                                text: `¡Mira esta receta de ${recipe.titulo}!`,
                                url: window.location.href,
                            });
                        } catch (err) {
                            console.error('Error al compartir:', err);
                        }
                    });
                } else {
                    shareBtn.style.display = 'none';
                }
                
                document.getElementById('start-cooking-btn').addEventListener('click', () => startCookingMode(recipe));
                document.getElementById('add-to-shopping-list-btn').addEventListener('click', () => {
                    addToShoppingList(currentRecipeDetail, currentServings);
                });

                const servingsInput = document.getElementById('servings-input');
                document.getElementById('decrease-servings').addEventListener('click', () => {
                    let newServings = parseInt(servingsInput.value) - 1;
                    if (newServings < 1) newServings = 1;
                    servingsInput.value = newServings;
                    currentServings = newServings;
                    updateIngredientsDisplay(currentServings);
                });
                document.getElementById('increase-servings').addEventListener('click', () => {
                    let newServings = parseInt(servingsInput.value) + 1;
                    if (newServings < 1) newServings = 1; // Asegura que no sea menos de 1
                    servingsInput.value = newServings;
                    currentServings = newServings;
                    updateIngredientsDisplay(currentServings);
                });
                servingsInput.addEventListener('change', (e) => {
                    let newServings = parseInt(e.target.value);
                    if (isNaN(newServings) || newServings < 1) newServings = 1;
                    e.target.value = newServings;
                    currentServings = newServings;
                    updateIngredientsDisplay(currentServings);
                });
            }
            
            function closeModal() {
                console.log('closeModal: Cerrando modal.');
                dom.modal.classList.remove('modal-visible'); 
                setTimeout(() => { 
                    dom.modal.classList.add('hidden'); 
                    dom.modalContent.innerHTML = ''; 
                    console.log('Modal completamente cerrado y contenido limpiado.');
                }, 300); 
                currentRecipeDetail = null; 
                currentServings = 0; 
            }

            // --- MODO OSCURO ---
            function setupTheme() {
                const currentTheme = localStorage.getItem('color-theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                if (currentTheme === 'dark' || (!currentTheme && systemPrefersDark)) {
                    document.documentElement.classList.add('dark');
                    dom.lightIcon.classList.remove('hidden'); 
                    dom.darkIcon.classList.add('hidden');    
                    console.log("Tema: Oscuro (inicial)");
                } else {
                    document.documentElement.classList.remove('dark');
                    dom.darkIcon.classList.remove('hidden'); 
                    dom.lightIcon.classList.add('hidden');    
                    console.log("Tema: Claro (inicial)");
                }
            }

            dom.themeToggle.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
                
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.setItem('color-theme', 'dark');
                    dom.lightIcon.classList.remove('hidden');
                    dom.darkIcon.classList.add('hidden');
                    console.log("Cambiando a tema: Oscuro (manual)");
                } else {
                    localStorage.setItem('color-theme', 'light');
                    dom.darkIcon.classList.remove('hidden');
                    dom.lightIcon.classList.add('hidden');
                    console.log("Cambiando a tema: Claro (manual)");
                }
            });

            setupTheme(); 

            // --- EVENT LISTENERS DE FILTROS Y BÚSQUEDA ---
            dom.search.addEventListener('input', applyFilters);

            dom.filterAllBtn.addEventListener('click', () => {
                console.log('Filtro: Todas');
                currentFilter = 'all';
                dom.filterAllBtn.classList.add('active'); dom.filterFavBtn.classList.remove('active');
                applyFilters();
            });
            dom.filterFavBtn.addEventListener('click', () => {
                console.log('Filtro: Favoritas');
                currentFilter = 'favorites';
                dom.filterFavBtn.classList.add('active'); dom.filterAllBtn.classList.remove('active');
                applyFilters();
            });
            
            dom.categoryFilters.addEventListener('click', (e) => {
                if (e.target.matches('.category-btn')) {
                    currentCategory = e.target.dataset.category;
                    console.log('Filtro por categoría:', currentCategory);
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    applyFilters();
                }
            });

            // Event listener para los nuevos filtros de tiempo
            dom.timeFilters.addEventListener('click', (e) => {
                if (e.target.matches('.time-filter-btn')) {
                    currentTimeFilter = e.target.dataset.time;
                    console.log('Filtro por tiempo:', currentTimeFilter);
                    document.querySelectorAll('.time-filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    applyFilters();
                }
            });
            
            // Listener para cerrar el modal al hacer clic fuera
            dom.modal.addEventListener('click', (event) => { 
                if (event.target === dom.modal) { 
                    console.log('Clic en fondo del modal, cerrando.');
                    closeModal(); 
                }
            });

            // Event listeners para el modal de la lista de compra
            dom.viewShoppingListBtn.addEventListener('click', showShoppingListModal);
            dom.closeShoppingListModalBtn.addEventListener('click', closeShoppingListModal);
            dom.clearShoppingListBtn.addEventListener('click', clearShoppingList);
            dom.printShoppingListBtn.addEventListener('click', () => {
                const printContent = dom.shoppingListModal.querySelector('.bg-white.dark\\:bg-stone-800');
                if (printContent) {
                    // Para imprimir solo el contenido del modal de la lista de compra
                    const originalBody = document.body.innerHTML;
                    document.body.innerHTML = printContent.outerHTML;
                    window.print();
                    document.body.innerHTML = originalBody;
                    runRecipeApp(); // Volver a inicializar la app después de imprimir
                } else {
                    window.print(); // Si falla la selección, imprime la página completa (fallback)
                }
            });


            // Asegura que los filtros "Todas" y "Cualquiera" estén activos al cargar
            dom.filterAllBtn.classList.add('active');
            document.querySelector('.time-filter-btn[data-time="all"]').classList.add('active');
            
            // --- COPYRIGHT YEAR ---
            dom.copyrightYear.textContent = new Date().getFullYear();

            // --- ASISTENTE DE VOZ ---
            // Variable para el objeto SpeechRecognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;
            let speaking = false; 
            let recognitionActive = false; 

            // Funciones de temporizador
            let activeTimers = [];
            let timerIdCounter = 0;

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            function updateTimerDisplay() {
                dom.activeTimersContainer.innerHTML = '';
                if (activeTimers.length === 0) {
                    // dom.activeTimersContainer.style.display = 'none'; // Podrías ocultarlo si no hay temporizadores
                    return;
                }
                // dom.activeTimersContainer.style.display = 'flex'; // Mostrarlo si hay temporizadores

                activeTimers.forEach(timer => {
                    const timerCard = document.createElement('div');
                    timerCard.classList.add('timer-card');
                    timerCard.dataset.timerId = timer.id;

                    const timerName = timer.name ? `${timer.name}: ` : '';
                    timerCard.innerHTML = `
                        <span>${timerName}<span data-timer-time="${timer.id}">${formatTime(timer.remaining)}</span></span>
                        <button data-timer-action="stop" data-timer-id="${timer.id}" aria-label="Cancelar temporizador ${timer.name || timer.id}">&times;</button>
                    `;
                    dom.activeTimersContainer.appendChild(timerCard);

                    // Event listener para el botón de cancelar
                    timerCard.querySelector('[data-timer-action="stop"]').addEventListener('click', (e) => {
                        stopCookingTimer(parseInt(e.target.dataset.timerId));
                        showToast(`Temporizador ${timer.name || ''} cancelado.`, 'info');
                    });
                });
            }

            function startCookingTimer(minutes, timerName = 'temporizador') {
                const durationSeconds = minutes * 60;
                if (durationSeconds <= 0) {
                    speak("El tiempo del temporizador debe ser un número positivo.");
                    return;
                }

                const timerId = timerIdCounter++;
                const newTimer = {
                    id: timerId,
                    duration: durationSeconds,
                    remaining: durationSeconds,
                    intervalId: null,
                    name: timerName
                };
                activeTimers.push(newTimer);
                updateTimerDisplay();

                speak(`Temporizador ${timerName} iniciado para ${minutes} minutos.`);
                console.log(`Temporizador ${timerName} (${timerId}) iniciado para ${minutes} minutos.`);

                newTimer.intervalId = setInterval(() => {
                    newTimer.remaining--;
                    const timerSpan = dom.activeTimersContainer.querySelector(`[data-timer-time="${newTimer.id}"]`);
                    if (timerSpan) {
                        timerSpan.textContent = formatTime(newTimer.remaining);
                    }

                    if (newTimer.remaining <= 0) {
                        clearInterval(newTimer.intervalId);
                        speak(`¡El temporizador ${newTimer.name} ha terminado!`);
                        showToast(`¡Temporizador "${newTimer.name}" ha terminado!`, 'success', 5000);
                        stopCookingTimer(newTimer.id); // Eliminar del array
                    } else if (newTimer.remaining === 60) {
                        speak(`Queda un minuto para el temporizador ${newTimer.name}.`);
                    } else if (newTimer.remaining === 30) {
                        speak(`Quedan 30 segundos para el temporizador ${newTimer.name}.`);
                    } else if (newTimer.remaining === 10) {
                        speak(`Quedan 10 segundos para el temporizador ${newTimer.name}.`);
                    }
                }, 1000);
            }

            function stopCookingTimer(timerId) {
                const timerIndex = activeTimers.findIndex(t => t.id === timerId);
                if (timerIndex !== -1) {
                    clearInterval(activeTimers[timerIndex].intervalId);
                    activeTimers.splice(timerIndex, 1);
                    updateTimerDisplay();
                }
            }

            function getRemainingTime(timerName = null) {
                let timer = null;
                if (timerName) {
                    timer = activeTimers.find(t => t.name.toLowerCase().includes(timerName.toLowerCase()));
                } else if (activeTimers.length > 0) {
                    timer = activeTimers[activeTimers.length - 1]; // Último temporizador
                }

                if (timer) {
                    const minutes = Math.floor(timer.remaining / 60);
                    const seconds = timer.remaining % 60;
                    if (minutes > 0 && seconds > 0) {
                        speak(`Para el temporizador ${timer.name || ''} quedan ${minutes} minutos y ${seconds} segundos.`);
                    } else if (minutes > 0) {
                        speak(`Para el temporizador ${timer.name || ''} quedan ${minutes} minutos.`);
                    } else if (seconds > 0) {
                        speak(`Para el temporizador ${timer.name || ''} quedan ${seconds} segundos.`);
                    } else {
                        speak(`El temporizador ${timer.name || ''} ya ha terminado.`);
                    }
                } else {
                    speak("No hay temporizadores activos.");
                }
            }

            // Función para iniciar el reconocimiento de voz
            function startVoiceRecognition() {
                if (!SpeechRecognition) {
                    console.warn('SpeechRecognition API no soportada en este navegador.');
                    showToast('Tu navegador no soporta el control por voz.', 'error');
                    return;
                }
                
                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'es-ES';
                    recognition.interimResults = false; 
                    recognition.maxAlternatives = 1; 

                    recognition.addEventListener('result', (event) => {
                        const command = event.results[0][0].transcript.toLowerCase();
                        console.log('Comando detectado:', command);
                        handleVoiceCommand(command);
                    });

                    recognition.addEventListener('end', () => {
                        if (cookingModeView.classList.contains('flex') && recognitionActive) {
                            console.log('Reconocimiento de voz terminado, reiniciando...');
                            recognition.start(); 
                        } else {
                            console.log('Reconocimiento de voz detenido permanentemente.');
                        }
                    });

                    recognition.addEventListener('error', (event) => {
                        console.error('Error en reconocimiento de voz:', event.error);
                        if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                            showToast('Necesito permiso de micrófono para el asistente de voz. Por favor, actívalo.', 'error');
                            recognitionActive = false; 
                        } else if (event.error === 'no-speech') {
                            console.log('No se detectó voz. Reintentando...');
                        } else {
                            showToast(`Error de voz: ${event.error}. Intenta de nuevo.`, 'error');
                            recognitionActive = false; 
                        }
                    });
                }
                
                if (!recognitionActive) { 
                    try {
                        recognitionActive = true;
                        recognition.start();
                        console.log('Reconocimiento de voz iniciado.');
                        showToast('Asistente de voz escuchando...', 'info');
                    } catch (e) {
                        console.error('Error al iniciar SpeechRecognition:', e);
                        showToast('Error al iniciar el reconocimiento de voz. Intenta recargar.', 'error');
                        recognitionActive = false;
                    }
                }
            }

            // Función para detener el reconocimiento de voz
            function stopVoiceRecognition() {
                if (recognition && recognitionActive) {
                    recognitionActive = false;
                    recognition.stop();
                    console.log('Reconocimiento de voz detenido.');
                }
            }

            // --- Funciones de control del asistente (extraídas para ser llamadas directamente) ---
            function nextStepAction() { 
                if (currentStep < currentRecipeSteps.length - 1) {
                    currentStep++;
                    updateCookingStep(); // Esta función ya se encarga de hablar el paso
                } else {
                    speak("Has llegado al final de la receta. ¡Buen provecho!");
                    exitCookingMode();
                }
            }

            function prevStepAction() { 
                if (currentStep > 0) {
                    currentStep--;
                    updateCookingStep(); // Esta función ya se encarga de hablar el paso
                } else {
                    speak("Estás en el primer paso.");
                }
            }

            function repeatStepAction() { 
                speak(currentRecipeSteps[currentStep]);
            }
            // La función `exitCookingMode` ya existe y se llama correctamente.


            // Función para manejar los comandos de voz
            function handleVoiceCommand(command) {
                if (speaking) {
                    console.log("Asistente hablando, ignorando comando:", command);
                    return; 
                }

                const cleanedCommand = command.replace(/[^\w\sáéíóúüñ]/g, '').toLowerCase(); 

                // Comandos de temporizador
                const setTimerMatch = cleanedCommand.match(/(pon|inicia|crea) (un )?temporizador de (\d+)( minutos)?( para (la|el)? (.+))?/);
                const queryTimerMatch = cleanedCommand.match(/(cuanto|cuánto) (queda|quedan)( del)?( temporizador)?( (.+))?/);
                const cancelTimerMatch = cleanedCommand.match(/(cancela|elimina|quita) (el )?temporizador( (.+))?/);
                const cancelAllTimersMatch = cleanedCommand.match(/(cancela|elimina|quita) (todos )?(los )?temporizadores/);

                if (setTimerMatch) {
                    const minutes = parseInt(setTimerMatch[3]);
                    let timerName = setTimerMatch[7] ? setTimerMatch[7].trim() : '';
                    if (!timerName || timerName === 'la' || timerName === 'el') timerName = 'temporizador';
                    startCookingTimer(minutes, timerName);
                } else if (queryTimerMatch) {
                    let timerName = queryTimerMatch[6] ? queryTimerMatch[6].trim() : null;
                    getRemainingTime(timerName);
                } else if (cancelAllTimersMatch) {
                    activeTimers.forEach(timer => clearInterval(timer.intervalId));
                    activeTimers = [];
                    updateTimerDisplay();
                    speak("Todos los temporizadores han sido cancelados.");
                    showToast('Todos los temporizadores cancelados.', 'info');
                }
                 else if (cancelTimerMatch) {
                    let timerName = cancelTimerMatch[4] ? cancelTimerMatch[4].trim() : null;
                    let timerToStop = null;

                    if (timerName) {
                        timerToStop = activeTimers.find(t => t.name.toLowerCase().includes(timerName.toLowerCase()));
                    } else if (activeTimers.length > 0) {
                        timerToStop = activeTimers[activeTimers.length - 1]; // El último temporizador
                    }

                    if (timerToStop) {
                        stopCookingTimer(timerToStop.id);
                        speak(`Temporizador ${timerToStop.name || ''} cancelado.`);
                        showToast(`Temporizador "${timerToStop.name || ''}" cancelado.`, 'info');
                    } else {
                        speak("No se encontró ningún temporizador con ese nombre o no hay temporizadores para cancelar.");
                    }
                }
                else if (cleanedCommand.includes('siguiente') || cleanedCommand.includes('sigue')) {
                    nextStepAction(); // Llama a la función de acción, que ahora lee el paso
                } else if (cleanedCommand.includes('anterior') || cleanedCommand.includes('atras')) {
                    prevStepAction(); // Llama a la función de acción, que ahora lee el paso
                } else if (cleanedCommand.includes('repetir')) {
                    repeatStepAction(); // Llama a la función de acción, que repite el paso
                } else if (cleanedCommand.includes('salir') || cleanedCommand.includes('detener') || cleanedCommand.includes('terminar')) {
                    exitCookingMode(); 
                } else {
                    speak('No entendí. Por favor, di "siguiente", "anterior", "repetir", "salir", o un comando de temporizador.');
                }
            }


            const cookingModeView = document.getElementById('cooking-mode-view');
            const stepCounter = document.getElementById('step-counter');
            const stepText = document.getElementById('step-text');
            const prevStepBtn = document.getElementById('prev-step-btn');
            const repeatStepBtn = document.getElementById('repeat-step-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const exitCookingBtn = document.getElementById('exit-cooking-btn');

            let currentStep = 0;
            let currentRecipeSteps = [];

            function speak(text) {
                speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; 
                utterance.rate = 0.9; 
                utterance.pitch = 1; 

                utterance.onstart = () => { speaking = true; };
                utterance.onend = () => { speaking = false; };
                utterance.onerror = (e) => { speaking = false; console.error("Error en SpeechSynthesis:", e);};

                speechSynthesis.speak(utterance);
            }

            function updateCookingStep() {
                stepCounter.textContent = `Paso ${currentStep + 1} de ${currentRecipeSteps.length}`;
                stepText.textContent = currentRecipeSteps[currentStep];
                speak(currentRecipeSteps[currentStep]); // Lee el paso actual al actualizar
            }

            function startCookingMode(recipe) {
                console.log('Iniciando modo de cocina para:', recipe.titulo);
                currentRecipeSteps = recipe.pasos;
                currentStep = 0;
                closeModal(); 
                cookingModeView.classList.remove('hidden');
                cookingModeView.classList.add('flex');
                speak(`Comenzamos la receta de ${recipe.titulo}.`);
                setTimeout(() => {
                    updateCookingStep(); // Muestra y lee el primer paso
                    startVoiceRecognition(); 
                }, 1500); 
            }

            function exitCookingMode() {
                console.log('Saliendo del modo de cocina.');
                speechSynthesis.cancel();
                stopVoiceRecognition(); 
                // Limpiar todos los temporizadores al salir del modo de cocina
                activeTimers.forEach(timer => clearInterval(timer.intervalId));
                activeTimers = [];
                updateTimerDisplay(); // Limpiar la interfaz de temporizadores
                
                cookingModeView.classList.add('hidden');
                cookingModeView.classList.remove('flex');
                showToast('Modo de cocina finalizado.', 'info'); 
            }

            // Los event listeners de los botones ahora llaman a las funciones de acción directamente
            prevStepBtn.addEventListener('click', prevStepAction);
            nextStepBtn.addEventListener('click', nextStepAction);
            repeatStepBtn.addEventListener('click', repeatStepAction);
            exitCookingBtn.addEventListener('click', exitCookingMode);

            // Cargar la lista de la compra al inicio
            loadShoppingList();

            // --- FUNCIÓN PARA NOTIFICACIONES TOAST ---
            function showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.classList.add('toast-message', type);
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-20px)';
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
        }

        // Ejecuta la app cuando el DOM esté listo
        runRecipeApp();
    </script>
</body>
</html>
